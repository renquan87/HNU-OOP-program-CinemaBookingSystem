# 循环引用问题修复报告

## 问题描述

### 现象
- 管理员新增排片后，电影列表和普通用户的购票大厅无法正常加载
- 前端Vite开发服务器报错：`Parse Error: Expected LF after chunk data`
- 直接访问后端接口 `http://localhost:8081/api/movies` 返回无限递归的JSON数据

### 错误信息
```
19:49:56 [vite] http proxy error: /api/movies
Error: Parse Error: Expected LF after chunk data
    at Socket.socketOnData (node:_http_client:615:22)
```

## 问题分析

### 根本原因
Movie实体类和Show实体类之间存在**循环引用**，导致Jackson JSON序列化时产生无限递归：

```
Movie → showSchedule (Map<LocalDate, List<Show>>) 
       ↓
Show → movie (Movie字段)
       ↓
回到Movie，形成无限循环
```

### 技术细节
1. **Movie类**包含`Map<LocalDate, List<Show>> showSchedule`字段
2. **Show类**包含`Movie movie`字段
3. 当Spring Boot返回Movie对象时，Jackson尝试序列化整个对象图
4. 序列化过程：Movie → Show → Movie → Show → ... 无限递归
5. 生成无限长的JSON响应，破坏HTTP分块传输格式
6. Vite的Node.js HTTP客户端无法解析损坏的分块数据，抛出解析错误

### 为什么curl能看到但Vite代理报错？
- **PowerShell curl/Invoke-WebRequest**：不关心JSON格式合理性，持续输出服务器发送的任何字符串
- **Vite代理（Node.js）**：需要严格解析HTTP分块传输，当响应格式被破坏时立即失败

## 解决方案

### 修复步骤

#### 1. 在Movie类中添加JsonIgnore注解
```java
import com.fasterxml.jackson.annotation.JsonIgnore;

public class Movie implements java.io.Serializable {
    // ... 其他字段
    
    @JsonIgnore
    private Map<LocalDate, List<Show>> showSchedule;
    
    // ... 其他方法
}
```

#### 2. 创建MovieDTO类
```java
// 电影DTO，避免循环引用
class MovieDTO {
    public String id;
    public String title;
    public String releaseTime;
    public List<String> actors;
    public String director;
    public int duration;
    public double rating;
    public String description;
    public String genre;
    public String trailerUrl;
    public String coverUrl;
    public List<Comment> comments;
    public String detailedInfo;

    public MovieDTO(Movie movie) {
        this.id = movie.getId();
        this.title = movie.getTitle();
        this.releaseTime = movie.getReleaseTime().toString();
        this.actors = movie.getActors();
        this.director = movie.getDirector();
        this.duration = movie.getDuration();
        this.rating = movie.getRating();
        this.description = movie.getDescription();
        this.genre = movie.getGenre().getDescription();
        this.trailerUrl = movie.getTrailerUrl();
        this.coverUrl = movie.getCoverUrl();
        this.comments = movie.getComments();
        this.detailedInfo = movie.getDetailedInfo();
    }
}
```

#### 3. 修改Controller方法
```java
@GetMapping
public Map<String, Object> getAllMovies() {
    CinemaManager manager = CinemaManager.getInstance();
    List<Movie> movies = manager.getAllMovies();
    
    // 转换为DTO避免循环引用
    List<MovieDTO> movieDTOs = new ArrayList<>();
    for (Movie movie : movies) {
        movieDTOs.add(new MovieDTO(movie));
    }

    return buildResponse(200, "获取成功", movieDTOs);
}
```

## 修复效果

### 修复前
```json
{
  "code": 200,
  "data": [
    {
      "id": "MOV-001",
      "title": "阿凡达：水之道",
      "allShows": {
        "2026-01-01": [
          {
            "id": "SHOW-1766404938773",
            "movie": {
              "id": "MOV-001",
              "title": "阿凡达：水之道",
              "allShows": {
                "2026-01-01": [
                  {
                    "movie": {
                      // 无限递归...
                    }
                  }
                ]
              }
            }
          }
        ]
      }
    }
  ]
}
```

### 修复后
```json
{
  "code": 200,
  "data": [
    {
      "id": "MOV-001",
      "title": "阿凡达：水之道",
      "releaseTime": "2022-12-16",
      "actors": ["萨姆·沃辛顿", "佐伊·索尔达娜"],
      "director": "詹姆斯·卡梅隆",
      "duration": 192,
      "rating": 9.0,
      "description": "杰克·萨利与妻子奈蒂莉组建了家庭，他们的孩子也逐渐成长。",
      "genre": "动作片",
      "trailerUrl": "/media/trailers/1.mp4",
      "coverUrl": "/media/covers/1.jpg",
      "comments": [],
      "detailedInfo": "电影信息:\n  片名: 阿凡达：水之道\n  导演: 詹姆斯·卡梅隆\n  类型: 动作片\n  时长: 192分钟\n  评分: 9.0\n  上映日期: 2022-12-16\n  封面链接: /media/covers/1.jpg\n  预告片链接: /media/trailers/1.mp4\n  演员: 萨姆·沃辛顿, 佐伊·索尔达娜\n  简介: 杰克·萨利与妻子奈蒂莉组建了家庭，他们的孩子也逐渐成长。\n  评论数: 0\n"
    }
  ],
  "success": true,
  "message": "获取成功"
}
```

## 最佳实践建议

### 1. 使用DTO模式
- **永远不要直接返回JPA实体类**给前端
- 为每个API响应创建专门的DTO类
- DTO只包含前端需要的字段，避免敏感数据泄露

### 2. 处理循环引用的策略
- **@JsonIgnore**：简单直接，但可能丢失必要信息
- **@JsonManagedReference / @JsonBackReference**：适用于双向关联
- **DTO模式**：最推荐，完全控制序列化内容

### 3. 前后端协作
- 前端应该验证API响应的合理性
- 设置合理的响应大小限制
- 使用超时机制防止无限等待

### 4. 测试策略
- 对所有API接口进行响应大小测试
- 使用工具检查JSON格式的有效性
- 在开发环境中启用详细的错误日志

## 总结

这次问题的核心是**实体类循环引用导致的JSON序列化无限递归**。通过采用DTO模式，我们不仅解决了技术问题，还提高了代码的可维护性和安全性。这是企业级开发中的标准做法，值得在所有项目中推广使用。

**修复日期**：2025年12月22日  
**修复人员**：renquan87  
**影响范围**：电影列表接口、管理员排片功能、用户购票大厅