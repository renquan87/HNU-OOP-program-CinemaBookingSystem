
//File: CinemaApplication.java
package com.cinema;

import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;

@SpringBootApplication
public class CinemaApplication {
    public static void main(String[] args) {
        try {
            // 正常启动
            SpringApplication.run(CinemaApplication.class, args);
        } catch (Throwable e) {
            // ⚠️ 强行捕获所有错误并打印到控制台
            System.err.println("❌❌❌ 发生严重错误 ❌❌❌");
            e.printStackTrace(); // 这行代码会把被吞掉的错误吐出来
        }
    }
}

//File: DatabaseInitializer.java
package com.cinema;

import com.cinema.storage.SimpleDatabaseConnection;
import java.io.BufferedReader;
import java.io.InputStream;
import java.io.InputStreamReader;
import java.sql.Connection;
import java.sql.SQLException;
import java.sql.Statement;

public class DatabaseInitializer {
    public static void main(String[] args) {
        try {
            System.out.println("开始初始化数据库...");
            
            // 先尝试连接到MySQL服务器（不指定数据库）
            String url = "jdbc:mysql://localhost:3306?useUnicode=true&characterEncoding=utf8&useSSL=false&serverTimezone=UTC&allowPublicKeyRetrieval=true";
            try (java.sql.Connection conn = java.sql.DriverManager.getConnection(url, "root", "123421")) {
                System.out.println("MySQL服务器连接成功");
                
                // 创建数据库
                try (java.sql.Statement stmt = conn.createStatement()) {
                    stmt.execute("CREATE DATABASE IF NOT EXISTS cinema_db DEFAULT CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci");
                    System.out.println("数据库 cinema_db 创建成功");
                }
            } catch (SQLException e) {
                System.err.println("连接MySQL服务器失败: " + e.getMessage());
                System.err.println("请确保MySQL服务已启动，用户名密码正确");
                return;
            }
            
            // 测试数据库连接
            if (!SimpleDatabaseConnection.testConnection()) {
                System.err.println("无法连接到cinema_db数据库");
                return;
            }
            
            // 读取并执行SQL脚本
            executeSqlScript("schema.sql");
            
            System.out.println("数据库初始化完成！");
            
        } catch (Exception e) {
            System.err.println("数据库初始化失败: " + e.getMessage());
            e.printStackTrace();
        } finally {
            // 简单连接不需要关闭连接池
        }
    }
    
    private static void executeSqlScript(String scriptFile) {
        try (Connection conn = SimpleDatabaseConnection.getConnection();
             Statement stmt = conn.createStatement()) {
            
            // 先删除所有表（按依赖关系倒序）
            dropTablesIfExists(stmt);
            
            // 读取SQL脚本文件
            InputStream inputStream = DatabaseInitializer.class.getClassLoader().getResourceAsStream(scriptFile);
            if (inputStream == null) {
                throw new RuntimeException("无法找到SQL脚本文件: " + scriptFile);
            }
            
            BufferedReader reader = new BufferedReader(new InputStreamReader(inputStream));
            StringBuilder sqlBuilder = new StringBuilder();
            String line;
            
            while ((line = reader.readLine()) != null) {
                line = line.trim();
                if (line.isEmpty() || line.startsWith("--")) {
                    continue; // 跳过空行和注释
                }
                sqlBuilder.append(line).append("\n");
                
                // 如果遇到分号，执行SQL语句
                if (line.endsWith(";")) {
                    String sql = sqlBuilder.toString();
                    try {
                        stmt.execute(sql);
                        System.out.println("执行SQL: " + sql.substring(0, Math.min(50, sql.length())) + "...");
                    } catch (Exception e) {
                        System.err.println("SQL执行失败: " + e.getMessage());
                    }
                    sqlBuilder.setLength(0); // 清空StringBuilder
                }
            }
            
            reader.close();
            
        } catch (Exception e) {
            throw new RuntimeException("执行SQL脚本失败", e);
        }
    }
    
    private static void dropTablesIfExists(Statement stmt) throws SQLException {
        String[] tables = {
            "order_seats",
            "orders", 
            "users",
            "shows",
            "seats",
            "screening_rooms",
            "movies"
        };
        
        for (String table : tables) {
            try {
                stmt.execute("DROP TABLE IF EXISTS " + table);
                System.out.println("删除表: " + table);
            } catch (Exception e) {
                // 忽略删除失败的情况
            }
        }
    }
}

//File: Main.java
package com.cinema;

import com.cinema.ui.ConsoleUI;
import com.cinema.service.BookingService;
import com.cinema.service.CinemaManager;
import com.cinema.strategy.StandardPricing;
import java.io.Console;
import java.nio.charset.Charset;
import java.nio.charset.StandardCharsets;
import java.util.Locale;
import java.util.Scanner;

public class Main {
    public static void main(String[] args) {
        try {
            // 设置系统编码为UTF-8
            System.setProperty("file.encoding", "UTF-8");
            System.setProperty("sun.jnu.encoding", "UTF-8");
            
            // 设置默认字符集
            if (Charset.defaultCharset().name().equals("GBK")) {
                // 在Windows系统上尝试设置控制台代码页为UTF-8
                try {
                    new ProcessBuilder("cmd", "/c", "chcp 65001").inheritIO().start().waitFor();
                } catch (Exception e) {
                    // 忽略设置失败
                }
            }
            
            // Initialize BookingService first
            BookingService bookingService = BookingService.getInstance(new StandardPricing());
            
            // Then initialize CinemaManager
            CinemaManager cinemaManager = CinemaManager.getInstance();
            
            // Start the console UI
            ConsoleUI ui = new ConsoleUI();
            ui.start();
        } catch (Exception e) {
            System.err.println("系统启动失败: " + e.getMessage());
            e.printStackTrace();
        } finally {
            // 确保程序退出时关闭数据库连接
            try {
                CinemaManager cinemaManager = CinemaManager.getInstance();
                cinemaManager.shutdown();
            } catch (Exception e) {
                System.err.println("关闭数据库连接时出错: " + e.getMessage());
            }
        }
    }
}

//File: AuthController.java
package com.cinema.controller;

import com.cinema.model.User;
import com.cinema.service.CinemaManager;
import org.springframework.web.bind.annotation.*;

import java.util.HashMap;
import java.util.Map;

// 登录请求参数
class LoginRequest {
    public String username;
    public String password;
}

// 注册请求参数
class RegisterRequest {
    public String username; // 作为 User ID
    public String password;
    public String nickname; // 姓名
    public String phone;
    public String email;
}

@RestController
@RequestMapping("/api")
public class AuthController {

    // 1. 登录接口
    @PostMapping("/login")
    public Map<String, Object> login(@RequestBody LoginRequest request) {
        Map<String, Object> response = new HashMap<>();
        CinemaManager manager = CinemaManager.getInstance();
        User user = manager.getUser(request.username);

        // 核心修改：校验密码
        if (user != null && user.getPassword() != null && user.getPassword().equals(request.password)) {
            Map<String, Object> data = new HashMap<>();
            data.put("username", user.getName());
            data.put("accessToken", "fake-token-" + user.getId());
            data.put("roles", user.isAdmin() ? new String[]{"admin"} : new String[]{"common"});
            data.put("expires", "2030/01/01 00:00:00");

            response.put("success", true);
            response.put("code", 200);
            response.put("data", data);
            response.put("message", "登录成功");
        } else {
            response.put("success", false);
            response.put("code", 401);
            response.put("message", "账号或密码错误");
        }
        return response;
    }

    // 2. 注册接口
    @PostMapping("/register")
    public Map<String, Object> register(@RequestBody RegisterRequest request) {
        Map<String, Object> response = new HashMap<>();
        CinemaManager manager = CinemaManager.getInstance();

        // 检查用户是否已存在
        if (manager.getUser(request.username) != null) {
            response.put("success", false);
            response.put("code", 400);
            response.put("message", "用户ID已存在");
            return response;
        }

        // 创建新用户
        User newUser = new User(
                request.username,
                request.nickname,
                request.password,
                request.phone,
                request.email
        );

        manager.addUser(newUser);

        // 注册成功后直接返回部分信息
        Map<String, Object> data = new HashMap<>();
        data.put("username", request.username);
        data.put("name", request.nickname);

        response.put("success", true);
        response.put("code", 200);
        response.put("data", data);
        response.put("message", "注册成功，请登录");

        return response;
    }
}

//File: MovieController.java
package com.cinema.controller;

import com.cinema.model.Movie;
import com.cinema.model.MovieGenre; // 确保导入了你的枚举
import com.cinema.service.CinemaManager;
import org.springframework.web.bind.annotation.*;

import java.time.LocalDate;
import java.time.format.DateTimeFormatter;
import java.util.*;

// 接收前端添加电影参数的 DTO (Data Transfer Object)
class MovieRequest {
    public String title;
    public String director;
    public String actors; // 前端传逗号分隔的字符串，例如 "吴京,刘德华"
    public int duration;
    public double rating;
    public String description;
    public String genre;
    public String releaseTime; // 格式: "2023-01-01"
}

@RestController
@RequestMapping("/api/movies")
public class MovieController {

    // 1. 获取所有电影
    @GetMapping
    public Map<String, Object> getAllMovies() {
        CinemaManager manager = CinemaManager.getInstance();
        List<Movie> movies = manager.getAllMovies();

        return buildResponse(200, "获取成功", movies);
    }

    // 2. 添加电影
    @PostMapping
    public Map<String, Object> addMovie(@RequestBody MovieRequest req) {
        try {
            CinemaManager manager = CinemaManager.getInstance();

            // 生成唯一ID
            String id = "MOV-" + System.currentTimeMillis();

            // 处理演员列表 (逗号分隔)
            List<String> actorList = Arrays.asList(req.actors.split("[,，]")); // 支持中英文逗号

            // 处理日期
            LocalDate date = LocalDate.parse(req.releaseTime, DateTimeFormatter.ISO_LOCAL_DATE);

            Movie movie = new Movie(
                    id,
                    req.title,
                    date,
                    actorList,
                    req.director,
                    req.duration,
                    req.rating,
                    req.description,
                    req.genre
            );

            manager.addMovie(movie);
            return buildResponse(200, "添加成功", null);
        } catch (Exception e) {
            e.printStackTrace();
            return buildResponse(500, "添加失败: " + e.getMessage(), null);
        }
    }

    // 3. 删除电影
    @DeleteMapping("/{id}")
    public Map<String, Object> deleteMovie(@PathVariable String id) {
        CinemaManager manager = CinemaManager.getInstance();

        if (manager.getMovie(id) == null) {
            return buildResponse(404, "电影不存在", null);
        }

        manager.removeMovie(id);
        return buildResponse(200, "删除成功", null);
    }

    // 辅助方法：构建统一响应格式
    private Map<String, Object> buildResponse(int code, String msg, Object data) {
        Map<String, Object> response = new HashMap<>();
        response.put("success", code == 200);
        response.put("code", code);
        response.put("message", msg);
        response.put("data", data);
        return response;
    }
}

//File: ShowController.java
package com.cinema.controller;

import com.cinema.model.Show;
import com.cinema.service.CinemaManager;
import org.springframework.web.bind.annotation.*;

import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

@RestController
@RequestMapping("/api/shows")
public class ShowController {

    @GetMapping
    public Map<String, Object> getShows(@RequestParam(required = false) String movieId) {
        CinemaManager manager = CinemaManager.getInstance();
        List<Show> shows;

        // 如果前端传了 movieId，就只查这部电影的场次
        if (movieId != null && !movieId.isEmpty()) {
            shows = manager.getShowsByMovie(movieId);
        } else {
            // 否则查所有
            shows = manager.getAllShows();
        }

        // 构造简单的 DTO 返回给前端，避免嵌套过深
        List<Map<String, Object>> showList = new ArrayList<>();
        for (Show show : shows) {
            Map<String, Object> item = new HashMap<>();
            item.put("id", show.getId());
            item.put("movieTitle", show.getMovieTitle());
            item.put("roomName", show.getScreeningRoomName());
            item.put("startTime", show.getStartTime().toString());
            item.put("basePrice", show.getBasePrice());
            item.put("availableSeats", show.getAvailableSeatsCount());
            item.put("totalSeats", show.getTotalSeats());
            showList.add(item);
        }

        Map<String, Object> response = new HashMap<>();
        response.put("success", true);
        response.put("code", 200);
        response.put("data", showList);
        return response;
    }
}

//File: InvalidBookingException.java
package com.cinema.exception;

/**
 * 无效预订异常
 * 当预订请求包含无效信息时抛出
 */
public class InvalidBookingException extends Exception {
    private final String bookingDetails;

    public InvalidBookingException(String message) {
        super(message);
        this.bookingDetails = "";
    }

    public InvalidBookingException(String message, String bookingDetails) {
        super(message + " - 预订详情: " + bookingDetails);
        this.bookingDetails = bookingDetails;
    }

    public InvalidBookingException(String message, Throwable cause) {
        super(message, cause);
        this.bookingDetails = "";
    }

    public InvalidBookingException(String message, String bookingDetails, Throwable cause) {
        super(message + " - 预订详情: " + bookingDetails, cause);
        this.bookingDetails = bookingDetails;
    }

    public String getBookingDetails() {
        return bookingDetails;
    }
}

//File: PaymentFailedException.java
package com.cinema.exception;

/**
 * 支付失败异常
 * 当支付处理失败时抛出
 */
public class PaymentFailedException extends Exception {
    private final String orderId;
    private final double amount;
    private final String paymentMethod;

    public PaymentFailedException(String orderId, double amount) {
        super("支付失败 - 订单号: " + orderId + ", 金额: ¥" + amount);
        this.orderId = orderId;
        this.amount = amount;
        this.paymentMethod = "未知";
    }

    public PaymentFailedException(String orderId, double amount, String paymentMethod) {
        super("支付失败 - 订单号: " + orderId + ", 金额: ¥" + amount + ", 支付方式: " + paymentMethod);
        this.orderId = orderId;
        this.amount = amount;
        this.paymentMethod = paymentMethod;
    }

    public PaymentFailedException(String orderId, double amount, String paymentMethod, String reason) {
        super("支付失败 - " + reason + " (订单号: " + orderId + ", 金额: ¥" + amount + ", 支付方式: " + paymentMethod + ")");
        this.orderId = orderId;
        this.amount = amount;
        this.paymentMethod = paymentMethod;
    }

    public PaymentFailedException(String orderId, double amount, String paymentMethod, String reason, Throwable cause) {
        super("支付失败 - " + reason + " (订单号: " + orderId + ", 金额: ¥" + amount + ", 支付方式: " + paymentMethod + ")", cause);
        this.orderId = orderId;
        this.amount = amount;
        this.paymentMethod = paymentMethod;
    }

    public String getOrderId() {
        return orderId;
    }

    public double getAmount() {
        return amount;
    }

    public String getPaymentMethod() {
        return paymentMethod;
    }
}

//File: SeatNotAvailableException.java
package com.cinema.exception;

/**
 * 座位不可用异常
 * 当试图预订已被占用或不存在的座位时抛出
 */
public class SeatNotAvailableException extends Exception {
    private final String seatId;
    private final String reason;

    public SeatNotAvailableException(String seatId) {
        super("座位不可用: " + seatId);
        this.seatId = seatId;
        this.reason = "座位已被预订";
    }

    public SeatNotAvailableException(String seatId, String reason) {
        super("座位不可用: " + seatId + " - " + reason);
        this.seatId = seatId;
        this.reason = reason;
    }

    public SeatNotAvailableException(String seatId, String reason, Throwable cause) {
        super("座位不可用: " + seatId + " - " + reason, cause);
        this.seatId = seatId;
        this.reason = reason;
    }

    public String getSeatId() {
        return seatId;
    }

    public String getReason() {
        return reason;
    }
}

//File: DiscountSeat.java
package com.cinema.model;

public class DiscountSeat extends Seat implements java.io.Serializable {
    private static final long serialVersionUID = 1L;
    
    public DiscountSeat(int row, int col, double basePrice) {
        super(row, col, basePrice * 0.8); // 优惠座位价格为基准价格的80%
    }
    
    @Override
    public String toString() {
        return "DiscountSeat{" +
                "row=" + getRow() +
                ", col=" + getCol() +
                ", status=" + getStatus() +
                ", basePrice=" + getBasePrice() +
                '}';
    }
}

//File: Movie.java
package com.cinema.model;

import java.time.LocalDate;
import java.util.ArrayList;
import java.util.List;
import java.util.Map;
import java.util.concurrent.ConcurrentHashMap;

public class Movie implements java.io.Serializable {
    private static final long serialVersionUID = 1L;
    
    private String id;
    private String title;
    private LocalDate releaseTime;
    private List<String> actors;
    private String director;
    private int duration; // in minutes
    private double rating;
    private String description;
    private MovieGenre genre;
    private Map<LocalDate, List<Show>> showSchedule;

    public Movie(String id, String title, LocalDate releaseTime, List<String> actors, 
                 String director, int duration, double rating, String description, MovieGenre genre) {
        this.id = id;
        this.title = title;
        this.releaseTime = releaseTime;
        this.actors = new ArrayList<>(actors);
        this.director = director;
        this.duration = duration;
        this.rating = rating;
        this.description = description;
        this.genre = genre;
        this.showSchedule = new ConcurrentHashMap<>();
    }

    /**
     * 兼容性构造函数，支持String类型的genre参数
     */
    public Movie(String id, String title, LocalDate releaseTime, List<String> actors, 
                 String director, int duration, double rating, String description, String genre) {
        this(id, title, releaseTime, actors, director, duration, rating, description, 
             MovieGenre.fromDescription(genre));
    }

    public String getId() {
        return id;
    }

    public void setId(String id) {
        this.id = id;
    }

    public String getTitle() {
        return title;
    }

    public void setTitle(String title) {
        this.title = title;
    }

    public LocalDate getReleaseTime() {
        return releaseTime;
    }

    public void setReleaseTime(LocalDate releaseTime) {
        this.releaseTime = releaseTime;
    }

    public List<String> getActors() {
        return new ArrayList<>(actors);
    }

    public void setActors(List<String> actors) {
        this.actors = new ArrayList<>(actors);
    }

    public String getDirector() {
        return director;
    }

    public void setDirector(String director) {
        this.director = director;
    }

    public int getDuration() {
        return duration;
    }

    public void setDuration(int duration) {
        this.duration = duration;
    }

    public double getRating() {
        return rating;
    }

    public void setRating(double rating) {
        if (rating < 0 || rating > 10) {
            throw new IllegalArgumentException("评分必须在0-10之间");
        }
        this.rating = rating;
    }

    public String getDescription() {
        return description;
    }

    public void setDescription(String description) {
        this.description = description;
    }

    public MovieGenre getGenre() {
        return genre;
    }

    public void setGenre(MovieGenre genre) {
        this.genre = genre;
    }

    /**
     * 兼容性方法，支持String类型的genre参数
     */
    public void setGenre(String genre) {
        this.genre = MovieGenre.fromDescription(genre);
    }

    /**
     * 演员管理方法
     */
    public void addActor(String actor) {
        if (actor != null && !actor.trim().isEmpty() && !actors.contains(actor)) {
            actors.add(actor);
        }
    }

    public void removeActor(String actor) {
        actors.remove(actor);
    }

    

    public List<Show> getShowsByDate(LocalDate date) {
        return showSchedule.getOrDefault(date, new ArrayList<>());
    }

    public void addShow(LocalDate date, Show show) {
        showSchedule.computeIfAbsent(date, k -> new ArrayList<>()).add(show);
    }

    public void removeShow(LocalDate date, Show show) {
        List<Show> shows = showSchedule.get(date);
        if (shows != null) {
            shows.remove(show);
            if (shows.isEmpty()) {
                showSchedule.remove(date);
            }
        }
    }

    public Map<LocalDate, List<Show>> getAllShows() {
        return new ConcurrentHashMap<>(showSchedule);
    }

    @Override
    public String toString() {
        return String.format("Movie{id='%s', title='%s', director='%s', duration=%d分钟, rating=%.1f, genre=%s}",
                id, title, director, duration, rating, genre.getDescription());
    }

    /**
     * 获取电影的详细信息字符串
     */
    public String getDetailedInfo() {
        StringBuilder info = new StringBuilder();
        info.append("电影信息:\n");
        info.append(String.format("  片名: %s\n", title));
        info.append(String.format("  导演: %s\n", director));
        info.append(String.format("  类型: %s\n", genre.getDescription()));
        info.append(String.format("  时长: %d分钟\n", duration));
        info.append(String.format("  评分: %.1f\n", rating));
        info.append(String.format("  上映日期: %s\n", releaseTime));
        info.append(String.format("  演员: %s\n", String.join(", ", actors)));
        info.append(String.format("  简介: %s\n", description));
        return info.toString();
    }
}

//File: MovieGenre.java
package com.cinema.model;

/**
 * 电影类型枚举
 * 提供类型安全的电影类型定义
 */
public enum MovieGenre {
    ACTION("动作片"),
    COMEDY("喜剧片"),
    DRAMA("剧情片"),
    HORROR("恐怖片"),
    ROMANCE("爱情片"),
    SCIENCE_FICTION("科幻片"),
    ANIMATION("动画片"),
    THRILLER("惊悚片"),
    DOCUMENTARY("纪录片"),
    FANTASY("奇幻片"),
    MYSTERY("悬疑片"),
    ADVENTURE("冒险片"),
    CRIME("犯罪片"),
    FAMILY("家庭片"),
    MUSICAL("音乐片"),
    WAR("战争片"),
    WESTERN("西部片"),
    BIOGRAPHY("传记片"),
    SPORT("体育片");

    private final String description;

    MovieGenre(String description) {
        this.description = description;
    }

    public String getDescription() {
        return description;
    }

    /**
     * 根据字符串描述获取对应的枚举值
     * @param description 描述文本
     * @return 对应的枚举值，如果找不到则返回DRAMA
     */
    public static MovieGenre fromDescription(String description) {
        if (description == null) {
            return DRAMA; // 默认值
        }
        
        for (MovieGenre genre : values()) {
            if (genre.description.equals(description) || genre.name().equalsIgnoreCase(description)) {
                return genre;
            }
        }
        return DRAMA; // 默认值
    }

    @Override
    public String toString() {
        return description;
    }
}

//File: Order.java
package com.cinema.model;

import java.time.LocalDateTime;
import java.util.List;

public class Order implements java.io.Serializable {
    private static final long serialVersionUID = 1L;
    private String orderId;
    private Show show;
    private List<Seat> seats;
    private LocalDateTime createTime;
    private LocalDateTime lockTime; // 预订锁定时间
    private OrderStatus status;
    private double totalAmount;
    private User user;

    public enum OrderStatus {
        PENDING,
        RESERVED,
        PAID,
        CANCELLED,
        REFUNDED,
        EXPIRED
    }

    public Order(String orderId, Show show, List<Seat> seats, LocalDateTime createTime, OrderStatus status) {
        this.orderId = orderId;
        this.show = show;
        this.seats = seats;
        this.createTime = createTime;
        this.lockTime = null; // 初始为空，预订时设置
        this.status = status;
        this.totalAmount = calculateTotal();
    }

    public String getOrderId() {
        return orderId;
    }

    public void setOrderId(String orderId) {
        this.orderId = orderId;
    }

    public Show getShow() {
        return show;
    }

    public void setShow(Show show) {
        this.show = show;
    }

    public List<Seat> getSeats() {
        return seats;
    }

    public void setSeats(List<Seat> seats) {
        this.seats = seats;
        this.totalAmount = calculateTotal();
    }

    public LocalDateTime getCreateTime() {
        return createTime;
    }

    public void setCreateTime(LocalDateTime createTime) {
        this.createTime = createTime;
    }

    public OrderStatus getStatus() {
        return status;
    }

    public void setStatus(OrderStatus status) {
        this.status = status;
    }

    public double getTotalAmount() {
        return totalAmount;
    }

    public User getUser() {
        return user;
    }

    public void setUser(User user) {
        this.user = user;
    }

    public double calculateTotal() {
        double total = 0.0;
        for (Seat seat : seats) {
            total += seat.getBasePrice();
        }
        this.totalAmount = total;
        return total;
    }

    public boolean processPayment() {
        if (status == OrderStatus.PENDING) {
            status = OrderStatus.PAID;
            return true;
        }
        return false;
    }

    public boolean cancel() {
        if (status == OrderStatus.PENDING || status == OrderStatus.PAID) {
            status = OrderStatus.CANCELLED;
            return true;
        }
        return false;
    }

    public boolean refund() {
        if (status == OrderStatus.PAID) {
            status = OrderStatus.REFUNDED;
            return true;
        }
        return false;
    }

    public int getSeatCount() {
        return seats.size();
    }

    public String getSeatIds() {
        StringBuilder sb = new StringBuilder();
        for (int i = 0; i < seats.size(); i++) {
            if (i > 0) sb.append(", ");
            sb.append(seats.get(i).getSeatId());
        }
        return sb.toString();
    }
    
    public LocalDateTime getLockTime() {
        return lockTime;
    }
    
    public void setLockTime(LocalDateTime lockTime) {
        this.lockTime = lockTime;
    }
    
    // 检查预订是否过期（15分钟）
    public boolean isExpired() {
        if (lockTime == null || status != OrderStatus.RESERVED) {
            return false;
        }
        return LocalDateTime.now().isAfter(lockTime.plusMinutes(15));
    }
    
    // 获取剩余锁定时间（分钟）
    public long getRemainingLockMinutes() {
        if (lockTime == null || status != OrderStatus.RESERVED) {
            return 0;
        }
        LocalDateTime expireTime = lockTime.plusMinutes(15);
        if (LocalDateTime.now().isAfter(expireTime)) {
            return 0;
        }
        return java.time.Duration.between(LocalDateTime.now(), expireTime).toMinutes();
    }

    @Override
    public String toString() {
        return "Order{" +
                "orderId='" + orderId + '\'' +
                ", movie='" + show.getMovie().getTitle() + '\'' +
                ", showTime=" + show.getStartTime() +
                ", seats=" + getSeatIds() +
                ", createTime=" + createTime +
                ", status=" + status +
                ", totalAmount=" + totalAmount +
                '}';
    }
}

//File: RegularSeat.java
package com.cinema.model;

public class RegularSeat extends Seat implements java.io.Serializable {
    private static final double DEFAULT_BASE_PRICE = 50.0; // 统一基准价格

    public RegularSeat(int row, int col) {
        super(row, col, DEFAULT_BASE_PRICE);
    }

    public RegularSeat(int row, int col, double basePrice) {
        super(row, col, basePrice);
    }

    @Override
    public String toString() {
        return "RegularSeat{" +
                "row=" + row +
                ", col=" + col +
                ", status=" + status +
                ", basePrice=" + basePrice +
                '}';
    }
}

//File: ScreeningRoom.java
package com.cinema.model;

import java.util.ArrayList;
import java.util.List;

public class ScreeningRoom implements java.io.Serializable {
    private static final long serialVersionUID = -4576372446438300048L;
    private String id;
    private String name;
    private String layout;
    private Seat[][] seatLayout;
    private int totalRows;
    private int totalCols;

    public ScreeningRoom(String id, String name, int totalRows, int totalCols) {
        this.id = id;
        this.name = name;
        this.totalRows = totalRows;
        this.totalCols = totalCols;
        this.seatLayout = new Seat[totalRows][totalCols];
        this.layout = totalRows + "x" + totalCols;
        initializeSeats();
    }

    private void initializeSeats() {
        for (int row = 0; row < totalRows; row++) {
            for (int col = 0; col < totalCols; col++) {
                // 第一排为优惠座位，中间几排为VIP座位
                if (row == 0) {
                    // 第一排为优惠座位，使用默认基准价格50元
                    seatLayout[row][col] = new DiscountSeat(row + 1, col + 1, 50.0);
                } else if (row >= totalRows / 2 - 1 && row <= totalRows / 2 + 1) {
                    // 中间3排为VIP座位（或中间2排，如果总行数较少）
                    seatLayout[row][col] = new VIPSeat(row + 1, col + 1);
                } else {
                    // 其他为普通座位，使用默认基准价格
                    seatLayout[row][col] = new RegularSeat(row + 1, col + 1);
                }
            }
        }
    }

    public String getId() {
        return id;
    }

    public void setId(String id) {
        this.id = id;
    }

    public String getName() {
        return name;
    }

    public void setName(String name) {
        this.name = name;
    }

    public String getLayout() {
        return layout;
    }

    public void setLayout(String layout) {
        this.layout = layout;
    }

    public Seat[][] getSeatLayout() {
        return seatLayout;
    }

    public void setSeatLayout(Seat[][] seatLayout) {
        this.seatLayout = seatLayout;
    }

    public int getTotalRows() {
        return totalRows;
    }

    public int getTotalCols() {
        return totalCols;
    }

    public List<Seat> getAvailableSeats() {
        List<Seat> availableSeats = new ArrayList<>();
        for (int row = 0; row < totalRows; row++) {
            for (int col = 0; col < totalCols; col++) {
                Seat seat = seatLayout[row][col];
                if (seat.isAvailable()) {
                    availableSeats.add(seat);
                }
            }
        }
        return availableSeats;
    }

    public Seat getSeat(int row, int col) {
        if (row >= 1 && row <= totalRows && col >= 1 && col <= totalCols) {
            return seatLayout[row - 1][col - 1];
        }
        return null;
    }

    public int getTotalSeats() {
        return totalRows * totalCols;
    }

    public int getAvailableSeatsCount() {
        return getAvailableSeats().size();
    }

    public int getVipSeatsCount() {
        int count = 0;
        for (int row = 0; row < totalRows && row < 3; row++) {
            for (int col = 0; col < totalCols; col++) {
                count++;
            }
        }
        return count;
    }

    public int getRegularSeatsCount() {
        return getTotalSeats() - getVipSeatsCount() - getDiscountSeatsCount();
    }

    public int getDiscountSeatsCount() {
        // 第一排为优惠座位
        return totalCols;
    }

    public int getRows() {
        return totalRows;
    }

    public int getColumns() {
        return totalCols;
    }

    @Override
    public String toString() {
        return "ScreeningRoom{" +
                "id='" + id + '\'' +
                ", name='" + name + '\'' +
                ", layout='" + layout + '\'' +
                ", totalSeats=" + getTotalSeats() +
                ", availableSeats=" + getAvailableSeatsCount() +
                '}';
    }
}

//File: Seat.java
package com.cinema.model;

public abstract class Seat implements java.io.Serializable {
    private static final long serialVersionUID = 1L;
    protected int row;
    protected int col;
    protected SeatStatus status;
    protected double basePrice;

    public enum SeatStatus {
        AVAILABLE,
        LOCKED,
        SOLD
    }

    public Seat(int row, int col, double basePrice) {
        this.row = row;
        this.col = col;
        this.basePrice = basePrice;
        this.status = SeatStatus.AVAILABLE;
    }

    public int getRow() {
        return row;
    }

    public void setRow(int row) {
        this.row = row;
    }

    public int getCol() {
        return col;
    }

    public void setCol(int col) {
        this.col = col;
    }

    public SeatStatus getStatus() {
        return status;
    }

    public void setStatus(SeatStatus status) {
        this.status = status;
    }

    public double getBasePrice() {
        return basePrice;
    }

    public void setBasePrice(double basePrice) {
        this.basePrice = basePrice;
    }

    public boolean isAvailable() {
        return status == SeatStatus.AVAILABLE;
    }

    public boolean isLocked() {
        return status == SeatStatus.LOCKED;
    }

    public void lock() {
        this.status = SeatStatus.LOCKED;
    }

    public void unlock() {
        this.status = SeatStatus.AVAILABLE;
    }

    public void sell() {
        this.status = SeatStatus.SOLD;
    }
    
    public void book() {
        this.status = SeatStatus.SOLD;
    }

    public String getSeatId() {
        return row + "-" + col;
    }

    @Override
    public String toString() {
        return "Seat{" +
                "row=" + row +
                ", col=" + col +
                ", status=" + status +
                ", basePrice=" + basePrice +
                '}';
    }

    @Override
    public boolean equals(Object obj) {
        if (this == obj) return true;
        if (obj == null || getClass() != obj.getClass()) return false;
        Seat seat = (Seat) obj;
        return row == seat.row && col == seat.col;
    }

    @Override
    public int hashCode() {
        return 31 * row + col;
    }
}

//File: Show.java
package com.cinema.model;

import java.time.LocalDateTime;
import java.util.ArrayList;
import java.util.List;

public class Show implements java.io.Serializable {
    private static final long serialVersionUID = 1L;
    private String id;
    private Movie movie;
    private ScreeningRoom screeningRoom;
    private LocalDateTime startTime;
    private double basePrice;
    private double discountPrice; // 优惠座位价格
    private double vipPrice; // VIP座位价格
    private List<Seat> seats;

    public Show(String id, Movie movie, ScreeningRoom screeningRoom, LocalDateTime startTime, double basePrice) {
        this.id = id;
        this.movie = movie;
        this.screeningRoom = screeningRoom;
        this.startTime = startTime;
        this.basePrice = basePrice;
        this.discountPrice = basePrice * 0.8; // 默认优惠价格为基准价格的80%
        this.vipPrice = basePrice + 10.0; // 默认VIP价格为基准价格+10元
        this.seats = new ArrayList<>();
        initializeSeats();
    }
    
    // 新的构造函数，允许设置三种价格
    public Show(String id, Movie movie, ScreeningRoom screeningRoom, LocalDateTime startTime, 
                double basePrice, double discountPrice, double vipPrice) {
        this.id = id;
        this.movie = movie;
        this.screeningRoom = screeningRoom;
        this.startTime = startTime;
        this.basePrice = basePrice;
        this.discountPrice = discountPrice;
        this.vipPrice = vipPrice;
        this.seats = new ArrayList<>();
        initializeSeats();
    }
    
    // 用于数据库加载的构造函数，不初始化座位
    public Show(String id, LocalDateTime startTime, double basePrice) {
        this.id = id;
        this.movie = null;
        this.screeningRoom = null;
        this.startTime = startTime;
        this.basePrice = basePrice;
        this.discountPrice = basePrice * 0.8;
        this.vipPrice = basePrice + 10.0;
        this.seats = new ArrayList<>();
        // 不调用initializeSeats()
    }

    private void initializeSeats() {
        Seat[][] roomSeats = screeningRoom.getSeatLayout();
        for (int row = 0; row < roomSeats.length; row++) {
            for (int col = 0; col < roomSeats[row].length; col++) {
                // 直接使用放映厅中的座位实例，保持引用关系
                seats.add(roomSeats[row][col]);
            }
        }
    }

    public String getId() {
        return id;
    }

    public void setId(String id) {
        this.id = id;
    }

    public Movie getMovie() {
        return movie;
    }

    public void setMovie(Movie movie) {
        this.movie = movie;
    }
    
    // 安全获取电影标题，避免空指针
    public String getMovieTitle() {
        return movie != null ? movie.getTitle() : "未知电影";
    }
    
    // 安全获取电影ID，避免空指针
    public String getMovieId() {
        return movie != null ? movie.getId() : "UNKNOWN";
    }
    
    // 安全获取放映厅名称，避免空指针
    public String getScreeningRoomName() {
        return screeningRoom != null ? screeningRoom.getName() : "未知放映厅";
    }
    
    // 安全获取放映厅ID，避免空指针
    public String getScreeningRoomId() {
        return screeningRoom != null ? screeningRoom.getId() : "UNKNOWN";
    }

    public ScreeningRoom getScreeningRoom() {
        return screeningRoom;
    }

    public void setScreeningRoom(ScreeningRoom screeningRoom) {
        this.screeningRoom = screeningRoom;
    }

    public LocalDateTime getStartTime() {
        return startTime;
    }

    public void setStartTime(LocalDateTime startTime) {
        this.startTime = startTime;
    }

    public double getBasePrice() {
        return basePrice;
    }

    public void setBasePrice(double basePrice) {
        this.basePrice = basePrice;
        updateSeatPrices();
    }
    
    public double getDiscountPrice() {
        return discountPrice;
    }
    
    public void setDiscountPrice(double discountPrice) {
        this.discountPrice = discountPrice;
        updateSeatPrices();
    }
    
    public double getVipPrice() {
        return vipPrice;
    }
    
    public void setVipPrice(double vipPrice) {
        this.vipPrice = vipPrice;
        updateSeatPrices();
    }

    private void updateSeatPrices() {
        for (Seat seat : seats) {
            if (seat instanceof VIPSeat) {
                seat.setBasePrice(vipPrice);
            } else if (seat instanceof DiscountSeat) {
                seat.setBasePrice(discountPrice);
            } else {
                seat.setBasePrice(basePrice);
            }
        }
    }

    public List<Seat> getSeats() {
        return new ArrayList<>(seats);
    }

    public List<Seat> getAvailableSeats() {
        List<Seat> availableSeats = new ArrayList<>();
        for (Seat seat : seats) {
            if (seat.isAvailable()) {
                availableSeats.add(seat);
            }
        }
        return availableSeats;
    }

    public Seat getSeat(int row, int col) {
        for (Seat seat : seats) {
            if (seat.getRow() == row && seat.getCol() == col) {
                return seat;
            }
        }
        return null;
    }
    
    public Seat getSeat(String seatId) {
        String[] parts = seatId.split("-");
        if (parts.length != 2) {
            return null;
        }
        try {
            int row = Integer.parseInt(parts[0]);
            int col = Integer.parseInt(parts[1]);
            return getSeat(row, col);
        } catch (NumberFormatException e) {
            return null;
        }
    }

    public boolean hostSell(List<Seat> selectedSeats) {
        for (Seat seat : selectedSeats) {
            if (!seat.isAvailable()) {
                return false;
            }
        }
        
        for (Seat seat : selectedSeats) {
            seat.sell();
        }
        
        return true;
    }

    public int getTotalSeats() {
        return seats.size();
    }

    public int getAvailableSeatsCount() {
        return getAvailableSeats().size();
    }

    public int getSoldSeatsCount() {
        int count = 0;
        for (Seat seat : seats) {
            if (seat.getStatus() == Seat.SeatStatus.SOLD) {
                count++;
            }
        }
        return count;
    }

    @Override
    public String toString() {
        return "Show{" +
                "id='" + id + '\'' +
                ", movie=" + movie.getTitle() +
                ", screeningRoom=" + screeningRoom.getName() +
                ", startTime=" + startTime +
                ", basePrice=" + basePrice +
                ", availableSeats=" + getAvailableSeatsCount() + "/" + getTotalSeats() +
                '}';
    }
}

//File: User.java
package com.cinema.model;

import java.time.LocalDateTime;
import java.util.ArrayList;
import java.util.List;

public class User implements java.io.Serializable {
    private static final long serialVersionUID = 1L;
    private String id;
    private String name;
    private String password;
    private String phone;
    private String email;
    private List<Order> orders;
    private UserRole role;

    public enum UserRole {
        CUSTOMER,
        ADMIN
    }

    // [修改] 全参构造函数，增加 password
    public User(String id, String name, String password, String phone, String email, UserRole role) {
        this.id = id;
        this.name = name;
        this.password = password; // [新增]
        this.phone = phone;
        this.email = email;
        this.role = role;
        this.orders = new ArrayList<>();
    }

    // [修改] 简化构造函数
    public User(String id, String name, String password, String phone, String email) {
        this(id, name, password, phone, email, UserRole.CUSTOMER);
    }

    public String getId() {
        return id;
    }

    public String getPassword() {
        return password;
    }

    public void setPassword(String password) {
        this.password = password;
    }

    public void setId(String id) {
        this.id = id;
    }

    public String getName() {
        return name;
    }

    public void setName(String name) {
        this.name = name;
    }

    public String getPhone() {
        return phone;
    }

    public void setPhone(String phone) {
        this.phone = phone;
    }

    public String getEmail() {
        return email;
    }

    public void setEmail(String email) {
        this.email = email;
    }

    public UserRole getRole() {
        return role;
    }

    public void setRole(UserRole role) {
        this.role = role;
    }

    public List<Order> getOrders() {
        return new ArrayList<>(orders);
    }

    public void addOrder(Order order) {
        this.orders.add(order);
    }

    public void removeOrder(Order order) {
        this.orders.remove(order);
    }

    public List<Show> searchShows(String movieTitle, LocalDateTime date) {
        List<Show> matchingShows = new ArrayList<>();
        for (Order order : orders) {
            Show show = order.getShow();
            if (show.getMovie().getTitle().contains(movieTitle) &&
                show.getStartTime().toLocalDate().equals(date.toLocalDate())) {
                matchingShows.add(show);
            }
        }
        return matchingShows;
    }

    public Order createOrder(Show show, List<Seat> seats) {
        Order order = new Order(
            "ORD-" + System.currentTimeMillis(),
            show,
            seats,
            LocalDateTime.now(),
            Order.OrderStatus.PENDING
        );
        addOrder(order);
        return order;
    }

    public boolean isAdmin() {
        return role == UserRole.ADMIN;
    }

    public boolean isCustomer() {
        return role == UserRole.CUSTOMER;
    }

    @Override
    public String toString() {
        return "User{" +
                "id='" + id + '\'' +
                ", name='" + name + '\'' +
                ", phone='" + phone + '\'' +
                ", email='" + email + '\'' +
                ", role=" + role +
                ", orderCount=" + orders.size() +
                '}';
    }
}

//File: VIPSeat.java
package com.cinema.model;

public class VIPSeat extends Seat implements java.io.Serializable {
    private static final double PRICE_PREMIUM = 10.0; // VIP座位比普通座位贵10元

    public VIPSeat(int row, int col) {
        super(row, col, 50.0 + PRICE_PREMIUM); // 默认基准价格50元 + 10元
    }

    public VIPSeat(int row, int col, double basePrice) {
        super(row, col, basePrice + PRICE_PREMIUM);
    }

    @Override
    public String toString() {
        return "VIPSeat{" +
                "row=" + row +
                ", col=" + col +
                ", status=" + status +
                ", basePrice=" + basePrice +
                '}';
    }
}

//File: BookingService.java
package com.cinema.service;

import com.cinema.model.*;
import com.cinema.strategy.PricingStrategy;
import com.cinema.storage.SimpleDataStorage;
import com.cinema.exception.*;

import java.util.List;
import java.util.ArrayList;
import java.time.LocalDateTime;
import java.util.concurrent.ConcurrentHashMap;
import java.util.concurrent.ConcurrentMap;

public class BookingService {
    private static BookingService instance;
    private final ConcurrentMap<String, Order> orders;
    private final PricingStrategy pricingStrategy;
    private final SimpleDataStorage dataStorage;

    private BookingService(PricingStrategy pricingStrategy) {
        this.dataStorage = new SimpleDataStorage();
        this.orders = new ConcurrentHashMap<>();
        this.pricingStrategy = pricingStrategy;
        loadOrders();
        rebuildUserOrderRelations();
    }

    public static synchronized BookingService getInstance(PricingStrategy pricingStrategy) {
        if (instance == null) {
            instance = new BookingService(pricingStrategy);
        }
        return instance;
    }

    public static BookingService getInstance() {
        if (instance == null) {
            throw new IllegalStateException("BookingService not initialized. Call getInstance(PricingStrategy) first.");
        }
        return instance;
    }

    public Order createOrder(User user, Show show, List<String> seatIds) throws InvalidBookingException, SeatNotAvailableException {
        if (show == null) {
            throw new InvalidBookingException("场次不能为空");
        }

        if (user == null) {
            throw new InvalidBookingException("用户不能为空");
        }

        if (seatIds == null || seatIds.isEmpty()) {
            throw new InvalidBookingException("座位列表不能为空");
        }

        List<Seat> selectedSeats = new java.util.ArrayList<>();
        StringBuilder bookingDetails = new StringBuilder();
        bookingDetails.append("场次: ").append(show.getMovie().getTitle());
        bookingDetails.append(", 座位: ");

        for (String seatId : seatIds) {
            String[] parts = seatId.split("-");
            if (parts.length != 2) {
                throw new InvalidBookingException("座位ID格式无效: " + seatId, 
                    "期望格式: 行-列 (例如: 1-1)");
            }

            try {
                int row = Integer.parseInt(parts[0]);
                int col = Integer.parseInt(parts[1]);
                Seat seat = show.getSeat(row, col);
                
                if (seat == null) {
                    throw new SeatNotAvailableException(seatId, "座位不存在");
                }
                
                if (!seat.isAvailable()) {
                    throw new SeatNotAvailableException(seatId, "座位已被预订");
                }
                
                selectedSeats.add(seat);
                bookingDetails.append(seatId).append(" ");
            } catch (NumberFormatException e) {
                throw new InvalidBookingException("座位ID格式无效: " + seatId, 
                    "行和列必须是数字", e);
            }
        }

        if (selectedSeats.isEmpty()) {
            throw new InvalidBookingException("没有选择有效的座位", bookingDetails.toString());
        }

        // Lock seats temporarily
        for (Seat seat : selectedSeats) {
            seat.lock();
        }

        Order order = new Order(
            "ORD-" + System.currentTimeMillis(),
            show,
            selectedSeats,
            java.time.LocalDateTime.now(),
            Order.OrderStatus.PENDING
        );

        orders.put(order.getOrderId(), order);
        order.setUser(user);
        user.addOrder(order);
        saveOrder(order);

        return order;
    }

    public void processPayment(Order order) throws PaymentFailedException {
        if (order == null) {
            throw new PaymentFailedException("", 0.0, "未知", "订单不能为空");
        }

        if (!orders.containsKey(order.getOrderId())) {
            throw new PaymentFailedException(order.getOrderId(), order.getTotalAmount(), "未知", "订单不存在");
        }

        if (order.getStatus() != Order.OrderStatus.PENDING) {
            throw new PaymentFailedException(order.getOrderId(), order.getTotalAmount(), "未知", 
                "订单状态不是待支付状态，无法支付");
        }

        // Process payment logic would go here
        boolean paymentSuccessful = true; // Simulate successful payment
        String paymentMethod = "支付宝"; // Simulate payment method

        if (paymentSuccessful) {
            order.processPayment();
            
            // Mark seats as sold
            for (Seat seat : order.getSeats()) {
                seat.sell();
            }
            
            saveOrder(order);
        } else {
            // Unlock seats if payment fails
            for (Seat seat : order.getSeats()) {
                seat.unlock();
            }
            throw new PaymentFailedException(order.getOrderId(), order.getTotalAmount(), paymentMethod, 
                "支付处理失败，请检查支付信息");
        }
    }

    public void cancelOrder(Order order) throws InvalidBookingException {
        if (order == null) {
            throw new InvalidBookingException("订单不能为空");
        }

        if (!orders.containsKey(order.getOrderId())) {
            throw new InvalidBookingException("订单不存在", "订单号: " + order.getOrderId());
        }

        if (order.getStatus() == Order.OrderStatus.PAID) {
            // Refund logic would go here
            boolean refundSuccessful = true; // Simulate successful refund
            
            if (refundSuccessful) {
                order.refund();
                // Unlock seats
                for (Seat seat : order.getSeats()) {
                    seat.unlock();
                }
                saveOrder(order);
            } else {
                throw new InvalidBookingException("退款失败", "订单号: " + order.getOrderId());
            }
        } else if (order.getStatus() == Order.OrderStatus.PENDING) {
            order.cancel();
            // Unlock seats
            for (Seat seat : order.getSeats()) {
                seat.unlock();
            }
            saveOrder(order);
        } else if (order.getStatus() == Order.OrderStatus.CANCELLED) {
            throw new InvalidBookingException("订单已经取消", "订单号: " + order.getOrderId());
        } else {
            throw new InvalidBookingException("无法取消此状态的订单", 
                "订单号: " + order.getOrderId() + ", 状态: " + order.getStatus());
        }
    }

    public Order getOrder(String orderId) {
        return orders.get(orderId);
    }

    public List<Order> getAllOrders() {
        return new java.util.ArrayList<>(orders.values());
    }

    public void updateOrder(Order order) {
        if (order != null && orders.containsKey(order.getOrderId())) {
            orders.put(order.getOrderId(), order);
            saveOrder(order);
        }
    }

    public double calculateSeatPrice(Show show, Seat seat) {
        return pricingStrategy.calculatePrice(show, seat);
    }

    public PricingStrategy getPricingStrategy() {
        return pricingStrategy;
    }
    
    public void setPricingStrategy(PricingStrategy newPricingStrategy) {
        // 由于是单例模式，我们需要通过反射来修改pricingStrategy字段
        try {
            java.lang.reflect.Field field = BookingService.class.getDeclaredField("pricingStrategy");
            field.setAccessible(true);
            field.set(instance, newPricingStrategy);
            field.setAccessible(false);
        } catch (Exception e) {
            throw new RuntimeException("无法更改定价策略: " + e.getMessage());
        }
    }
    
    private void loadOrders() {
        orders.putAll(dataStorage.loadOrders());
    }
    
    private void saveOrder(Order order) {
        dataStorage.saveOrders(orders);
    }
    
    public void saveOrders() {
        dataStorage.saveOrders(orders);
    }
    
    private void rebuildUserOrderRelations() {
        CinemaManager cinemaManager = CinemaManager.getInstance();
        for (Order order : orders.values()) {
            if (order.getUser() != null) {
                User user = cinemaManager.getUser(order.getUser().getId());
                if (user != null) {
                    order.setUser(user);
                    // 检查用户是否已经有这个订单，避免重复添加
                    if (!user.getOrders().contains(order)) {
                        user.addOrder(order);
                    }
                }
            }
        }
    }
    
    // 预订座位（锁定15分钟）
    public Order reserveOrder(User user, Show show, List<String> seatIds) 
            throws InvalidBookingException, SeatNotAvailableException {
        if (show == null) {
            throw new InvalidBookingException("场次不能为空");
        }
        
        if (user == null) {
            throw new InvalidBookingException("用户不能为空");
        }
        
        if (seatIds == null || seatIds.isEmpty()) {
            throw new InvalidBookingException("座位列表不能为空");
        }
        
        // 检查座位可用性并锁定
        List<Seat> selectedSeats = new ArrayList<>();
        for (String seatId : seatIds) {
            Seat seat = show.getSeat(seatId);
            if (seat == null) {
                throw new InvalidBookingException("座位不存在: " + seatId);
            }
            
            if (!seat.isAvailable()) {
                throw new SeatNotAvailableException("座位不可用: " + seatId, "座位已被预订或售出");
            }
            
            // 锁定座位
            seat.lock();
            selectedSeats.add(seat);
        }
        
        // 创建预订订单
        String orderId = "ORDER-" + System.currentTimeMillis();
        Order order = new Order(orderId, show, selectedSeats, LocalDateTime.now(), Order.OrderStatus.RESERVED);
        order.setLockTime(LocalDateTime.now());
        order.setUser(user);
        
        // 添加到订单列表
        orders.put(orderId, order);
        user.addOrder(order);
        
        // 锁定座位
        for (Seat seat : selectedSeats) {
            seat.lock();
        }
        
        saveOrders();
        return order;
    }
    
    // 检查并处理过期的预订
    public void checkExpiredOrders() {
        List<Order> expiredOrders = new ArrayList<>();
        
        for (Order order : orders.values()) {
            if (order.isExpired()) {
                expiredOrders.add(order);
            }
        }
        
        for (Order order : expiredOrders) {
            // 释放座位
            for (Seat seat : order.getSeats()) {
                seat.unlock();
            }
            
            // 更新订单状态
            order.setStatus(Order.OrderStatus.EXPIRED);
            
            // 从用户订单列表中移除
            if (order.getUser() != null) {
                order.getUser().removeOrder(order);
            }
            
            // 从订单列表中移除
            orders.remove(order.getOrderId());
        }
        
        if (!expiredOrders.isEmpty()) {
            saveOrders();
        }
    }
    
    // 支付预订订单
    public void processReservedOrderPayment(Order order) throws PaymentFailedException, InvalidBookingException {
        if (order == null) {
            throw new InvalidBookingException("订单不存在");
        }
        
        if (order.getStatus() != Order.OrderStatus.RESERVED) {
            throw new InvalidBookingException("订单状态不是预订状态");
        }
        
        if (order.isExpired()) {
            throw new InvalidBookingException("预订已过期");
        }
        
        // 更新订单状态为已支付
        order.setStatus(Order.OrderStatus.PAID);
        
        // 确认座位（将锁定状态改为已售出）
        for (Seat seat : order.getSeats()) {
            seat.book();
        }
        
        saveOrders();
    }
}

//File: CinemaManager.java
package com.cinema.service;

import com.cinema.model.*;
import com.cinema.storage.SimpleDataStorage;
import com.cinema.storage.MySQLDataStorage;

import java.time.LocalDate;
import java.time.LocalDateTime;
import java.util.ArrayList;
import java.util.List;
import java.util.Map;
import java.util.concurrent.ConcurrentHashMap;

public class CinemaManager {
    private static CinemaManager instance;
    private final Map<String, Movie> movies;
    private final Map<String, ScreeningRoom> rooms;
    private final Map<String, Show> shows;
    private final Map<String, User> users;
    private final SimpleDataStorage dataStorage;
    private final MySQLDataStorage mysqlDataStorage;
    private final boolean useMySQL;

    private CinemaManager() {
        this.dataStorage = new SimpleDataStorage();
        this.movies = new ConcurrentHashMap<>();
        this.rooms = new ConcurrentHashMap<>();
        this.shows = new ConcurrentHashMap<>();
        this.users = new ConcurrentHashMap<>();
        
        // 尝试使用MySQL，如果失败则使用文件存储
        boolean mysqlAvailable = false;
        MySQLDataStorage mysqlStorage = null;
        try {
            mysqlStorage = new MySQLDataStorage();
            mysqlAvailable = true;
            System.out.println("使用MySQL数据库存储");
        } catch (Exception e) {
            System.err.println("MySQL连接失败，使用文件存储: " + e.getMessage());
            System.err.println("提示：如需使用MySQL，请下载MySQL Connector/J并添加到classpath");
            mysqlStorage = null;
        }
        this.mysqlDataStorage = mysqlStorage;
        this.useMySQL = mysqlAvailable;
        
        loadData();
        
        // 如果没有数据，则初始化默认数据
        if (movies.isEmpty() && rooms.isEmpty() && users.isEmpty()) {
            initializeDefaultData();
        }
    }

    public static synchronized CinemaManager getInstance() {
        if (instance == null) {
            instance = new CinemaManager();
        }
        return instance;
    }

    private void initializeDefaultData() {
        // Create default screening rooms
        ScreeningRoom room1 = new ScreeningRoom("ROOM-001", "标准厅1", 8, 12);
        ScreeningRoom room2 = new ScreeningRoom("ROOM-002", "VIP厅", 6, 10);
        ScreeningRoom room3 = new ScreeningRoom("ROOM-003", "IMAX厅", 10, 15);
        
        rooms.put(room1.getId(), room1);
        rooms.put(room2.getId(), room2);
        rooms.put(room3.getId(), room3);

        // Create default movies
        Movie movie1 = new Movie(
            "MOV-001", 
            "流浪地球2", 
            LocalDate.of(2023, 1, 22),
            List.of("吴京", "刘德华", "李雪健"),
            "郭帆",
            173,
            8.3,
            "太阳即将毁灭，人类在地球表面建造出巨大的推进器，寻找新的家园。然而宇宙之路危机四伏，为了拯救地球，流浪地球时代的年轻人再次挺身而出。",
            "科幻"
        );

        Movie movie2 = new Movie(
            "MOV-002",
            "满江红",
            LocalDate.of(2023, 1, 22),
            List.of("沈腾", "易烊千玺", "张译", "雷佳音"),
            "张艺谋",
            159,
            7.9,
            "南宋绍兴年间，岳飞死后四年，秦桧率兵与金国会谈。会谈前夜，金国使者死在宰相驻地，所携密信也不翼而飞。",
            "剧情/悬疑"
        );

        Movie movie3 = new Movie(
            "MOV-003",
            "深海",
            LocalDate.of(2023, 1, 22),
            List.of("苏鑫", "王亭文", "滕奎兴"),
            "田晓鹏",
            112,
            7.3,
            "在大海的最深处，藏着所有秘密。一位现代少女参宿，在神秘海洋世界中追寻探索，邂逅了一段独特的生命旅程的故事。",
            "动画/奇幻"
        );

        movies.put(movie1.getId(), movie1);
        movies.put(movie2.getId(), movie2);
        movies.put(movie3.getId(), movie3);

        // Create default shows
        LocalDateTime now = LocalDateTime.now();
        
        Show show1 = new Show(
            "SHOW-001",
            movie1,
            room1,
            now.plusDays(1).withHour(14).withMinute(30),
            45.0
        );

        Show show2 = new Show(
            "SHOW-002",
            movie1,
            room1,
            now.plusDays(1).withHour(19).withMinute(0),
            55.0
        );

        Show show3 = new Show(
            "SHOW-003",
            movie2,
            room2,
            now.plusDays(1).withHour(15).withMinute(0),
            60.0
        );

        Show show4 = new Show(
            "SHOW-004",
            movie3,
            room3,
            now.plusDays(2).withHour(13).withMinute(30),
            50.0
        );

        shows.put(show1.getId(), show1);
        shows.put(show2.getId(), show2);
        shows.put(show3.getId(), show3);
        shows.put(show4.getId(), show4);

        // Add shows to movie schedules
        movie1.addShow(now.plusDays(1).toLocalDate(), show1);
        movie1.addShow(now.plusDays(1).toLocalDate(), show2);
        movie2.addShow(now.plusDays(1).toLocalDate(), show3);
        movie3.addShow(now.plusDays(2).toLocalDate(), show4);

        // Create default admin user
        User admin = new User(
                "ADMIN-001",
                "管理员",
                "admin123",      // 密码
                "13800138000",
                "admin@cinema.com",
                User.UserRole.ADMIN
        );
        users.put(admin.getId(), admin);
    }

    public void addMovie(Movie movie) {
        if (movie != null && movie.getId() != null) {
            movies.put(movie.getId(), movie);
            saveMovies();
        }
    }

    public void removeMovie(String movieId) {
        Movie movie = movies.remove(movieId);
        if (movie != null) {
            // Remove all shows for this movie
            Map<LocalDate, List<Show>> allShows = movie.getAllShows();
            for (List<Show> showList : allShows.values()) {
                for (Show show : showList) {
                    shows.remove(show.getId());
                }
            }
            saveMovies();
            saveShows();
        }
    }

    public void addShow(Show show) {
        if (show != null && show.getId() != null) {
            shows.put(show.getId(), show);
            show.getMovie().addShow(show.getStartTime().toLocalDate(), show);
            saveShows();
            saveMovies();
        }
    }

    public void removeShow(String showId) {
        Show show = shows.remove(showId);
        if (show != null) {
            show.getMovie().removeShow(show.getStartTime().toLocalDate(), show);
            saveShows();
            saveMovies();
        }
    }

    public void addScreeningRoom(ScreeningRoom room) {
        if (room != null && room.getId() != null) {
            rooms.put(room.getId(), room);
            saveRooms();
        }
    }

    public void removeScreeningRoom(String roomId) {
        rooms.remove(roomId);
        saveRooms();
    }

    public void addUser(User user) {
        if (user != null && user.getId() != null) {
            users.put(user.getId(), user);
            saveUsers();
        }
    }

    public void removeUser(String userId) {
        users.remove(userId);
        saveUsers();
    }

    public Movie getMovie(String movieId) {
        return movies.get(movieId);
    }

    public List<Movie> getAllMovies() {
        List<Movie> movieList = new ArrayList<>(movies.values());
        // 按电影ID排序
        movieList.sort((m1, m2) -> m1.getId().compareTo(m2.getId()));
        return movieList;
    }

    public ScreeningRoom getScreeningRoom(String roomId) {
        return rooms.get(roomId);
    }

    public List<ScreeningRoom> getAllScreeningRooms() {
        return new ArrayList<>(rooms.values());
    }

    public Show getShow(String showId) {
        return shows.get(showId);
    }

    public List<Show> getAllShows() {
        return new ArrayList<>(shows.values());
    }

    public List<Show> getShowsByMovie(String movieId) {
        List<Show> movieShows = new ArrayList<>();
        for (Show show : shows.values()) {
            if (show.getMovieId().equals(movieId)) {
                movieShows.add(show);
            }
        }
        return movieShows;
    }

    public List<Show> getShowsByDate(LocalDate date) {
        List<Show> dateShows = new ArrayList<>();
        for (Show show : shows.values()) {
            if (show.getStartTime().toLocalDate().equals(date)) {
                dateShows.add(show);
            }
        }
        return dateShows;
    }

    public User getUser(String userId) {
        return users.get(userId);
    }

    public List<User> getAllUsers() {
        return new ArrayList<>(users.values());
    }

    public List<Show> searchShows(String movieTitle, LocalDate date) {
        List<Show> matchingShows = new ArrayList<>();
        for (Show show : shows.values()) {
            boolean titleMatch = movieTitle == null || movieTitle.isEmpty() || 
                               show.getMovieTitle().contains(movieTitle);
            boolean dateMatch = date == null || 
                              show.getStartTime().toLocalDate().equals(date);
            
            if (titleMatch && dateMatch) {
                matchingShows.add(show);
            }
        }
        return matchingShows;
    }
    
    private void loadData() {
        if (useMySQL && mysqlDataStorage != null) {
            movies.putAll(mysqlDataStorage.loadMovies());
            rooms.putAll(mysqlDataStorage.loadScreeningRooms());
            shows.putAll(mysqlDataStorage.loadShows());
            users.putAll(mysqlDataStorage.loadUsers());
        } else {
            movies.putAll(dataStorage.loadMovies());
            rooms.putAll(dataStorage.loadScreeningRooms());
            shows.putAll(dataStorage.loadShows());
            users.putAll(dataStorage.loadUsers());
        }
        
        // 重建电影和场次的关系
        // 由于使用JOIN查询已经加载了关联对象，这里不再需要重建
        
        // 重建用户和订单的关系（延迟到BookingService初始化后）
        // 这个关系重建将在BookingService初始化后完成
    }
    
    private void saveMovies() {
        if (useMySQL && mysqlDataStorage != null) {
            mysqlDataStorage.saveMovies(movies);
        } else {
            dataStorage.saveMovies(movies);
        }
    }
    
    private void saveRooms() {
        if (useMySQL && mysqlDataStorage != null) {
            mysqlDataStorage.saveScreeningRooms(rooms);
        } else {
            dataStorage.saveScreeningRooms(rooms);
        }
    }
    
    private void saveShows() {
        if (useMySQL && mysqlDataStorage != null) {
            mysqlDataStorage.saveShows(shows);
        } else {
            dataStorage.saveShows(shows);
        }
    }
    
    private void saveUsers() {
        if (useMySQL && mysqlDataStorage != null) {
            mysqlDataStorage.saveUsers(users);
        } else {
            dataStorage.saveUsers(users);
        }
    }
    
    public void saveAllData() {
        saveMovies();
        saveRooms();
        saveShows();
        saveUsers();
        BookingService.getInstance().saveOrders();
    }
    
    public void backupData() {
        dataStorage.backupData();
    }
    
    public void shutdown() {
        saveAllData();
        if (useMySQL && mysqlDataStorage != null) {
            mysqlDataStorage.close();
        }
    }
}

//File: MySQLDataStorage.java
package com.cinema.storage;

import com.cinema.model.*;

import java.sql.*;
import java.time.LocalDate;
import java.time.LocalDateTime;
import java.time.format.DateTimeFormatter;
import java.util.*;

public class MySQLDataStorage {
    private static final DateTimeFormatter DATE_FORMATTER = DateTimeFormatter.ofPattern("yyyy-MM-dd HH:mm:ss");
    
    public MySQLDataStorage() {
        initializeDatabase();
    }
    
    private void initializeDatabase() {
        // 检查驱动是否可用
        if (!SimpleDatabaseConnection.isDriverAvailable()) {
            throw new RuntimeException("MySQL驱动不可用，请确保MySQL Connector/J在classpath中");
        }
        
        // 测试数据库连接
        if (!SimpleDatabaseConnection.testConnection()) {
            throw new RuntimeException("无法连接到数据库");
        }
        
        // 这里可以添加初始化数据的逻辑
        System.out.println("MySQL数据库连接成功");
    }
    
    // ========== 电影相关方法 ==========
    
    public void saveMovies(Map<String, Movie> movies) {
        String sql = "INSERT INTO movies (id, title, director, actors, duration, rating, genre, description) " +
                     "VALUES (?, ?, ?, ?, ?, ?, ?, ?) " +
                     "ON DUPLICATE KEY UPDATE title = VALUES(title), director = VALUES(director), " +
                     "actors = VALUES(actors), duration = VALUES(duration), rating = VALUES(rating), " +
                     "genre = VALUES(genre), description = VALUES(description)";
        
        try (Connection conn = SimpleDatabaseConnection.getConnection();
             PreparedStatement pstmt = conn.prepareStatement(sql)) {
            
            conn.setAutoCommit(false);
            
            for (Movie movie : movies.values()) {
                pstmt.setString(1, movie.getId());
                pstmt.setString(2, movie.getTitle());
                pstmt.setString(3, movie.getDirector());
                pstmt.setString(4, String.join(",", movie.getActors()));
                pstmt.setInt(5, movie.getDuration());
                pstmt.setDouble(6, movie.getRating());
                pstmt.setString(7, movie.getGenre().toString());
                pstmt.setString(8, movie.getDescription());
                pstmt.addBatch();
            }
            
            pstmt.executeBatch();
            conn.commit();
            
        } catch (SQLException e) {
            System.err.println("保存电影数据失败: " + e.getMessage());
        }
    }
    
    public Map<String, Movie> loadMovies() {
        Map<String, Movie> movies = new HashMap<>();
        String sql = "SELECT * FROM movies";
        
        try (Connection conn = SimpleDatabaseConnection.getConnection();
             Statement stmt = conn.createStatement();
             ResultSet rs = stmt.executeQuery(sql)) {
            
            while (rs.next()) {
                Movie movie = new Movie(
                    rs.getString("id"),
                    rs.getString("title"),
                    java.time.LocalDate.now(), // 使用当前日期作为默认值
                    Arrays.asList(rs.getString("actors").split(",")),
                    rs.getString("director"),
                    rs.getInt("duration"),
                    rs.getDouble("rating"),
                    rs.getString("description"),
                    MovieGenre.fromDescription(rs.getString("genre"))
                );
                movies.put(movie.getId(), movie);
            }
            
        } catch (SQLException e) {
            System.err.println("加载电影数据失败: " + e.getMessage());
        }
        
        return movies;
    }
    
    // ========== 放映厅相关方法 ==========
    
    public void saveScreeningRooms(Map<String, ScreeningRoom> rooms) {
        String sql = "INSERT INTO screening_rooms (id, name, room_rows, room_columns) " +
                     "VALUES (?, ?, ?, ?) " +
                     "ON DUPLICATE KEY UPDATE name = VALUES(name), room_rows = VALUES(room_rows), room_columns = VALUES(room_columns)";
        
        try (Connection conn = SimpleDatabaseConnection.getConnection();
             PreparedStatement pstmt = conn.prepareStatement(sql)) {
            
            conn.setAutoCommit(false);
            
            for (ScreeningRoom room : rooms.values()) {
                pstmt.setString(1, room.getId());
                pstmt.setString(2, room.getName());
                pstmt.setInt(3, room.getRows());
                pstmt.setInt(4, room.getColumns());
                pstmt.addBatch();
            }
            
            pstmt.executeBatch();
            conn.commit();
            
        } catch (SQLException e) {
            System.err.println("保存放映厅数据失败: " + e.getMessage());
        }
    }
    
    public Map<String, ScreeningRoom> loadScreeningRooms() {
        Map<String, ScreeningRoom> rooms = new HashMap<>();
        String sql = "SELECT * FROM screening_rooms";
        
        try (Connection conn = SimpleDatabaseConnection.getConnection();
             Statement stmt = conn.createStatement();
             ResultSet rs = stmt.executeQuery(sql)) {
            
            while (rs.next()) {
                ScreeningRoom room = new ScreeningRoom(
                    rs.getString("id"),
                    rs.getString("name"),
                    rs.getInt("room_rows"),
                    rs.getInt("room_columns")
                );
                rooms.put(room.getId(), room);
            }
            
        } catch (SQLException e) {
            System.err.println("加载放映厅数据失败: " + e.getMessage());
        }
        
        return rooms;
    }
    
    // ========== 场次相关方法 ==========
    
    public void saveShows(Map<String, Show> shows) {
        String sql = "INSERT INTO shows (id, movie_id, room_id, start_time, end_time, base_price, status) " +
                     "VALUES (?, ?, ?, ?, ?, ?, ?) " +
                     "ON DUPLICATE KEY UPDATE movie_id = VALUES(movie_id), room_id = VALUES(room_id), " +
                     "start_time = VALUES(start_time), end_time = VALUES(end_time), " +
                     "base_price = VALUES(base_price), status = VALUES(status)";
        
        try (Connection conn = SimpleDatabaseConnection.getConnection();
             PreparedStatement pstmt = conn.prepareStatement(sql)) {
            
            conn.setAutoCommit(false);
            
            for (Show show : shows.values()) {
                pstmt.setString(1, show.getId());
                pstmt.setString(2, show.getMovie().getId());
                pstmt.setString(3, show.getScreeningRoom().getId());
                pstmt.setString(4, show.getStartTime().format(DATE_FORMATTER));
                pstmt.setString(5, show.getStartTime().plusMinutes(show.getMovie().getDuration()).format(DATE_FORMATTER)); // 计算结束时间
                pstmt.setDouble(6, show.getBasePrice());
                pstmt.setString(7, "SCHEDULED"); // 默认状态
                pstmt.addBatch();
            }
            
            pstmt.executeBatch();
            conn.commit();
            
        } catch (SQLException e) {
            System.err.println("保存场次数据失败: " + e.getMessage());
        }
    }
    
    public Map<String, Show> loadShows() {
        Map<String, Show> shows = new HashMap<>();
        
        // 先加载所有电影和放映厅
        Map<String, Movie> movies = loadMovies();
        Map<String, ScreeningRoom> rooms = loadScreeningRooms();
        
        // 使用JOIN查询加载场次及其关联数据
        String sql = "SELECT s.*, m.title as movie_title, m.id as movie_id, " +
                     "m.director as movie_director, m.duration as movie_duration, " +
                     "m.actors as actors, m.genre as genre, m.rating as rating, m.description as description, " +
                     "r.name as room_name, r.id as room_id, r.room_rows, r.room_columns " +
                     "FROM shows s " +
                     "LEFT JOIN movies m ON s.movie_id = m.id " +
                     "LEFT JOIN screening_rooms r ON s.room_id = r.id";
        
        try (Connection conn = SimpleDatabaseConnection.getConnection();
             Statement stmt = conn.createStatement();
             ResultSet rs = stmt.executeQuery(sql)) {
            
            while (rs.next()) {
                // 创建Movie对象
                String actorsStr = rs.getString("actors");
                List<String> actors = new ArrayList<>();
                if (actorsStr != null && !actorsStr.isEmpty()) {
                    actors = Arrays.asList(actorsStr.split(","));
                }
                
                String genreStr = rs.getString("genre");
                MovieGenre genre = MovieGenre.DRAMA; // 默认值
                if (genreStr != null && !genreStr.isEmpty()) {
                    genre = MovieGenre.fromDescription(genreStr);
                }
                
                Movie movie = new Movie(
                    rs.getString("movie_id"),
                    rs.getString("movie_title"),
                    LocalDate.now(), // 从数据库中应该有release_date字段，暂时使用当前日期
                    actors,
                    rs.getString("movie_director"),
                    rs.getInt("movie_duration"),
                    rs.getDouble("rating"),
                    rs.getString("description"),
                    genre
                );
                
                // 创建ScreeningRoom对象
                ScreeningRoom room = new ScreeningRoom(
                    rs.getString("room_id"),
                    rs.getString("room_name"),
                    rs.getInt("room_rows"),
                    rs.getInt("room_columns")
                );
                
                // 创建Show对象
                Show show = new Show(
                    rs.getString("id"),
                    movie,
                    room,
                    LocalDateTime.parse(rs.getString("start_time"), DATE_FORMATTER),
                    rs.getDouble("base_price")
                );
                
                shows.put(show.getId(), show);
            }
            
        } catch (SQLException e) {
            System.err.println("加载场次数据失败: " + e.getMessage());
        }
        
        return shows;
    }
    
    // ========== 用户相关方法 ==========
    
    public void saveUsers(Map<String, User> users) {
        String sql = "INSERT INTO users (id, name, phone, email, is_admin) " +
                     "VALUES (?, ?, ?, ?, ?) " +
                     "ON DUPLICATE KEY UPDATE name = VALUES(name), phone = VALUES(phone), " +
                     "email = VALUES(email), is_admin = VALUES(is_admin)";
        
        try (Connection conn = SimpleDatabaseConnection.getConnection();
             PreparedStatement pstmt = conn.prepareStatement(sql)) {
            
            conn.setAutoCommit(false);
            
            for (User user : users.values()) {
                pstmt.setString(1, user.getId());
                pstmt.setString(2, user.getName());
                pstmt.setString(3, user.getPhone());
                pstmt.setString(4, user.getEmail());
                pstmt.setBoolean(5, user.isAdmin());
                pstmt.addBatch();
            }
            
            pstmt.executeBatch();
            conn.commit();
            
        } catch (SQLException e) {
            System.err.println("保存用户数据失败: " + e.getMessage());
        }
    }

    public Map<String, User> loadUsers() {
        Map<String, User> users = new HashMap<>();
        // 注意：如果你还没在数据库加 password 列，这里先不查 password
        String sql = "SELECT * FROM users";

        try (Connection conn = SimpleDatabaseConnection.getConnection();
             Statement stmt = conn.createStatement();
             ResultSet rs = stmt.executeQuery(sql)) {

            while (rs.next()) {
                // --- 修复开始 ---
                // 获取数据库中的字段
                String id = rs.getString("id");
                String name = rs.getString("name");
                String phone = rs.getString("phone");
                String email = rs.getString("email");
                boolean isAdmin = rs.getBoolean("is_admin");

                // 创建 User 对象
                // 注意：因为数据库表里暂时可能没有 password 字段
                // 我们这里先暂时用 "123456" 作为从数据库加载出来的用户的默认密码
                // 或者你可以暂时把 phone 当作密码: String password = phone;
                String password = "123456";

                User user = new User(
                        rs.getString("id"),
                        rs.getString("name"),
                        "123456", // <--- 关键！在这里手动插入一个默认密码参数
                        rs.getString("phone"),
                        rs.getString("email"),
                        rs.getBoolean("is_admin") ? User.UserRole.ADMIN : User.UserRole.CUSTOMER
                );
                // --- 修复结束 ---

                users.put(user.getId(), user);
            }

        } catch (SQLException e) {
            System.err.println("加载用户数据失败: " + e.getMessage());
        }

        return users;
    }
    
    // ========== 订单相关方法 ==========
    
    public void saveOrders(Map<String, Order> orders) {
        String sql = "INSERT INTO orders (order_id, user_id, show_id, total_amount, status, payment_status) " +
                     "VALUES (?, ?, ?, ?, ?, ?) " +
                     "ON DUPLICATE KEY UPDATE user_id = VALUES(user_id), show_id = VALUES(show_id), " +
                     "total_amount = VALUES(total_amount), status = VALUES(status), " +
                     "payment_status = VALUES(payment_status)";
        
        try (Connection conn = SimpleDatabaseConnection.getConnection();
             PreparedStatement pstmt = conn.prepareStatement(sql)) {
            
            conn.setAutoCommit(false);
            
            for (Order order : orders.values()) {
                pstmt.setString(1, order.getOrderId());
                pstmt.setString(2, order.getUser().getId());
                pstmt.setString(3, order.getShow().getId());
                pstmt.setDouble(4, order.getTotalAmount());
                pstmt.setString(5, "CONFIRMED"); // 默认状态
                pstmt.setString(6, "PAID"); // 默认支付状态
                pstmt.addBatch();
            }
            
            pstmt.executeBatch();
            conn.commit();
            
        } catch (SQLException e) {
            System.err.println("保存订单数据失败: " + e.getMessage());
        }
    }
    
    public Map<String, Order> loadOrders() {
        Map<String, Order> orders = new HashMap<>();
        String sql = "SELECT * FROM orders";
        
        try (Connection conn = SimpleDatabaseConnection.getConnection();
             Statement stmt = conn.createStatement();
             ResultSet rs = stmt.executeQuery(sql)) {
            
            while (rs.next()) {
                // 注意：Order的构造函数需要Show对象，这里暂时跳过
                // TODO: 实现完整的Order加载逻辑，需要先加载Show和Seat
            }
            
        } catch (SQLException e) {
            System.err.println("加载订单数据失败: " + e.getMessage());
        }
        
        return orders;
    }
    
    // ========== 数据库初始化方法 ==========
    
    public void initializeDefaultData() {
        // 这里可以添加初始化默认数据的逻辑
        // 比如创建默认的管理员账户、放映厅等
        System.out.println("数据库初始化完成");
    }
    
    // ========== 关闭连接 ==========
    
    public void close() {
        // 简单连接不需要关闭连接池
    }
}

//File: SimpleDatabaseConnection.java
package com.cinema.storage;

import java.io.IOException;
import java.io.InputStream;
import java.sql.Connection;
import java.sql.DriverManager;
import java.sql.SQLException;
import java.util.Properties;

public class SimpleDatabaseConnection {
    private static String url;
    private static String username;
    private static String password;
    private static String driver;
    private static boolean driverAvailable = false;
    private static boolean initialized = false;
    
    private static void initialize() {
        if (initialized) return;
        
        try {
            // 加载配置文件
            Properties props = new Properties();
            InputStream input = SimpleDatabaseConnection.class.getClassLoader().getResourceAsStream("config.properties");
            if (input != null) {
                props.load(input);
                url = props.getProperty("db.url");
                username = props.getProperty("db.username");
                password = props.getProperty("db.password");
                driver = props.getProperty("db.driver");
            }
            
            // 如果配置文件不存在或配置不完整，使用默认值
            if (url == null || username == null || password == null || driver == null) {
                System.err.println("数据库配置不完整，将使用默认配置");
                url = "jdbc:mysql://localhost:3306/cinema_db?useUnicode=true&characterEncoding=utf8&useSSL=false&serverTimezone=UTC";
                username = "root";
                password = "123421";
                driver = "com.mysql.cj.jdbc.Driver";
            }
            
            // 尝试加载驱动
            Class.forName(driver);
            driverAvailable = true;
            System.out.println("MySQL驱动加载成功");
            
        } catch (IOException e) {
            throw new RuntimeException("初始化数据库连接失败", e);
        } catch (ClassNotFoundException e) {
            System.err.println("MySQL驱动未找到，将无法使用MySQL数据库");
            driverAvailable = false;
        }
        
        initialized = true;
    }
    
    public static Connection getConnection() throws SQLException {
        initialize();
        if (!driverAvailable) {
            throw new SQLException("MySQL驱动不可用");
        }
        return DriverManager.getConnection(url, username, password);
    }
    
    // 测试连接
    public static boolean testConnection() {
        initialize();
        if (!driverAvailable) {
            return false;
        }
        try (Connection conn = getConnection()) {
            return conn != null && !conn.isClosed();
        } catch (SQLException e) {
            System.err.println("数据库连接测试失败: " + e.getMessage());
            return false;
        }
    }
    
    // 检查驱动是否可用
    public static boolean isDriverAvailable() {
        initialize();
        return driverAvailable;
    }
}

//File: SimpleDataStorage.java
package com.cinema.storage;

import com.cinema.model.*;
import java.io.*;
import java.nio.file.Files;
import java.nio.file.Path;
import java.nio.file.Paths;
import java.time.LocalDate;
import java.time.LocalDateTime;
import java.util.*;

public class SimpleDataStorage {
    private static final String DATA_DIR = "data";
    private static final String MOVIES_FILE = DATA_DIR + "/movies.dat";
    private static final String ROOMS_FILE = DATA_DIR + "/rooms.dat";
    private static final String SHOWS_FILE = DATA_DIR + "/shows.dat";
    private static final String USERS_FILE = DATA_DIR + "/users.dat";
    private static final String ORDERS_FILE = DATA_DIR + "/orders.dat";
    
    public SimpleDataStorage() {
        createDataDirectory();
    }
    
    private void createDataDirectory() {
        try {
            Path dataPath = Paths.get(DATA_DIR);
            if (!Files.exists(dataPath)) {
                Files.createDirectories(dataPath);
            }
        } catch (IOException e) {
            System.err.println("创建数据目录失败: " + e.getMessage());
        }
    }
    
    public void saveMovies(Map<String, Movie> movies) {
        try (ObjectOutputStream oos = new ObjectOutputStream(
                new FileOutputStream(MOVIES_FILE))) {
            oos.writeObject(new ArrayList<>(movies.values()));
        } catch (IOException e) {
            System.err.println("保存电影数据失败: " + e.getMessage());
        }
    }
    
    public Map<String, Movie> loadMovies() {
        try (ObjectInputStream ois = new ObjectInputStream(
                new FileInputStream(MOVIES_FILE))) {
            @SuppressWarnings("unchecked")
            List<Movie> movieList = (List<Movie>) ois.readObject();
            
            Map<String, Movie> movies = new HashMap<>();
            for (Movie movie : movieList) {
                movies.put(movie.getId(), movie);
            }
            return movies;
        } catch (FileNotFoundException e) {
            return new HashMap<>();
        } catch (IOException | ClassNotFoundException e) {
            System.err.println("加载电影数据失败: " + e.getMessage());
            return new HashMap<>();
        }
    }
    
    public void saveScreeningRooms(Map<String, ScreeningRoom> rooms) {
        try (ObjectOutputStream oos = new ObjectOutputStream(
                new FileOutputStream(ROOMS_FILE))) {
            oos.writeObject(new ArrayList<>(rooms.values()));
        } catch (IOException e) {
            System.err.println("保存放映厅数据失败: " + e.getMessage());
        }
    }
    
    public Map<String, ScreeningRoom> loadScreeningRooms() {
        try (ObjectInputStream ois = new ObjectInputStream(
                new FileInputStream(ROOMS_FILE))) {
            @SuppressWarnings("unchecked")
            List<ScreeningRoom> roomList = (List<ScreeningRoom>) ois.readObject();
            
            Map<String, ScreeningRoom> rooms = new HashMap<>();
            for (ScreeningRoom room : roomList) {
                rooms.put(room.getId(), room);
            }
            return rooms;
        } catch (FileNotFoundException e) {
            return new HashMap<>();
        } catch (IOException | ClassNotFoundException e) {
            System.err.println("加载放映厅数据失败: " + e.getMessage());
            return new HashMap<>();
        }
    }
    
    public void saveShows(Map<String, Show> shows) {
        try (ObjectOutputStream oos = new ObjectOutputStream(
                new FileOutputStream(SHOWS_FILE))) {
            oos.writeObject(new ArrayList<>(shows.values()));
        } catch (IOException e) {
            System.err.println("保存场次数据失败: " + e.getMessage());
        }
    }
    
    public Map<String, Show> loadShows() {
        try (ObjectInputStream ois = new ObjectInputStream(
                new FileInputStream(SHOWS_FILE))) {
            @SuppressWarnings("unchecked")
            List<Show> showList = (List<Show>) ois.readObject();
            
            Map<String, Show> shows = new HashMap<>();
            for (Show show : showList) {
                shows.put(show.getId(), show);
            }
            return shows;
        } catch (FileNotFoundException e) {
            return new HashMap<>();
        } catch (IOException | ClassNotFoundException e) {
            System.err.println("加载场次数据失败: " + e.getMessage());
            return new HashMap<>();
        }
    }
    
    public void saveUsers(Map<String, User> users) {
        try (ObjectOutputStream oos = new ObjectOutputStream(
                new FileOutputStream(USERS_FILE))) {
            oos.writeObject(new ArrayList<>(users.values()));
        } catch (IOException e) {
            System.err.println("保存用户数据失败: " + e.getMessage());
        }
    }
    
    public Map<String, User> loadUsers() {
        try (ObjectInputStream ois = new ObjectInputStream(
                new FileInputStream(USERS_FILE))) {
            @SuppressWarnings("unchecked")
            List<User> userList = (List<User>) ois.readObject();
            
            Map<String, User> users = new HashMap<>();
            for (User user : userList) {
                users.put(user.getId(), user);
            }
            return users;
        } catch (FileNotFoundException e) {
            return new HashMap<>();
        } catch (IOException | ClassNotFoundException e) {
            System.err.println("加载用户数据失败: " + e.getMessage());
            return new HashMap<>();
        }
    }
    
    public void saveOrders(Map<String, Order> orders) {
        try (ObjectOutputStream oos = new ObjectOutputStream(
                new FileOutputStream(ORDERS_FILE))) {
            oos.writeObject(new ArrayList<>(orders.values()));
        } catch (IOException e) {
            System.err.println("保存订单数据失败: " + e.getMessage());
        }
    }
    
    public Map<String, Order> loadOrders() {
        try (ObjectInputStream ois = new ObjectInputStream(
                new FileInputStream(ORDERS_FILE))) {
            @SuppressWarnings("unchecked")
            List<Order> orderList = (List<Order>) ois.readObject();
            
            Map<String, Order> orders = new HashMap<>();
            for (Order order : orderList) {
                orders.put(order.getOrderId(), order);
            }
            return orders;
        } catch (FileNotFoundException e) {
            return new HashMap<>();
        } catch (IOException | ClassNotFoundException e) {
            System.err.println("加载订单数据失败: " + e.getMessage());
            return new HashMap<>();
        }
    }
    
    public void backupData() {
        String timestamp = LocalDateTime.now().format(
            java.time.format.DateTimeFormatter.ofPattern("yyyyMMdd_HHmmss"));
        String backupDir = DATA_DIR + "/backup_" + timestamp;
        
        try {
            Path backupPath = Paths.get(backupDir);
            Files.createDirectories(backupPath);
            
            // 复制所有数据文件到备份目录
            copyFileIfExists(MOVIES_FILE, backupPath.resolve("movies.dat"));
            copyFileIfExists(ROOMS_FILE, backupPath.resolve("rooms.dat"));
            copyFileIfExists(SHOWS_FILE, backupPath.resolve("shows.dat"));
            copyFileIfExists(USERS_FILE, backupPath.resolve("users.dat"));
            copyFileIfExists(ORDERS_FILE, backupPath.resolve("orders.dat"));
            
            System.out.println("数据备份完成: " + backupDir);
        } catch (IOException e) {
            System.err.println("数据备份失败: " + e.getMessage());
        }
    }
    
    private void copyFileIfExists(String source, Path target) throws IOException {
        Path sourcePath = Paths.get(source);
        if (Files.exists(sourcePath)) {
            Files.copy(sourcePath, target);
        }
    }
}

//File: PremiumPricing.java
package com.cinema.strategy;

import com.cinema.model.Show;
import com.cinema.model.Seat;
import com.cinema.model.VIPSeat;

public class PremiumPricing implements PricingStrategy {
    
    @Override
    public double calculatePrice(Show show, Seat seat) {
        double basePrice = show.getBasePrice();
        
        // VIP seats get premium pricing
        if (seat instanceof VIPSeat) {
            basePrice *= 2.0;
        }
        
        // Weekend pricing (30% increase)
        if (isWeekend(show.getStartTime().getDayOfWeek().getValue())) {
            basePrice *= 1.3;
        }
        
        // Evening pricing (after 6 PM, 25% increase)
        if (show.getStartTime().getHour() >= 18) {
            basePrice *= 1.25;
        }
        
        // Prime time pricing (7-9 PM, additional 10%)
        if (show.getStartTime().getHour() >= 19 && show.getStartTime().getHour() <= 21) {
            basePrice *= 1.1;
        }
        
        return basePrice;
    }
    
    private boolean isWeekend(int dayOfWeek) {
        // In Java DayOfWeek: 1=Monday, 7=Sunday
        return dayOfWeek == 6 || dayOfWeek == 7;
    }
}

//File: PricingStrategy.java
package com.cinema.strategy;

import com.cinema.model.Show;
import com.cinema.model.Seat;

public interface PricingStrategy {
    double calculatePrice(Show show, Seat seat);
}

//File: StandardPricing.java
package com.cinema.strategy;

import com.cinema.model.Show;
import com.cinema.model.Seat;
import com.cinema.model.VIPSeat;
import com.cinema.model.DiscountSeat;

public class StandardPricing implements PricingStrategy {
    
    @Override
    public double calculatePrice(Show show, Seat seat) {
        double basePrice;
        
        // 根据座位类型使用对应的价格
        if (seat instanceof VIPSeat) {
            basePrice = show.getVipPrice();
        } else if (seat instanceof DiscountSeat) {
            basePrice = show.getDiscountPrice();
        } else {
            basePrice = show.getBasePrice();
        }
        
        // Weekend pricing (20% increase)
        if (isWeekend(show.getStartTime().getDayOfWeek().getValue())) {
            basePrice *= 1.2;
        }
        
        // Evening pricing (after 6 PM, 15% increase)
        if (show.getStartTime().getHour() >= 18) {
            basePrice *= 1.15;
        }
        
        return basePrice;
    }
    
    private boolean isWeekend(int dayOfWeek) {
        // In Java DayOfWeek: 1=Monday, 7=Sunday
        return dayOfWeek == 6 || dayOfWeek == 7;
    }
}

//File: ConsoleUI.java
package com.cinema.ui;

import com.cinema.model.*;
import com.cinema.service.*;
import com.cinema.strategy.StandardPricing;
import com.cinema.strategy.PremiumPricing;
import com.cinema.exception.*;

import java.time.LocalDate;
import java.time.LocalDateTime;
import java.time.format.DateTimeFormatter;
import java.util.List;
import java.util.Scanner;

public class ConsoleUI {
    private final CinemaManager cinemaManager;
    private final BookingService bookingService;
    private final Scanner scanner;
    private User currentUser;
    private NewMethods newMethods;
    
    // ANSI颜色代码（用于美化控制台输出）
    private static final String RESET = "\u001B[0m";
    private static final String RED = "\u001B[31m";
    private static final String GREEN = "\u001B[32m";
    private static final String YELLOW = "\u001B[33m";
    private static final String BLUE = "\u001B[34m";
    private static final String PURPLE = "\u001B[35m";
    private static final String CYAN = "\u001B[36m";
    private static final String WHITE = "\u001B[37m";
    private static final String ORANGE = "\u001B[38;5;208m"; // 橙色
    private static final String BOLD = "\u001B[1m";
    
    // 界面装饰符号
    private static final String LINE = "═";
    private static final String CORNER_TL = "╔";
    private static final String CORNER_TR = "╗";
    private static final String CORNER_BL = "╚";
    private static final String CORNER_BR = "╝";
    private static final String VERTICAL = "║";
    private static final String HORIZONTAL = "─";
    private static final String CROSS = "╬";

    public ConsoleUI() {
        this.cinemaManager = CinemaManager.getInstance();
        this.bookingService = BookingService.getInstance(new StandardPricing());
        this.scanner = new Scanner(System.in);
        this.currentUser = null;
        this.newMethods = null;
        
        // 添加关闭钩子，确保程序退出时保存数据
        Runtime.getRuntime().addShutdownHook(new Thread(() -> {
            try {
                cinemaManager.saveAllData();
                System.out.println("\n数据已自动保存");
            } catch (Exception e) {
                System.err.println("自动保存数据时出错: " + e.getMessage());
            }
        }));
    }
    
    // 辅助方法：安全地读取用户输入
    private String readLine() {
        try {
            if (System.console() != null) {
                String input = System.console().readLine();
                return input != null ? input.trim() : "";
            } else {
                if (scanner.hasNextLine()) {
                    String input = scanner.nextLine();
                    return input != null ? input.trim() : "";
                } else {
                    return "";
                }
            }
        } catch (Exception e) {
            return "";
        }
    }
    
    // ========== 界面美化工具方法 ==========
    
    /**
     * 清屏
     */
    private void clearScreen() {
        try {
            if (System.getProperty("os.name").contains("Windows")) {
                new ProcessBuilder("cmd", "/c", "cls").inheritIO().start().waitFor();
            } else {
                System.out.print("\033[H\033[2J");
                System.out.flush();
            }
        } catch (Exception e) {
            // 打印空行来模拟清屏
            for (int i = 0; i < 50; i++) {
                System.out.println();
            }
        }
    }
    
    /**
     * 打印带颜色的文本
     */
    private void printColored(String color, String text) {
        System.out.print(color + text + RESET);
    }
    
    /**
     * 打印带颜色的文本并换行
     */
    private void printlnColored(String color, String text) {
        System.out.println(color + text + RESET);
    }
    
    /**
     * 计算文本在终端的显示宽度（中文等全角字符按2）
     */
    private int getDisplayWidth(String text) {
        int width = 0;
        for (char ch : text.toCharArray()) {
            Character.UnicodeBlock block = Character.UnicodeBlock.of(ch);
            boolean isWide = Character.UnicodeBlock.CJK_UNIFIED_IDEOGRAPHS.equals(block)
                    || Character.UnicodeBlock.CJK_UNIFIED_IDEOGRAPHS_EXTENSION_A.equals(block)
                    || Character.UnicodeBlock.CJK_UNIFIED_IDEOGRAPHS_EXTENSION_B.equals(block)
                    || Character.UnicodeBlock.CJK_COMPATIBILITY_IDEOGRAPHS.equals(block)
                    || Character.UnicodeBlock.CJK_SYMBOLS_AND_PUNCTUATION.equals(block)
                    || Character.UnicodeBlock.HALFWIDTH_AND_FULLWIDTH_FORMS.equals(block)
                    || Character.UnicodeBlock.HANGUL_SYLLABLES.equals(block)
                    || Character.UnicodeBlock.KATAKANA.equals(block)
                    || Character.UnicodeBlock.HIRAGANA.equals(block);
            width += isWide ? 2 : 1;
        }
        return width;
    }

    /**
     * 打印标题框
     */
    private void printTitle(String title) {
        int titleWidth = getDisplayWidth(title);
        int width = Math.max(titleWidth + 10, 60);
        String border = LINE.repeat(width);
        
        // 使用显示宽度计算填充，避免全角字符导致歪斜
        int spaceTotal = width - titleWidth;
        int leftPadding = spaceTotal / 2;
        int rightPadding = spaceTotal - leftPadding;
        
        // 构建标题行，确保垂直符号对齐
        String titleLine = VERTICAL + " ".repeat(leftPadding) + title + " ".repeat(rightPadding) + VERTICAL;
        
        printColored(CYAN, CORNER_TL + border + CORNER_TR);
        System.out.println();
        printColored(CYAN + YELLOW + BOLD, titleLine);
        System.out.println();
        printColored(CYAN, CORNER_BL + border + CORNER_BR);
        System.out.println();
    }
    
    /**
     * 打印分隔线
     */
    private void printSeparator(char character, int length) {
        StringBuilder sb = new StringBuilder();
        for (int i = 0; i < length; i++) {
            sb.append(character);
        }
        printlnColored(CYAN, sb.toString());
    }
    
    /**
     * 打印菜单项
     */
    private void printMenuItem(int number, String description) {
        printColored(GREEN, "  " + number + ". ");
        printlnColored(WHITE, description);
    }
    
    /**
     * 打印成功消息
     */
    private void printSuccess(String message) {
        printColored(GREEN, "✓ ");
        printlnColored(GREEN + BOLD, message);
    }
    
    /**
     * 打印错误消息
     */
    private void printError(String message) {
        printColored(RED, "✗ ");
        printlnColored(RED + BOLD, message);
    }
    
    /**
     * 打印警告消息
     */
    private void printWarning(String message) {
        printColored(YELLOW, "⚠ ");
        printlnColored(YELLOW + BOLD, message);
    }
    
    /**
     * 打印信息消息
     */
    private void printInfo(String message) {
        printColored(BLUE, "ℹ ");
        printlnColored(BLUE, message);
    }
    
    /**
     * 等待用户按回车继续
     */
    private void pressEnterToContinue() {
        printColored(YELLOW, "\n按回车键继续...");
        readLine();
    }

    public void start() {
        try {
            while (true) {
                clearScreen();
                printTitle("欢迎使用电影院购票系统");
                
                login();
                
                // 如果用户选择了退出系统，login()会返回null
                if (currentUser == null) {
                    // 检查是否是主动退出系统
                    break;
                }
                
                newMethods = new NewMethods(cinemaManager, bookingService, scanner, currentUser);
                if (currentUser.isAdmin()) {
                    showAdminMenu();
                } else {
                    showCustomerMenu();
                }
                
                // 退出菜单后，重置用户，准备重新登录
                currentUser = null;
            }
        } finally {
            // 确保在程序退出前保存所有数据
            try {
                cinemaManager.saveAllData();
                clearScreen();
                printTitle("感谢使用电影院购票系统");
                printSuccess("所有数据已保存");
                printColored(YELLOW, "再见！\n");
            } catch (Exception e) {
                System.err.println("保存数据时出错: " + e.getMessage());
            }
        }
    }

    private void login() {
        while (true) {
            clearScreen();
            printTitle("电影院购票系统");
            printlnColored(CYAN, "\n请选择登录方式：\n");
            
            printMenuItem(1, "普通用户登录");
            printMenuItem(2, "管理员登录");
            printMenuItem(3, "用户注册");
            printMenuItem(0, "退出系统");
            
            printColored(YELLOW, "\n请选择操作 (0-3): ");
            String choice = readLine();
            
            switch (choice) {
                case "1":
                    if (performLogin(false)) {
                        printSuccess("登录成功！");
                        return;
                    }
                    break;
                case "2":
                    if (performLogin(true)) {
                        printSuccess("管理员登录成功！");
                        return;
                    }
                    break;
                case "3":
                    performRegister();
                    break;
                case "0":
                    System.exit(0); // 退出整个程序
                default:
                    printError("无效选择，请输入0-3之间的数字");
                    pressEnterToContinue();
            }
        }
    }
    
    private boolean performLogin(boolean isAdminLogin) {
        clearScreen();
        if (isAdminLogin) {
            printTitle("管理员登录");
        } else {
            printTitle("用户登录");
        }
        
        printColored(CYAN, "请输入用户ID: ");
        String userId = readLine();
        
        if (userId.isEmpty()) {
            printError("用户ID不能为空");
            pressEnterToContinue();
            return false;
        }
        
        User user = cinemaManager.getUser(userId);
        if (user != null) {
            // 验证角色是否匹配
            if (isAdminLogin && !user.isAdmin()) {
                printError("该用户不是管理员，无法使用管理员登录");
                pressEnterToContinue();
                return false;
            }
            
            if (!isAdminLogin && user.isAdmin()) {
                printError("管理员用户请使用管理员登录入口");
                pressEnterToContinue();
                return false;
            }
            
            currentUser = user;
            printSuccess("登录成功！欢迎，" + currentUser.getName());
            if (currentUser.isAdmin()) {
                printInfo("当前角色: 管理员");
            } else {
                printInfo("当前角色: 普通用户");
            }
            pressEnterToContinue();
            return true;
        } else {
            printError("用户不存在，请先注册");
            pressEnterToContinue();
            return false;
        }
    }

    private void performRegister() {
        System.out.println("\n----- 用户注册 -----");

        while (true) {
            System.out.print("请输入用户ID (字母数字组合，3-20位): ");
            String userId = readLine();

            if (userId.isEmpty()) {
                System.out.println("用户ID不能为空");
                continue;
            }

            if (userId.length() < 3 || userId.length() > 20) {
                System.out.println("用户ID长度必须在3-20位之间");
                continue;
            }

            if (!userId.matches("^[a-zA-Z0-9_]+$")) {
                System.out.println("用户ID只能包含字母、数字和下划线");
                continue;
            }

            if (cinemaManager.getUser(userId) != null) {
                System.out.println("用户ID已存在，请选择其他ID");
                continue;
            }

            System.out.print("请输入姓名: ");
            String name = readLine();
            if (name.isEmpty()) {
                System.out.println("姓名不能为空");
                continue;
            }

            // ================= [新增开始] =================
            System.out.print("请输入密码 (至少6位): ");
            String password = readLine();
            if (password.length() < 6) {
                System.out.println("密码长度不能少于6位");
                continue;
            }
            // ================= [新增结束] =================

            System.out.print("请输入电话: ");
            String phone = readLine();
            if (phone.isEmpty()) {
                System.out.println("电话不能为空");
                continue;
            }

            if (!phone.matches("^1[3-9]\\d{9}$")) {
                System.out.println("请输入有效的手机号码");
                continue;
            }

            System.out.print("请输入邮箱: ");
            String email = readLine();
            if (email.isEmpty()) {
                System.out.println("邮箱不能为空");
                continue;
            }

            if (!email.matches("^[A-Za-z0-9+_.-]+@[A-Za-z0-9.-]+$")) {
                System.out.println("请输入有效的邮箱地址");
                continue;
            }

            System.out.print("注册为管理员用户？(Y/N): ");
            String adminChoice = readLine();
            boolean isAdmin = adminChoice.equalsIgnoreCase("Y");

            User.UserRole role = isAdmin ? User.UserRole.ADMIN : User.UserRole.CUSTOMER;

            // ================= [修改这里] =================
            // 原来的代码：User newUser = new User(userId, name, phone, email, role);
            // 修改后的代码（加入了 password）：
            User newUser = new User(userId, name, password, phone, email, role);
            // ============================================

            cinemaManager.addUser(newUser);

            System.out.println("用户注册成功！");
            System.out.println("用户ID: " + userId);
            System.out.println("姓名: " + name);
            System.out.println("角色: " + (isAdmin ? "管理员" : "普通用户"));
            System.out.println("现在可以使用该用户ID登录系统");

            return;
        }
    }

    private void showCustomerMenu() {
        while (true) {
            clearScreen();
            printTitle("用户菜单");
            printlnColored(CYAN, "\n当前用户: " + currentUser.getName() + " (" + 
                (currentUser.isAdmin() ? "管理员" : "普通用户") + ")");
            printlnColored(CYAN, "\n请选择操作：\n");
            
            printMenuItem(1, "浏览电影");
            printMenuItem(2, "查询场次");
            printMenuItem(3, "购买电影票");
            printMenuItem(4, "查看我的订单");
            printMenuItem(5, "退票");
            printMenuItem(6, "修改个人信息");
            
            if (currentUser.isAdmin()) {
                printMenuItem(7, "进入管理员菜单");
            }
            
            printMenuItem(0, "退出登录");
            
            printColored(YELLOW, "\n请选择操作: ");
            String choice = readLine();
            
            switch (choice) {
                case "1":
                    browseMovies();
                    break;
                case "2":
                    searchShows();
                    break;
                case "3":
                    purchaseTicket();
                    break;
                case "4":
                    viewMyOrders();
                    break;
                case "5":
                    refundTicket();
                    break;
                case "6":
                    newMethods.editProfile();
                    break;
                case "7":
                    if (currentUser.isAdmin()) {
                        showAdminMenu();
                    } else {
                        printError("权限不足");
                        pressEnterToContinue();
                    }
                    break;
                case "0":
                    newMethods.logout();
                    return;
                default:
                    printError("无效选择，请重试");
                    pressEnterToContinue();
            }
        }
    }

    private void showAdminMenu() {
        while (true) {
            clearScreen();
            printTitle("管理员菜单");
            printlnColored(CYAN, "\n请选择操作：\n");
            
            printMenuItem(1, "管理电影信息");
            printMenuItem(2, "管理放映厅");
            printMenuItem(3, "管理场次");
            printMenuItem(4, "查看统计信息");
            printMenuItem(5, "管理用户");
            printMenuItem(6, "切换定价策略");
            printMenuItem(7, "浏览电影");
            printMenuItem(8, "查询场次");
            printMenuItem(9, "数据备份");
            printMenuItem(0, "退出登录");
            
            printColored(YELLOW, "\n请选择操作 (0-9): ");
            String choice = readLine();
            
            switch (choice) {
                case "1":
                    manageMovies();
                    break;
                case "2":
                    manageScreeningRooms();
                    break;
                case "3":
                    manageShows();
                    break;
                case "4":
                    viewStatistics();
                    break;
                case "5":
                    newMethods.manageUsers();
                    break;
                case "6":
                    switchPricingStrategy();
                    break;
                case "7":
                    browseMovies();
                    break;
                case "8":
                    searchShows();
                    break;
                case "9":
                    newMethods.backupData();
                    break;
                case "0":
                    return;
                default:
                    printError("无效选择，请输入0-9之间的数字");
                    pressEnterToContinue();
            }
        }
    }

    private void browseMovies() {
        clearScreen();
        printTitle("电影列表");
        
        List<Movie> movies = cinemaManager.getAllMovies();
        
        if (movies.isEmpty()) {
            printWarning("暂无电影信息");
            pressEnterToContinue();
            return;
        }
        
        for (int i = 0; i < movies.size(); i++) {
            Movie movie = movies.get(i);
            
            printSeparator('═', 60);
            printColored(GREEN + BOLD, String.format("%d. %s\n", i + 1, movie.getTitle()));
            
            printColored(CYAN, "   电影ID: ");
            printlnColored(WHITE, movie.getId());
            
            printColored(CYAN, "   导演: ");
            printlnColored(WHITE, movie.getDirector());
            
            printColored(CYAN, "   主演: ");
            printlnColored(WHITE, String.join(", ", movie.getActors()));
            
            printColored(CYAN, "   时长: ");
            printlnColored(WHITE, movie.getDuration() + "分钟");
            
            printColored(CYAN, "   评分: ");
            if (movie.getRating() >= 8.0) {
                printColored(GREEN + BOLD, String.format("%.1f", movie.getRating()));
            } else if (movie.getRating() >= 6.0) {
                printColored(YELLOW, String.format("%.1f", movie.getRating()));
            } else {
                printColored(RED, String.format("%.1f", movie.getRating()));
            }
            System.out.println();
            
            printColored(CYAN, "   类型: ");
            printlnColored(WHITE, movie.getGenre().getDescription());
            
            printColored(CYAN, "   上映日期: ");
            printlnColored(WHITE, movie.getReleaseTime().toString());
            
            printColored(CYAN, "   简介: ");
            printlnColored(WHITE, movie.getDescription());
            System.out.println();
        }
        
        printSeparator('═', 60);
        pressEnterToContinue();
    }

    private void searchShows() {
        clearScreen();
        printTitle("查询场次");
        
        printColored(CYAN, "请输入电影名称 (直接回车显示所有): ");
        String movieTitle = readLine();
        
        printColored(CYAN, "请输入日期 (YYYY-MM-DD，直接回车显示所有): ");
        String dateStr = readLine();
        
        LocalDate date = null;
        if (!dateStr.isEmpty()) {
            try {
                date = LocalDate.parse(dateStr);
            } catch (Exception e) {
                printWarning("日期格式错误，显示所有场次");
            }
        }
        
        List<Show> shows = cinemaManager.searchShows(movieTitle, date);
        
        if (shows.isEmpty()) {
            printWarning("未找到符合条件的场次");
            pressEnterToContinue();
            return;
        }
        
        printSeparator('═', 70);
        printColored(GREEN + BOLD, "找到 " + shows.size() + " 个场次:\n");
        
        for (int i = 0; i < shows.size(); i++) {
            Show show = shows.get(i);
            
            printSeparator('-', 50);
            printColored(GREEN + BOLD, String.format("场次 %d\n", i + 1));
            
            printColored(CYAN, "电影名称: ");
            printlnColored(WHITE, show.getMovieTitle());
            
            printColored(CYAN, "场次ID: ");
            printlnColored(WHITE, show.getId());
            
            printColored(CYAN, "放映厅: ");
            printlnColored(WHITE, show.getScreeningRoomName());
            
            printColored(CYAN, "开始时间: ");
            printlnColored(WHITE, show.getStartTime().format(DateTimeFormatter.ofPattern("yyyy-MM-dd HH:mm")));
            
            printColored(CYAN, "基础票价: ");
            printColored(YELLOW + BOLD, "￥" + show.getBasePrice());
            System.out.println();
            
            printColored(CYAN, "座位情况: ");
            int available = show.getAvailableSeatsCount();
            int total = show.getTotalSeats();
            if (available == 0) {
                printColored(RED, "已满座");
            } else if (available < total * 0.2) {
                printColored(YELLOW, available + "/" + total + " (座位紧张)");
            } else {
                printColored(GREEN, available + "/" + total + " (余票充足)");
            }
            System.out.println("\n");
        }
        
        printSeparator('═', 70);
        pressEnterToContinue();
    }

    private void purchaseTicket() {
        clearScreen();
        printTitle("购买电影票");
        
        // 获取所有场次并显示
        List<Show> shows = cinemaManager.getAllShows();
        
        if (shows.isEmpty()) {
            printWarning("暂无场次信息");
            pressEnterToContinue();
            return;
        }
        
        // 显示场次列表
        printSeparator('═', 80);
        printColored(GREEN + BOLD, "可用场次列表：\n");
        
        java.util.Map<String, Show> showMap = new java.util.HashMap<>();
        int index = 1;
        
        for (Show show : shows) {
            // 只显示未来的场次
            if (show.getStartTime().isAfter(java.time.LocalDateTime.now())) {
                printColored(CYAN, String.format("%d. ", index++));
                printColored(WHITE, show.getMovieTitle());
                printColored(CYAN, " - ");
                printColored(YELLOW, show.getScreeningRoomName());
                printColored(CYAN, " (");
                printColored(WHITE, show.getStartTime().format(DateTimeFormatter.ofPattern("yyyy-MM-dd HH:mm")));
                printColored(CYAN, ") | ");
                
                int available = show.getAvailableSeatsCount();
                int total = show.getTotalSeats();
                if (available == 0) {
                    printColored(RED, "已满座");
                } else if (available < total * 0.2) {
                    printColored(YELLOW, "可用座位: " + available + " (座位紧张)");
                } else {
                    printColored(GREEN, "可用座位: " + available);
                }
                System.out.println();
                
                showMap.put(String.valueOf(index - 1), show);
            }
        }
        
        if (showMap.isEmpty()) {
            printWarning("暂无可用场次");
            pressEnterToContinue();
            return;
        }
        
        printSeparator('═', 80);
        
        printColored(YELLOW, "\n请选择场次 (1-" + (index - 1) + "): ");
        String choice = readLine();
        
        Show show = showMap.get(choice);
        if (show == null) {
            printError("无效选择");
            pressEnterToContinue();
            return;
        }
        
        // 显示座位图
        displaySeatMap(show);
        
        System.out.print("请输入要购买的座位ID (多个座位用逗号分隔，格式: 行-列，如: 3-5,3-6): ");
        String seatIdsStr = readLine();
        
        if (seatIdsStr.isEmpty()) {
            System.out.println("未选择座位");
            return;
        }
        
        String[] seatIds = seatIdsStr.split(",");
        List<String> seatIdList = new java.util.ArrayList<>();
        for (String seatId : seatIds) {
            seatIdList.add(seatId.trim());
        }
        
        // 先检查过期订单
        bookingService.checkExpiredOrders();
        
        try {
            // 显示选项
            clearScreen();
            printTitle("确认订单");
            printlnColored(CYAN, "\n请选择操作：\n");
            
            printMenuItem(1, "立即支付");
            printMenuItem(2, "预定座位（15分钟内支付）");
            printMenuItem(0, "取消");
            
            printColored(YELLOW, "\n请选择操作: ");
            String actionChoice = readLine();
            
            Order order;
            
            switch (actionChoice) {
                case "1": // 立即支付
                    order = bookingService.createOrder(currentUser, show, seatIdList);
                    
                    System.out.println("\n----- 订单信息 -----");
                    printlnColored(CYAN, "订单ID: ");
                    printlnColored(WHITE, order.getOrderId());
                    printlnColored(CYAN, "电影: ");
                    printlnColored(WHITE, show.getMovieTitle());
                    printlnColored(CYAN, "场次时间: ");
                    printlnColored(WHITE, show.getStartTime().format(DateTimeFormatter.ofPattern("yyyy-MM-dd HH:mm")));
                    printlnColored(CYAN, "座位: ");
                    printlnColored(WHITE, order.getSeatIds());
                    printlnColored(CYAN, "总金额: ");
                    printColored(YELLOW + BOLD, "￥" + order.getTotalAmount());
                    System.out.println();
                    
                    printColored(YELLOW, "确认支付？(Y/N): ");
                    String confirm = readLine();
                    
                    if (confirm.equalsIgnoreCase("Y")) {
                        try {
                            bookingService.processPayment(order);
                            printSuccess("支付成功！订单已完成。");
                        } catch (PaymentFailedException e) {
                            printError("支付失败: " + e.getMessage());
                            printWarning("订单已取消，座位已释放");
                        }
                    } else {
                        try {
                            bookingService.cancelOrder(order);
                            printInfo("订单已取消");
                        } catch (InvalidBookingException e) {
                            printError("取消订单失败: " + e.getMessage());
                        }
                    }
                    break;
                    
                case "2": // 预定座位
                    order = bookingService.reserveOrder(currentUser, show, seatIdList);
                    
                    System.out.println("\n----- 预订成功 -----");
                    printlnColored(CYAN, "订单ID: ");
                    printlnColored(WHITE, order.getOrderId());
                    printlnColored(CYAN, "电影: ");
                    printlnColored(WHITE, show.getMovieTitle());
                    printlnColored(CYAN, "场次时间: ");
                    printlnColored(WHITE, show.getStartTime().format(DateTimeFormatter.ofPattern("yyyy-MM-dd HH:mm")));
                    printlnColored(CYAN, "座位: ");
                    printlnColored(WHITE, order.getSeatIds());
                    printlnColored(CYAN, "总金额: ");
                    printColored(YELLOW + BOLD, "￥" + order.getTotalAmount());
                    System.out.println();
                    
                    printWarning("座位已锁定，请在15分钟内完成支付！");
                    printInfo("锁定时间剩余: " + order.getRemainingLockMinutes() + " 分钟");
                    
                    printColored(YELLOW, "\n是否立即支付？(Y/N): ");
                    String payConfirm = readLine();
                    
                    if (payConfirm.equalsIgnoreCase("Y")) {
                        try {
                            bookingService.processReservedOrderPayment(order);
                            printSuccess("支付成功！订单已完成。");
                        } catch (PaymentFailedException e) {
                            printError("支付失败: " + e.getMessage());
                            printWarning("预订仍然有效，您可以在15分钟内再次支付");
                        } catch (InvalidBookingException e) {
                            printError("支付失败: " + e.getMessage());
                        }
                    } else {
                        printInfo("预订已创建，您可以在15分钟内通过'查看我的订单'完成支付");
                    }
                    break;
                    
                case "0": // 取消
                    printInfo("已取消购买");
                    return;
                    
                default:
                    printError("无效选择");
                    return;
            }

            
        } catch (SeatNotAvailableException e) {
            printError("座位预订失败: " + e.getMessage());
            printWarning("原因: " + e.getReason());
            printInfo("请选择其他座位");
        } catch (InvalidBookingException e) {
            printError("预订失败: " + e.getMessage());
            if (!e.getBookingDetails().isEmpty()) {
                printInfo("详情: " + e.getBookingDetails());
            }
        } catch (Exception e) {
            printError("购票失败: " + e.getMessage());
            e.printStackTrace();
        }
        
        pressEnterToContinue();
    }

    private void displaySeatMap(Show show) {
        printTitle("座位选择 - " + show.getMovieTitle());
        
        // 显示图例
        printlnColored(CYAN, "\n图例：");
        printColored(BLUE, "  [D] 优惠座位(第一排，80%价格)  ");
        printColored(PURPLE, "[V] VIP座位(中间3排，比普通座位贵10元)  ");
        printColored(GREEN, "[O] 普通座位  ");
        printColored(YELLOW, "[L] 已锁定  ");
        printlnColored(RED, "[X] 已售出");
        
        Seat[][] seats = show.getScreeningRoom().getSeatLayout();
        
        // 显示屏幕（放在顶部）
        int screenWidth = seats[0].length * 4 - 1; // 调整宽度以匹配座位显示
        printSeparator('═', screenWidth);
        String screenText = "银幕";
        int screenPadding = (screenWidth - screenText.length()) / 2;
        printlnColored(CYAN + BOLD, " ".repeat(screenPadding) + screenText);
        printSeparator('═', screenWidth);
        
        // 打印列号
        printColored(CYAN, "\n     ");
        for (int col = 1; col <= seats[0].length; col++) {
            printColored(CYAN, String.format("%3d", col)); // 使用3位数字对齐
        }
        System.out.println();
        
        // 打印座位
        for (int row = 0; row < seats.length; row++) {
            printColored(CYAN, String.format("  %2d ", row + 1));
            
            for (int col = 0; col < seats[row].length; col++) {
                Seat showSeat = show.getSeat(row + 1, col + 1);
                if (showSeat.isAvailable()) {
                    if (showSeat instanceof VIPSeat) {
                        printColored(PURPLE + BOLD, "[V] ");
                    } else if (showSeat instanceof DiscountSeat) {
                        printColored(BLUE, "[D] ");
                    } else {
                        printColored(GREEN, "[O] ");
                    }
                } else if (showSeat.isLocked()) {
                    printColored(YELLOW, "[L] ");
                } else {
                    printColored(RED, "[X] ");
                }
            }
            System.out.println();
        }
        
        // 显示价格说明
        printSeparator('-', 60);
        printlnColored(CYAN, "\n座位定价说明：");
        
        // 计算不同类型座位的价格
        double regularPrice = 0;
        double vipPrice = 0;
        double discountPrice = 0;
        
        for (Seat seat : show.getAvailableSeats()) {
            double price = bookingService.calculateSeatPrice(show, seat);
            if (seat instanceof VIPSeat && vipPrice == 0) {
                vipPrice = price;
            } else if (seat instanceof DiscountSeat && discountPrice == 0) {
                discountPrice = price;
            } else if (!(seat instanceof VIPSeat) && !(seat instanceof DiscountSeat) && regularPrice == 0) {
                regularPrice = price;
            }
            
            if (regularPrice > 0 && vipPrice > 0 && discountPrice > 0) {
                break;
            }
        }
        
        printColored(BLUE, "  [D] 优惠座位: ");
        printlnColored(YELLOW + BOLD, String.format("￥%.2f", discountPrice));
        
        printColored(PURPLE + BOLD, "  [V] VIP座位: ");
        printlnColored(YELLOW + BOLD, String.format("￥%.2f", vipPrice));
        
        printColored(GREEN, "  [O] 普通座位: ");
        printlnColored(YELLOW + BOLD, String.format("￥%.2f", regularPrice));
        
        printSeparator('-', 60);
        printInfo("请输入座位位置（格式：行-列，例如：1-1），多个座位用逗号分隔");
    }

    private void viewMyOrders() {
        clearScreen();
        printTitle("我的订单");
        
        // 先检查过期订单
        bookingService.checkExpiredOrders();
        
        List<Order> orders = currentUser.getOrders();
        
        if (orders.isEmpty()) {
            printWarning("暂无订单");
            pressEnterToContinue();
            return;
        }
        
        // 使用Set去重，避免重复显示
        java.util.Set<String> displayedOrderIds = new java.util.HashSet<>();
        int displayIndex = 1;
        java.util.Map<String, Order> reservableOrders = new java.util.HashMap<>();
        
        for (Order order : orders) {
            // 避免重复显示相同订单
            if (!displayedOrderIds.contains(order.getOrderId())) {
                displayedOrderIds.add(order.getOrderId());
                
                printSeparator('═', 80);
                printColored(GREEN + BOLD, String.format("订单 #%d\n", displayIndex++));
                
                printColored(CYAN, "订单编号: ");
                printlnColored(WHITE, order.getOrderId());
                
                printColored(CYAN, "电影名称: ");
                printlnColored(WHITE, order.getShow().getMovie().getTitle());
                
                printColored(CYAN, "放映时间: ");
                printlnColored(WHITE, order.getShow().getStartTime().format(DateTimeFormatter.ofPattern("yyyy-MM-dd HH:mm")));
                
                printColored(CYAN, "座位信息: ");
                StringBuilder seatInfo = new StringBuilder();
                for (Seat seat : order.getSeats()) {
                    if (seatInfo.length() > 0) seatInfo.append(", ");
                    seatInfo.append(seat.getSeatId());
                    if (seat instanceof VIPSeat) {
                        seatInfo.append("(VIP)");
                    }
                }
                printlnColored(WHITE, seatInfo.toString());
                
                printColored(CYAN, "创建时间: ");
                printlnColored(WHITE, order.getCreateTime().format(DateTimeFormatter.ofPattern("yyyy-MM-dd HH:mm:ss")));
                
                printColored(CYAN, "订单状态: ");
                switch (order.getStatus()) {
                    case PENDING:
                        printColored(YELLOW + BOLD, "待支付");
                        break;
                    case RESERVED:
                        printColored(ORANGE + BOLD, "已预订");
                        printColored(ORANGE, " (剩余" + order.getRemainingLockMinutes() + "分钟)");
                        reservableOrders.put(String.valueOf(displayIndex - 1), order);
                        break;
                    case PAID:
                        printColored(GREEN + BOLD, "已支付");
                        break;
                    case CANCELLED:
                        printColored(RED, "已取消");
                        break;
                    case REFUNDED:
                        printColored(PURPLE, "已退款");
                        break;
                    case EXPIRED:
                        printColored(RED + BOLD, "已过期");
                        break;
                }
                System.out.println();
                
                printColored(CYAN, "订单金额: ");
                printColored(YELLOW + BOLD, String.format("￥%.2f", order.getTotalAmount()));
                System.out.println("\n");
            }
        }
        
        printSeparator('═', 80);
        
        // 如果有可支付的预订订单，提供支付选项
        if (!reservableOrders.isEmpty()) {
            printlnColored(CYAN, "\n可支付的预订订单：");
            for (String index : reservableOrders.keySet()) {
                Order order = reservableOrders.get(index);
                printColored(GREEN, index + ". ");
                printlnColored(WHITE, order.getOrderId() + " - " + order.getShow().getMovie().getTitle());
            }
            
            printColored(YELLOW, "\n输入订单编号进行支付，或按回车键返回: ");
            String choice = readLine();
            
            if (!choice.isEmpty() && reservableOrders.containsKey(choice)) {
                Order selectedOrder = reservableOrders.get(choice);
                
                printSeparator('-', 60);
                printlnColored(CYAN, "订单详情：");
                printlnColored(CYAN, "订单号: " + selectedOrder.getOrderId());
                printlnColored(CYAN, "电影: " + selectedOrder.getShow().getMovie().getTitle());
                printlnColored(CYAN, "座位: " + selectedOrder.getSeatIds());
                printlnColored(CYAN, "金额: ");
                printColored(YELLOW + BOLD, "￥" + selectedOrder.getTotalAmount());
                printlnColored(ORANGE, "剩余锁定时间: " + selectedOrder.getRemainingLockMinutes() + " 分钟");
                
                printColored(YELLOW, "\n确认支付？(Y/N): ");
                String confirm = readLine();
                
                if (confirm.equalsIgnoreCase("Y")) {
                    try {
                        bookingService.processReservedOrderPayment(selectedOrder);
                        printSuccess("支付成功！订单已完成。");
                    } catch (PaymentFailedException e) {
                        printError("支付失败: " + e.getMessage());
                    } catch (InvalidBookingException e) {
                        printError("支付失败: " + e.getMessage());
                    }
                } else {
                    printInfo("支付已取消");
                }
            }
        }
        
        pressEnterToContinue();
    }

    private void refundTicket() {
        clearScreen();
        printTitle("退票");
        
        List<Order> userOrders = currentUser.getOrders();
        if (userOrders.isEmpty()) {
            printWarning("您没有可退票的订单");
            pressEnterToContinue();
            return;
        }
        
        // 显示可退票的订单
        printlnColored(CYAN, "\n您的订单列表：");
        printSeparator('═', 70);
        
        java.util.Set<String> displayedOrderIds = new java.util.HashSet<>();
        int displayIndex = 1;
        java.util.Map<String, Order> orderMap = new java.util.HashMap<>();
        
        for (Order order : userOrders) {
            if (!displayedOrderIds.contains(order.getOrderId()) && 
                (order.getStatus() == Order.OrderStatus.PAID || order.getStatus() == Order.OrderStatus.PENDING)) {
                displayedOrderIds.add(order.getOrderId());
                
                printColored(GREEN, String.format("%d. ", displayIndex));
                printColored(WHITE, order.getOrderId());
                printColored(CYAN, " - ");
                printlnColored(WHITE, order.getShow().getMovie().getTitle());
                
                printColored(CYAN, "   座位: ");
                StringBuilder seatInfo = new StringBuilder();
                for (Seat seat : order.getSeats()) {
                    if (seatInfo.length() > 0) seatInfo.append(", ");
                    seatInfo.append(seat.getSeatId());
                }
                printlnColored(WHITE, seatInfo.toString());
                
                printColored(CYAN, "   状态: ");
                switch (order.getStatus()) {
                    case PENDING:
                        printColored(YELLOW + BOLD, "待支付");
                        break;
                    case PAID:
                        printColored(GREEN + BOLD, "已支付");
                        break;
                }
                System.out.println();
                
                printColored(CYAN, "   金额: ");
                printColored(YELLOW + BOLD, String.format("￥%.2f", order.getTotalAmount()));
                System.out.println("\n");
                
                orderMap.put(String.valueOf(displayIndex), order);
                displayIndex++;
            }
        }
        
        printSeparator('═', 70);
        printColored(YELLOW, "请输入要退票的订单编号 (1-" + (displayIndex-1) + ") 或输入0返回: ");
        String choice = readLine();
        
        if ("0".equals(choice)) {
            return;
        }
        
        Order selectedOrder = orderMap.get(choice);
        if (selectedOrder == null) {
            printError("无效的订单编号");
            pressEnterToContinue();
            return;
        }
        
        // 确认退票
        printSeparator('-', 50);
        printColored(CYAN, "订单详情：\n");
        printColored(CYAN, "订单号: ");
        printlnColored(WHITE, selectedOrder.getOrderId());
        printColored(CYAN, "电影: ");
        printlnColored(WHITE, selectedOrder.getShow().getMovie().getTitle());
        printColored(CYAN, "座位: ");
        StringBuilder seatInfoDetail = new StringBuilder();
        for (Seat seat : selectedOrder.getSeats()) {
            if (seatInfoDetail.length() > 0) seatInfoDetail.append(", ");
            seatInfoDetail.append(seat.getSeatId());
        }
        printlnColored(WHITE, seatInfoDetail.toString());
        printColored(CYAN, "金额: ");
        printlnColored(YELLOW + BOLD, String.format("￥%.2f", selectedOrder.getTotalAmount()));
        
        printColored(YELLOW, "\n确认退票？(Y/N): ");
        String confirm = readLine();
        
        if (confirm.equalsIgnoreCase("Y")) {
            try {
                bookingService.cancelOrder(selectedOrder);
                printSuccess("退票成功！座位已释放，退款将在3-5个工作日内到账");
                pressEnterToContinue();
            } catch (InvalidBookingException e) {
                printError("退票失败: " + e.getMessage());
                pressEnterToContinue();
            }
        } else {
            printInfo("取消退票");
            pressEnterToContinue();
        }
    }

    private void switchPricingStrategy() {
        clearScreen();
        printTitle("定价策略管理");
        printlnColored(CYAN, "\n当前定价策略: " + 
            (bookingService.getPricingStrategy().getClass().getSimpleName().equals("StandardPricing") ? "标准定价" : "高级定价"));
        printlnColored(CYAN, "\n请选择新的定价策略：\n");
        
        printMenuItem(1, "标准定价 - 基础票价，无额外费用");
        printMenuItem(2, "高级定价 - VIP座位加价，时段差异化定价");
        printMenuItem(0, "返回");
        
        printColored(YELLOW, "\n请选择操作: ");
        String choice = readLine();
        
        switch (choice) {
            case "1":
                bookingService.setPricingStrategy(new com.cinema.strategy.StandardPricing());
                printSuccess("已切换到标准定价策略");
                printlnColored(CYAN, "所有座位将使用基础票价");
                break;
            case "2":
                bookingService.setPricingStrategy(new com.cinema.strategy.PremiumPricing());
                printSuccess("已切换到高级定价策略");
                printlnColored(CYAN, "VIP座位将加价20%，高峰时段票价上浮10%");
                break;
            case "0":
                return;
            default:
                printError("无效选择");
        }
        
        pressEnterToContinue();
    }

    private void manageMovies() {
        System.out.println("\n----- 管理电影信息 -----");
        System.out.println("1. 添加电影");
        System.out.println("2. 删除电影");
        System.out.println("3. 查看所有电影");
        System.out.print("请选择操作: ");
        
        String choice = readLine();
        
        switch (choice) {
            case "1":
                addMovie();
                break;
            case "2":
                removeMovie();
                break;
            case "3":
                browseMovies();
                break;
            default:
                System.out.println("无效选择");
        }
    }

    private void addMovie() {
        System.out.println("\n----- 添加电影 -----");
        System.out.print("请输入电影ID: ");
        String id = readLine();
        
        if (cinemaManager.getMovie(id) != null) {
            System.out.println("电影ID已存在");
            return;
        }
        
        System.out.print("请输入电影名称: ");
        String title = readLine();
        
        System.out.print("请输入导演: ");
        String director = readLine();
        
        System.out.print("请输入主演 (用逗号分隔): ");
        String actorsStr = readLine();
        List<String> actors = List.of(actorsStr.split(","));
        
        // 输入时长（带验证）
        int duration = 0;
        while (true) {
            try {
                System.out.print("请输入时长 (分钟): ");
                duration = Integer.parseInt(readLine());
                if (duration <= 0) {
                    System.out.println("时长必须大于0");
                    continue;
                }
                break;
            } catch (NumberFormatException e) {
                System.out.println("请输入有效的数字");
            }
        }
        
        // 输入评分（带验证）
        double rating = 0;
        while (true) {
            try {
                System.out.print("请输入评分 (0-10): ");
                rating = Double.parseDouble(readLine());
                if (rating < 0 || rating > 10) {
                    System.out.println("评分必须在0-10之间");
                    continue;
                }
                break;
            } catch (NumberFormatException e) {
                System.out.println("请输入有效的数字");
            }
        }
        
        System.out.print("请输入类型: ");
        String genre = readLine();
        
        System.out.print("请输入简介: ");
        String description = readLine();
        
        // 输入上映日期（带验证）
        LocalDate releaseTime = null;
        while (true) {
            try {
                System.out.print("请输入上映日期 (YYYY-MM-DD): ");
                String dateStr = readLine();
                releaseTime = LocalDate.parse(dateStr);
                // 检查日期是否是未来的日期
                if (releaseTime.isAfter(LocalDate.now().plusYears(1))) {
                    System.out.println("上映日期不能超过一年后");
                    continue;
                }
                break;
            } catch (Exception e) {
                System.out.println("日期格式错误，请使用YYYY-MM-DD格式，例如：2023-12-07");
            }
        }
        
        Movie movie = new Movie(id, title, releaseTime, actors, director, duration, rating, description, genre);
        cinemaManager.addMovie(movie);
        
        System.out.println("电影添加成功");
    }

    private void removeMovie() {
        System.out.println("\n----- 删除电影 -----");
        browseMovies();
        
        System.out.print("请输入要删除的电影ID: ");
        String movieId = readLine();
        
        if (cinemaManager.getMovie(movieId) == null) {
            System.out.println("电影不存在");
            return;
        }
        
        System.out.print("确认删除电影？(Y/N): ");
        String confirm = readLine();
        
        if (confirm.equalsIgnoreCase("Y")) {
            cinemaManager.removeMovie(movieId);
            System.out.println("电影删除成功");
        } else {
            System.out.println("取消删除");
        }
    }

    private void manageScreeningRooms() {
        System.out.println("\n----- 管理放映厅 -----");
        System.out.println("1. 添加放映厅");
        System.out.println("2. 删除放映厅");
        System.out.println("3. 查看所有放映厅");
        System.out.print("请选择操作: ");
        
        String choice = readLine();
        
        switch (choice) {
            case "1":
                addScreeningRoom();
                break;
            case "2":
                removeScreeningRoom();
                break;
            case "3":
                viewScreeningRooms();
                break;
            default:
                System.out.println("无效选择");
        }
    }

    private void addScreeningRoom() {
        System.out.println("\n----- 添加放映厅 -----");
        System.out.print("请输入放映厅ID: ");
        String id = readLine();
        
        if (cinemaManager.getScreeningRoom(id) != null) {
            System.out.println("放映厅ID已存在");
            return;
        }
        
        System.out.print("请输入放映厅名称: ");
        String name = readLine();
        
        System.out.print("请输入行数: ");
        int rows = Integer.parseInt(readLine());
        
        System.out.print("请输入列数: ");
        int cols = Integer.parseInt(readLine());
        
        ScreeningRoom room = new ScreeningRoom(id, name, rows, cols);
        cinemaManager.addScreeningRoom(room);
        
        System.out.println("放映厅添加成功");
    }

    private void removeScreeningRoom() {
        System.out.println("\n----- 删除放映厅 -----");
        viewScreeningRooms();
        
        System.out.print("请输入要删除的放映厅ID: ");
        String roomId = readLine();
        
        if (cinemaManager.getScreeningRoom(roomId) == null) {
            System.out.println("放映厅不存在");
            return;
        }
        
        System.out.print("确认删除放映厅？(Y/N): ");
        String confirm = readLine();
        
        if (confirm.equalsIgnoreCase("Y")) {
            cinemaManager.removeScreeningRoom(roomId);
            System.out.println("放映厅删除成功");
        } else {
            System.out.println("取消删除");
        }
    }

    private void viewScreeningRooms() {
        clearScreen();
        printTitle("放映厅列表");
        
        List<ScreeningRoom> rooms = cinemaManager.getAllScreeningRooms();
        
        if (rooms.isEmpty()) {
            printWarning("暂无放映厅信息");
            pressEnterToContinue();
            return;
        }
        
        for (int i = 0; i < rooms.size(); i++) {
            ScreeningRoom room = rooms.get(i);
            
            printSeparator('═', 60);
            printColored(GREEN + BOLD, String.format("%d. %s\n", i + 1, room.getName()));
            
            printColored(CYAN, "   放映厅ID: ");
            printlnColored(WHITE, room.getId());
            
            printColored(CYAN, "   座位布局: ");
            printlnColored(WHITE, room.getRows() + " 行 × " + room.getColumns() + " 列");
            
            printColored(CYAN, "   总座位数: ");
            printlnColored(WHITE, String.valueOf(room.getTotalSeats()));
            
            printColored(CYAN, "   VIP座位: ");
            printlnColored(PURPLE, String.valueOf(room.getVipSeatsCount()));
            
            printColored(CYAN, "   普通座位: ");
            printlnColored(WHITE, String.valueOf(room.getRegularSeatsCount()));
            System.out.println();
        }
        
        printSeparator('═', 60);
        pressEnterToContinue();
    }

    private void manageShows() {
        System.out.println("\n----- 管理场次 -----");
        System.out.println("1. 添加场次");
        System.out.println("2. 删除场次");
        System.out.println("3. 查看所有场次");
        System.out.print("请选择操作: ");
        
        String choice = readLine();
        
        switch (choice) {
            case "1":
                addShow();
                break;
            case "2":
                removeShow();
                break;
            case "3":
                searchShows();
                break;
            default:
                System.out.println("无效选择");
        }
    }

    private void addShow() {
        System.out.println("\n----- 添加场次 -----");
        browseMovies();
        
        System.out.print("请输入电影ID: ");
        String movieId = readLine();
        
        Movie movie = cinemaManager.getMovie(movieId);
        if (movie == null) {
            System.out.println("电影不存在");
            return;
        }
        
        viewScreeningRooms();
        
        System.out.print("请输入放映厅ID: ");
        String roomId = readLine();
        
        ScreeningRoom room = cinemaManager.getScreeningRoom(roomId);
        if (room == null) {
            System.out.println("放映厅不存在");
            return;
        }
        
        System.out.print("请输入开始时间 (YYYY-MM-DD HH:MM): ");
        LocalDateTime startTime = LocalDateTime.parse(readLine(), DateTimeFormatter.ofPattern("yyyy-MM-dd HH:mm"));
        
        System.out.print("请输入基础票价: ");
        double basePrice = Double.parseDouble(readLine());
        
        Show show = new Show("SHOW-" + System.currentTimeMillis(), movie, room, startTime, basePrice);
        cinemaManager.addShow(show);
        
        System.out.println("场次添加成功");
    }

    private void removeShow() {
        System.out.println("\n----- 删除场次 -----");
        searchShows();
        
        System.out.print("请输入要删除的场次ID: ");
        String showId = readLine();
        
        if (cinemaManager.getShow(showId) == null) {
            System.out.println("场次不存在");
            return;
        }
        
        System.out.print("确认删除场次？(Y/N): ");
        String confirm = readLine();
        
        if (confirm.equalsIgnoreCase("Y")) {
            cinemaManager.removeShow(showId);
            System.out.println("场次删除成功");
        } else {
            System.out.println("取消删除");
        }
    }

    private void viewStatistics() {
        clearScreen();
        printTitle("统计信息");
        
        List<Movie> movies = cinemaManager.getAllMovies();
        List<ScreeningRoom> rooms = cinemaManager.getAllScreeningRooms();
        List<Show> shows = cinemaManager.getAllShows();
        List<User> users = cinemaManager.getAllUsers();
        List<Order> orders = bookingService.getAllOrders();
        
        printSeparator('═', 60);
        printColored(GREEN + BOLD, "系统资源统计\n");
        
        printColored(CYAN, "电影总数: ");
        printlnColored(WHITE, String.valueOf(movies.size()));
        
        printColored(CYAN, "放映厅总数: ");
        printlnColored(WHITE, String.valueOf(rooms.size()));
        
        printColored(CYAN, "场次总数: ");
        printlnColored(WHITE, String.valueOf(shows.size()));
        
        printColored(CYAN, "注册用户: ");
        printlnColored(WHITE, String.valueOf(users.size()));
        
        printColored(CYAN, "订单总数: ");
        printlnColored(WHITE, String.valueOf(orders.size()));
        
        printSeparator('-', 60);
        printColored(GREEN + BOLD, "业务统计\n");
        
        int paidOrders = 0;
        int pendingOrders = 0;
        int cancelledOrders = 0;
        double totalRevenue = 0.0;
        
        for (Order order : orders) {
            switch (order.getStatus()) {
                case PAID:
                    paidOrders++;
                    totalRevenue += order.getTotalAmount();
                    break;
                case PENDING:
                    pendingOrders++;
                    break;
                case CANCELLED:
                    cancelledOrders++;
                    break;
                case REFUNDED:
                    cancelledOrders++;
                    break;
            }
        }
        
        printColored(CYAN, "已支付订单: ");
        printlnColored(GREEN, String.valueOf(paidOrders));
        
        printColored(CYAN, "待支付订单: ");
        printlnColored(YELLOW, String.valueOf(pendingOrders));
        
        printColored(CYAN, "已取消订单: ");
        printlnColored(RED, String.valueOf(cancelledOrders));
        
        printSeparator('-', 60);
        printColored(GREEN + BOLD, "收入统计\n");
        
        printColored(CYAN, "总收入: ");
        printColored(YELLOW + BOLD, "￥" + String.format("%.2f", totalRevenue));
        System.out.println();
        
        if (paidOrders > 0) {
            double avgOrderValue = totalRevenue / paidOrders;
            printColored(CYAN, "平均订单金额: ");
            printlnColored(WHITE, "￥" + String.format("%.2f", avgOrderValue));
        }
        
        double orderRate = orders.size() > 0 ? (double) paidOrders / orders.size() * 100 : 0;
        printColored(CYAN, "订单完成率: ");
        if (orderRate >= 70) {
            printColored(GREEN + BOLD, String.format("%.1f%%", orderRate));
        } else if (orderRate >= 50) {
            printColored(YELLOW, String.format("%.1f%%", orderRate));
        } else {
            printColored(RED, String.format("%.1f%%", orderRate));
        }
        System.out.println();
        
        printSeparator('═', 60);
        pressEnterToContinue();
    }
}

//File: NewMethods.java
package com.cinema.ui;

import com.cinema.model.*;
import com.cinema.service.CinemaManager;
import com.cinema.service.BookingService;

import java.util.List;
import java.util.Scanner;

public class NewMethods {
    private final CinemaManager cinemaManager;
    private final BookingService bookingService;
    private final Scanner scanner;
    private User currentUser;

    public NewMethods(CinemaManager cinemaManager, BookingService bookingService, Scanner scanner, User currentUser) {
        this.cinemaManager = cinemaManager;
        this.bookingService = bookingService;
        this.scanner = scanner;
        this.currentUser = currentUser;
    }

    public void editProfile() {
        System.out.println("\n----- 修改个人信息 -----");
        System.out.println("当前用户信息:");
        System.out.println("ID: " + currentUser.getId());
        System.out.println("姓名: " + currentUser.getName());
        System.out.println("电话: " + currentUser.getPhone());
        System.out.println("邮箱: " + currentUser.getEmail());
        System.out.println("角色: " + (currentUser.isAdmin() ? "管理员" : "普通用户"));
        
        System.out.println("\n请选择要修改的信息:");
        System.out.println("1. 姓名");
        System.out.println("2. 电话");
        System.out.println("3. 邮箱");
        System.out.println("0. 返回");
        System.out.print("请选择: ");
        
        String choice = scanner.nextLine().trim();
        
        switch (choice) {
            case "1":
                System.out.print("请输入新姓名: ");
                String newName = scanner.nextLine().trim();
                if (!newName.isEmpty()) {
                    currentUser.setName(newName);
                    cinemaManager.saveAllData();
                    System.out.println("姓名修改成功");
                }
                break;
            case "2":
                System.out.print("请输入新电话: ");
                String newPhone = scanner.nextLine().trim();
                if (!newPhone.isEmpty() && newPhone.matches("^1[3-9]\\d{9}$")) {
                    currentUser.setPhone(newPhone);
                    cinemaManager.saveAllData();
                    System.out.println("电话修改成功");
                } else {
                    System.out.println("电话格式错误");
                }
                break;
            case "3":
                System.out.print("请输入新邮箱: ");
                String newEmail = scanner.nextLine().trim();
                if (!newEmail.isEmpty() && newEmail.matches("^[A-Za-z0-9+_.-]+@[A-Za-z0-9.-]+$")) {
                    currentUser.setEmail(newEmail);
                    cinemaManager.saveAllData();
                    System.out.println("邮箱修改成功");
                } else {
                    System.out.println("邮箱格式错误");
                }
                break;
            case "0":
                break;
            default:
                System.out.println("无效选择");
        }
    }

    public void manageUsers() {
        while (true) {
            System.out.println("\n----- 用户管理 -----");
            System.out.println("1. 查看所有用户");
            System.out.println("2. 删除用户");
            System.out.println("3. 修改用户角色");
            System.out.println("0. 返回");
            System.out.print("请选择操作: ");
            
            String choice = scanner.nextLine().trim();
            
            switch (choice) {
                case "1":
                    viewAllUsers();
                    break;
                case "2":
                    deleteUser();
                    break;
                case "3":
                    changeUserRole();
                    break;
                case "0":
                    return;
                default:
                    System.out.println("无效选择");
            }
        }
    }

    private void viewAllUsers() {
        System.out.println("\n----- 用户列表 -----");
        List<User> users = cinemaManager.getAllUsers();
        
        if (users.isEmpty()) {
            System.out.println("暂无用户");
            return;
        }
        
        for (int i = 0; i < users.size(); i++) {
            User user = users.get(i);
            System.out.println((i + 1) + ". " + user.toString());
            System.out.println();
        }
    }

    private void deleteUser() {
        viewAllUsers();
        
        System.out.print("请输入要删除的用户ID: ");
        String userId = scanner.nextLine().trim();
        
        if (userId.equals(currentUser.getId())) {
            System.out.println("不能删除当前登录用户");
            return;
        }
        
        User user = cinemaManager.getUser(userId);
        if (user == null) {
            System.out.println("用户不存在");
            return;
        }
        
        System.out.println("用户信息: " + user.toString());
        System.out.print("确认删除用户？(Y/N): ");
        String confirm = scanner.nextLine().trim();
        
        if (confirm.equalsIgnoreCase("Y")) {
            // 检查用户是否有未完成的订单
            List<Order> userOrders = bookingService.getAllOrders().stream()
                .filter(order -> order.getUser() != null && order.getUser().getId().equals(userId))
                .filter(order -> order.getStatus() == Order.OrderStatus.PAID)
                .collect(java.util.stream.Collectors.toList());
                
            if (!userOrders.isEmpty()) {
                System.out.println("警告：该用户有 " + userOrders.size() + " 个已支付订单");
                System.out.print("仍要删除？(Y/N): ");
                String finalConfirm = scanner.nextLine().trim();
                if (!finalConfirm.equalsIgnoreCase("Y")) {
                    System.out.println("取消删除");
                    return;
                }
            }
            
            cinemaManager.removeUser(userId);
            System.out.println("用户删除成功");
        } else {
            System.out.println("取消删除");
        }
    }

    private void changeUserRole() {
        viewAllUsers();
        
        System.out.print("请输入要修改角色的用户ID: ");
        String userId = scanner.nextLine().trim();
        
        User user = cinemaManager.getUser(userId);
        if (user == null) {
            System.out.println("用户不存在");
            return;
        }
        
        if (userId.equals(currentUser.getId())) {
            System.out.println("不能修改当前登录用户的角色");
            return;
        }
        
        System.out.println("用户当前角色: " + (user.isAdmin() ? "管理员" : "普通用户"));
        System.out.print("修改为管理员？(Y/N): ");
        String choice = scanner.nextLine().trim();
        
        boolean newIsAdmin = choice.equalsIgnoreCase("Y");
        User.UserRole newRole = newIsAdmin ? User.UserRole.ADMIN : User.UserRole.CUSTOMER;
        
        user.setRole(newRole);
        cinemaManager.saveAllData();
        
        System.out.println("角色修改成功，新角色: " + (newIsAdmin ? "管理员" : "普通用户"));
    }

    public void backupData() {
        System.out.println("\n----- 数据备份 -----");
        System.out.print("确认备份数据？(Y/N): ");
        String confirm = scanner.nextLine().trim();
        
        if (confirm.equalsIgnoreCase("Y")) {
            cinemaManager.backupData();
        } else {
            System.out.println("取消备份");
        }
    }

    public void logout() {
        System.out.println("\n----- 退出登录 -----");
        cinemaManager.saveAllData();
        System.out.println("数据已保存");
        System.out.println("再见，" + currentUser.getName() + "！");
        currentUser = null;
    }
}

//File: DebugUserData.java
package com.cinema;

import com.cinema.service.CinemaManager;
import com.cinema.model.User;
import java.util.Map;

public class DebugUserData {
    public static void main(String[] args) {
        System.out.println("===== 调试用户数据加载 =====");

        CinemaManager cinemaManager = CinemaManager.getInstance();

        // 检查用户Map是否为空
        Map<String, User> users = cinemaManager.getAllUsers()
                .stream()
                .collect(java.util.stream.Collectors.toMap(User::getId, user -> user));

        System.out.println("用户总数: " + users.size());

        // 查找管理员用户
        User admin = cinemaManager.getUser("ADMIN-001");
        System.out.println("管理员用户存在: " + (admin != null));

        if (admin != null) {
            System.out.println("管理员详情:");
            System.out.println("  ID: " + admin.getId());
            System.out.println("  姓名: " + admin.getName());
            System.out.println("  电话: " + admin.getPhone());
            System.out.println("  邮箱: " + admin.getEmail());
            System.out.println("  角色: " + admin.getRole());
        }

        // 列出所有用户
        System.out.println("\n所有用户:");
        for (User user : cinemaManager.getAllUsers()) {
            System.out.println("  - " + user.getId() + " (" + user.getName() + ")");
        }

        // 如果没有管理员用户，重新创建一个
        if (admin == null) {
            System.out.println("\n重新创建管理员用户...");
            // --- 🔴 修复点：添加了 "admin123" 作为密码参数 ---
            User newAdmin = new User(
                    "ADMIN-001",
                    "管理员",
                    "admin123",       // password (新增的参数)
                    "13800138000",    // phone
                    "admin@cinema.com", // email
                    User.UserRole.ADMIN // role
            );}}}
            // ---------------------------------------------

//File: FullReset.java
package com.cinema;

import com.cinema.model.*;
import com.cinema.service.CinemaManager;
import com.cinema.service.BookingService;
import com.cinema.strategy.StandardPricing;
import com.cinema.storage.SimpleDataStorage;

import java.time.LocalDate;
import java.time.LocalDateTime;
import java.util.List;

/**
 * 完全重置程序 - 清空所有订单、场次和放映厅，保留用户和电影
 */
public class FullReset {
    public static void main(String[] args) {
        System.out.println("开始完全重置数据...");
        
        // 获取管理器实例
        CinemaManager cinemaManager = CinemaManager.getInstance();
        BookingService bookingService = BookingService.getInstance(new StandardPricing());
        SimpleDataStorage dataStorage = new SimpleDataStorage();
        
        // 1. 保存所有用户
        System.out.println("保存用户数据...");
        List<User> users = cinemaManager.getAllUsers();
        
        // 清空所有用户的订单
        for (User user : users) {
            user.getOrders().clear();
        }
        System.out.println("保存了 " + users.size() + " 个用户账号，已清空其订单");
        
        // 2. 保存所有电影
        System.out.println("保存电影数据...");
        List<Movie> movies = cinemaManager.getAllMovies();
        System.out.println("保存了 " + movies.size() + " 部电影");
        
        // 3. 清空所有数据
        System.out.println("清空所有数据...");
        bookingService.getAllOrders().clear();
        cinemaManager.getAllShows().clear();
        cinemaManager.getAllScreeningRooms().clear();
        
        // 4. 重新创建放映厅（统一使用标准布局）
        System.out.println("创建新的放映厅...");
        createStandardScreeningRooms(cinemaManager);
        
        // 5. 更新电影放映日期并创建新场次
        System.out.println("创建新的场次...");
        createNewShows(cinemaManager);
        
        // 6. 保存所有数据
        System.out.println("保存数据...");
        cinemaManager.saveAllData();
        bookingService.saveOrders();
        
        System.out.println("\n数据重置完成！");
        System.out.println("用户账号: " + users.size() + " 个（已保留，订单已清空）");
        System.out.println("电影: " + movies.size() + " 部（已保留）");
        System.out.println("放映厅: " + cinemaManager.getAllScreeningRooms().size() + " 个（已重新创建）");
        System.out.println("场次: " + cinemaManager.getAllShows().size() + " 个（已重新创建）");
        System.out.println("订单: " + bookingService.getAllOrders().size() + " 个（已清空）");
    }
    
    private static void createStandardScreeningRooms(CinemaManager cinemaManager) {
        // 创建标准放映厅，所有厅都使用相同的座位布局规则
        ScreeningRoom room1 = new ScreeningRoom("ROOM-1", "1号厅", 8, 12);
        ScreeningRoom room2 = new ScreeningRoom("ROOM-2", "2号厅", 10, 15);
        ScreeningRoom room3 = new ScreeningRoom("ROOM-3", "3号厅", 12, 18);
        ScreeningRoom room4 = new ScreeningRoom("ROOM-4", "4号厅", 8, 10);
        
        cinemaManager.addScreeningRoom(room1);
        cinemaManager.addScreeningRoom(room2);
        cinemaManager.addScreeningRoom(room3);
        cinemaManager.addScreeningRoom(room4);
        
        System.out.println("  - 1号厅: 8排×12列");
        System.out.println("  - 2号厅: 10排×15列");
        System.out.println("  - 3号厅: 12排×18列");
        System.out.println("  - 4号厅: 8排×10列");
    }
    
    private static void createNewShows(CinemaManager cinemaManager) {
        List<Movie> movies = cinemaManager.getAllMovies();
        List<ScreeningRoom> rooms = cinemaManager.getAllScreeningRooms();
        
        if (movies.isEmpty() || rooms.isEmpty()) {
            System.out.println("警告: 没有电影或放映厅，无法创建场次");
            return;
        }
        
        LocalDateTime now = LocalDateTime.now();
        
        int showIndex = 1;
        
        // 为每部电影创建多个场次
        for (int movieIndex = 0; movieIndex < movies.size(); movieIndex++) {
            Movie movie = movies.get(movieIndex);
            
            // 每部电影创建6-8个场次
            int showsPerMovie = 6 + (movieIndex % 3);
            
            for (int i = 0; i < showsPerMovie; i++) {
                // 选择放映厅（轮换使用）
                ScreeningRoom room = rooms.get((movieIndex + i) % rooms.size());
                
                // 计算放映时间（从今天开始的未来几天）
                int daysFromNow = (movieIndex * 2 + i / 3) % 14 + 1; // 1-14天后
                int hourOfDay = 9 + (i % 4) * 4; // 9:00, 13:00, 17:00, 21:00
                
                LocalDateTime showTime = LocalDateTime.of(
                    now.plusDays(daysFromNow).toLocalDate(),
                    java.time.LocalTime.of(hourOfDay, 0)
                );
                
                // 创建场次
                Show show = new Show(
                    "SHOW-" + String.format("%03d", showIndex++),
                    movie,
                    room,
                    showTime,
                    50.0 // 基础价格50元
                );
                
                cinemaManager.addShow(show);
            }
        }
    }
}

//File: InitializeSystem.java
package com.cinema;

import com.cinema.model.*;
import com.cinema.service.CinemaManager;
import com.cinema.service.BookingService;
import com.cinema.strategy.StandardPricing;

import java.time.LocalDate;
import java.time.LocalDateTime;
import java.util.Arrays;
import java.util.List;

public class InitializeSystem {
    public static void main(String[] args) {
        System.out.println("初始化电影院系统...\n");

        CinemaManager cinemaManager = CinemaManager.getInstance();
        BookingService bookingService = BookingService.getInstance(new StandardPricing());

        // 1. 创建用户（保留原有用户）
        System.out.println("1. 创建用户账号");
        createUsers(cinemaManager);

        // ... (中间的 createMovies, createScreeningRooms 等代码不需要改，保持原样即可) ...
        System.out.println("\n2. 创建电影");
        createMovies(cinemaManager);
        System.out.println("\n3. 创建放映厅");
        createScreeningRooms(cinemaManager);
        System.out.println("\n4. 创建场次");
        createShows(cinemaManager);

        // 5. 保存数据
        System.out.println("\n5. 保存数据");
        cinemaManager.saveAllData();
        bookingService.saveOrders();

        System.out.println("\n系统初始化完成！");
    }

    private static void createUsers(CinemaManager cinemaManager) {
        // [修改点]：这里给所有 new User() 都加了第3个参数：密码 "123456" 或 "admin123"

        // 管理员
        User admin = new User(
                "ADMIN-001",
                "系统管理员",
                "admin123",  // <--- 新增密码
                "13800138000",
                "admin@cinema.com",
                User.UserRole.ADMIN
        );
        cinemaManager.addUser(admin);
        System.out.println("  - 创建管理员: " + admin.getId());

        // 普通用户
        User user = new User(
                "renquan",
                "renquan",
                "123456",    // <--- 新增密码
                "13900139000",
                "renquan@example.com",
                User.UserRole.CUSTOMER
        );
        cinemaManager.addUser(user);
        System.out.println("  - 创建用户: " + user.getId());

        // 测试用户
        User testUser = new User(
                "test",
                "测试用户",
                "123456",    // <--- 新增密码
                "13700137000",
                "test@example.com",
                User.UserRole.CUSTOMER
        );
        cinemaManager.addUser(testUser);
        System.out.println("  - 创建用户: " + testUser.getId());
    }

    // ... 下面的 createMovies, createScreeningRooms, createShows 方法保持之前的代码不变 ...
    // 为了节省篇幅，这里不重复粘贴未修改的部分，请保留你原来的代码
    private static void createMovies(CinemaManager cm) { /* 保持原样 */ }
    private static void createScreeningRooms(CinemaManager cm) { /* 保持原样 */ }
    private static void createShows(CinemaManager cm) { /* 保持原样 */ }
}

//File: ResetData.java
package com.cinema;

import com.cinema.model.*;
import com.cinema.service.CinemaManager;
import com.cinema.service.BookingService;
import com.cinema.strategy.StandardPricing;
import com.cinema.storage.SimpleDataStorage;

import java.time.LocalDate;
import java.time.LocalDateTime;
import java.util.Arrays;
import java.util.List;

/**
 * 数据重置程序 - 清空所有订单和场次，保留用户账号
 * 更新电影放映日期为未来日期，重新创建放映厅和场次
 */
public class ResetData {
    public static void main(String[] args) {
        System.out.println("开始重置数据...");
        
        // 获取管理器实例
        CinemaManager cinemaManager = CinemaManager.getInstance();
        BookingService bookingService = BookingService.getInstance(new StandardPricing());
        
        // 1. 保存所有用户
        System.out.println("保存用户数据...");
        List<User> users = cinemaManager.getAllUsers();
        System.out.println("保存了 " + users.size() + " 个用户账号");
        
        // 2. 保存所有电影
        System.out.println("保存电影数据...");
        List<Movie> movies = cinemaManager.getAllMovies();
        System.out.println("保存了 " + movies.size() + " 部电影");
        
        // 3. 清空所有订单
        System.out.println("清空所有订单...");
        bookingService.getAllOrders().clear();
        bookingService.saveOrders();
        
        // 清空用户的订单列表
        for (User user : users) {
            user.getOrders().clear();
        }
        
        // 4. 清空所有场次
        System.out.println("清空所有场次...");
        cinemaManager.getAllShows().clear();
        
        // 5. 清空所有放映厅
        System.out.println("清空所有放映厅...");
        cinemaManager.getAllScreeningRooms().clear();
        
        // 6. 重新创建放映厅（使用新的座位布局）
        System.out.println("创建新的放映厅...");
        createScreeningRooms(cinemaManager);
        
        // 7. 更新电影放映日期并创建新场次
        System.out.println("创建新的场次...");
        createShows(cinemaManager);
        
        // 8. 保存所有数据
        System.out.println("保存数据...");
        cinemaManager.saveAllData();
        bookingService.saveOrders();
        
        System.out.println("数据重置完成！");
        System.out.println("用户账号: " + users.size() + " 个（已保留）");
        System.out.println("电影: " + movies.size() + " 部（已保留）");
        System.out.println("放映厅: " + cinemaManager.getAllScreeningRooms().size() + " 个（已重新创建）");
        System.out.println("场次: " + cinemaManager.getAllShows().size() + " 个（已重新创建）");
        System.out.println("订单: 0 个（已清空）");
    }
    
    private static void createScreeningRooms(CinemaManager cinemaManager) {
        // 创建多个不同大小的放映厅
        ScreeningRoom room1 = new ScreeningRoom("ROOM-1", "1号厅（小厅）", 8, 12);
        ScreeningRoom room2 = new ScreeningRoom("ROOM-2", "2号厅（中厅）", 10, 15);
        ScreeningRoom room3 = new ScreeningRoom("ROOM-3", "3号厅（大厅）", 12, 18);
        ScreeningRoom room4 = new ScreeningRoom("ROOM-4", "4号厅（VIP厅）", 8, 10);
        
        cinemaManager.addScreeningRoom(room1);
        cinemaManager.addScreeningRoom(room2);
        cinemaManager.addScreeningRoom(room3);
        cinemaManager.addScreeningRoom(room4);
        
        System.out.println("  - 1号厅: 8排×12列 (96座位)");
        System.out.println("  - 2号厅: 10排×15列 (150座位)");
        System.out.println("  - 3号厅: 12排×18列 (216座位)");
        System.out.println("  - 4号厅: 8排×10列 (80座位，VIP专享)");
    }
    
    private static void createShows(CinemaManager cinemaManager) {
        List<Movie> movies = cinemaManager.getAllMovies();
        List<ScreeningRoom> rooms = cinemaManager.getAllScreeningRooms();
        
        if (movies.isEmpty() || rooms.isEmpty()) {
            System.out.println("警告: 没有电影或放映厅，无法创建场次");
            return;
        }
        
        LocalDateTime now = LocalDateTime.now();
        LocalDateTime baseTime = LocalDateTime.of(now.getYear(), now.getMonth(), 
                                                  now.getDayOfMonth(), 9, 0);
        
        int showIndex = 1;
        
        // 为每部电影创建多个场次，分布在不同的放映厅和时间段
        for (int movieIndex = 0; movieIndex < movies.size(); movieIndex++) {
            Movie movie = movies.get(movieIndex);
            
            // 每部电影创建6-8个场次
            int showsPerMovie = 6 + (movieIndex % 3);
            
            for (int i = 0; i < showsPerMovie; i++) {
                // 选择放映厅（轮换使用）
                ScreeningRoom room = rooms.get((movieIndex + i) % rooms.size());
                
                // 计算放映时间（从今天开始的未来几天）
                int daysFromNow = (movieIndex * 2 + i / 3) % 7 + 1; // 1-7天后
                int timeSlot = i % 5; // 0-4个时间段
                
                LocalDateTime showTime = baseTime
                    .plusDays(daysFromNow)
                    .plusHours(timeSlot * 3 + 9); // 9:00, 12:00, 15:00, 18:00, 21:00
                
                // 创建场次
                Show show = new Show(
                    "SHOW-" + String.format("%03d", showIndex++),
                    movie,
                    room,
                    showTime,
                    50.0 // 基础价格50元
                );
                
                cinemaManager.addShow(show);
                
                System.out.println(String.format("  - 场次 %s: %s @ %s (%s)", 
                    show.getId(), 
                    movie.getTitle(), 
                    showTime.format(java.time.format.DateTimeFormatter.ofPattern("MM-dd HH:mm")),
                    room.getName()));
            }
        }
    }
}

//File: TestAdminUser.java
package com.cinema;

import com.cinema.service.CinemaManager;
import com.cinema.model.User;

public class TestAdminUser {
    public static void main(String[] args) {
        CinemaManager cinemaManager = CinemaManager.getInstance();
        
        System.out.println("===== 测试管理员用户 =====");
        
        // 检查管理员用户是否存在
        User admin = cinemaManager.getUser("ADMIN-001");
        
        if (admin != null) {
            System.out.println("管理员用户存在:");
            System.out.println("ID: " + admin.getId());
            System.out.println("姓名: " + admin.getName());
            System.out.println("电话: " + admin.getPhone());
            System.out.println("邮箱: " + admin.getEmail());
            System.out.println("角色: " + (admin.isAdmin() ? "管理员" : "普通用户"));
        } else {
            System.out.println("管理员用户不存在!");
            
            // 如果管理员用户不存在，手动创建一个
            User newAdmin = new User(
                "ADMIN-001",
                "管理员",
                "13800138000",
                "admin@cinema.com",
                User.UserRole.ADMIN
            );
            cinemaManager.addUser(newAdmin);
            System.out.println("已创建新的管理员用户");
        }
        
        // 显示所有用户
        System.out.println("\n所有用户列表:");
        for (User user : cinemaManager.getAllUsers()) {
            System.out.println("- " + user.getId() + " (" + user.getName() + ") - " + 
                (user.isAdmin() ? "管理员" : "普通用户"));
        }
    }
}

//File: TestAdminViewRooms.java
package com.cinema;

import com.cinema.model.ScreeningRoom;
import com.cinema.service.CinemaManager;
import com.cinema.ui.ConsoleUI;

import java.io.ByteArrayInputStream;
import java.io.InputStream;
import java.util.List;

public class TestAdminViewRooms {
    public static void main(String[] args) {
        // 模拟管理员登录
        String adminInput = "ADMIN-001\n";  // 输入管理员ID
        InputStream in = new ByteArrayInputStream(adminInput.getBytes());
        System.setIn(in);
        
        CinemaManager cinemaManager = CinemaManager.getInstance();
        ConsoleUI ui = new ConsoleUI();
        
        System.out.println("===== 测试管理员查看放映厅功能 =====");
        
        // 获取所有放映厅
        List<ScreeningRoom> rooms = cinemaManager.getAllScreeningRooms();
        
        if (rooms.isEmpty()) {
            System.out.println("暂无放映厅信息");
        } else {
            // 使用ConsoleUI的美化方法显示
            System.out.println("\n╔════════════════════════════════════════════════════════════╗");
            System.out.println("║                        放映厅列表                        ║");
            System.out.println("╚════════════════════════════════════════════════════════════╝");
            
            for (int i = 0; i < rooms.size(); i++) {
                ScreeningRoom room = rooms.get(i);
                
                System.out.println("════════════════════════════════════════════════════════════");
                System.out.printf("\u001B[32m\u001B[1m%d. %s\u001B[0m\n", i + 1, room.getName());
                
                System.out.println("   \u001B[36m放映厅ID: \u001B[0m" + room.getId());
                System.out.println("   \u001B[36m座位布局: \u001B[0m" + room.getRows() + " 行 × " + room.getColumns() + " 列");
                System.out.println("   \u001B[36m总座位数: \u001B[0m" + room.getTotalSeats());
                System.out.println("   \u001B[36mVIP座位: \u001B[0m\u001B[35m" + room.getVipSeatsCount() + "\u001B[0m");
                System.out.println("   \u001B[36m普通座位: \u001B[0m" + room.getRegularSeatsCount());
                System.out.println();
            }
            
            System.out.println("════════════════════════════════════════════════════════════");
        }
        
        System.out.println("测试完成！管理员现在可以正常查看放映厅信息了。");
    }
}

//File: TestCompleteSystem.java
package com.cinema;

import com.cinema.model.*;
import com.cinema.service.*;
import com.cinema.strategy.StandardPricing;
import java.time.LocalDate;
import java.time.LocalDateTime;
import java.util.List;

public class TestCompleteSystem {
    public static void main(String[] args) {
        // 创建影院管理器
        CinemaManager cinemaManager = CinemaManager.getInstance();

        // 创建放映厅
        ScreeningRoom room = new ScreeningRoom("ROOM-1", "测试放映厅", 10, 15);
        cinemaManager.addScreeningRoom(room);

        // --- 🔴 修复点开始 ---
        // 创建电影 (注意参数顺序和类型调整)
        Movie movie = new Movie(
                "MOV-001",           // id
                "测试电影",           // title
                LocalDate.now(),     // releaseTime (这里需要 LocalDate)
                List.of("演员1", "演员2"), // actors (这里需要 List<String>)
                "测试导演",           // director
                120,                 // duration
                8.5,                 // rating
                "测试描述",           // description
                MovieGenre.ACTION    // genre
        );
        // --- 🔴 修复点结束 ---

        cinemaManager.addMovie(movie);

        // 创建场次
        Show show = new Show("SHOW-001", movie, room,
                LocalDateTime.now().plusDays(1), 50.0);
        cinemaManager.addShow(show);

        // 创建预订服务
        BookingService bookingService = BookingService.getInstance(new StandardPricing());

        // 测试座位布局
        System.out.println("=== 座位布局测试 ===");
        Seat[][] seats = show.getScreeningRoom().getSeatLayout();

        // 打印座位布局
        System.out.println("\n座位图:");
        for (int row = 0; row < seats.length; row++) {
            for (int col = 0; col < seats[row].length; col++) {
                Seat seat = seats[row][col];
                if (seat instanceof VIPSeat) {
                    System.out.print("[V] ");
                } else if (seat instanceof DiscountSeat) {
                    System.out.print("[D] ");
                } else {
                    System.out.print("[O] ");
                }
            }
            System.out.println();
        }

        // 测试价格计算
        System.out.println("\n=== 价格测试 ===");
        Seat discountSeat = seats[0][0]; // 第一排
        Seat regularSeat = seats[1][0];  // 第二排
        Seat vipSeat = seats[4][0];      // 第五排（中间排）

        double discountPrice = bookingService.calculateSeatPrice(show, discountSeat);
        double regularPrice = bookingService.calculateSeatPrice(show, regularSeat);
        double vipPrice = bookingService.calculateSeatPrice(show, vipSeat);

        System.out.println("优惠座位(第一排): ￥" + discountPrice);
        System.out.println("普通座位(第二排): ￥" + regularPrice);
        System.out.println("VIP座位(第五排): ￥" + vipPrice);

        // 验证价格比例
        System.out.println("\n=== 价格比例验证 ===");
        System.out.println("优惠座位/普通座位: " + (discountPrice / regularPrice) + " (期望: 0.8)");
        System.out.println("VIP座位/普通座位: " + (vipPrice / regularPrice) + " (期望: 2.0)");

        // 统计各类座位数量
        int discountCount = 0, vipCount = 0, regularCount = 0;
        for (int row = 0; row < seats.length; row++) {
            for (int col = 0; col < seats[row].length; col++) {
                Seat seat = seats[row][col];
                if (seat instanceof VIPSeat) {
                    vipCount++;
                } else if (seat instanceof DiscountSeat) {
                    discountCount++;
                } else {
                    regularCount++;
                }
            }
        }

        System.out.println("\n=== 座位统计 ===");
        System.out.println("优惠座位数量: " + discountCount + " (期望: " + room.getTotalCols() + ")");
        System.out.println("VIP座位数量: " + vipCount + " (期望: " + (room.getTotalCols() * 3) + ")");
        System.out.println("普通座位数量: " + regularCount);
    }
}

//File: TestInitialization.java
package com.cinema;

import com.cinema.service.CinemaManager;
import com.cinema.service.BookingService;
import com.cinema.strategy.StandardPricing;
import com.cinema.model.User;

public class TestInitialization {
    public static void main(String[] args) {
        System.out.println("===== 测试系统初始化 =====");
        
        // 先初始化BookingService
        BookingService bookingService = BookingService.getInstance(new StandardPricing());
        
        // 创建新的CinemaManager实例会触发初始化
        CinemaManager cinemaManager = CinemaManager.getInstance();
        
        System.out.println("初始化完成");
        
        // 检查管理员用户
        User admin = cinemaManager.getUser("ADMIN-001");
        System.out.println("管理员用户存在: " + (admin != null));
        
        // 强制保存所有数据
        System.out.println("保存所有数据...");
        cinemaManager.saveAllData();
        System.out.println("数据保存完成");
    }
}

//File: TestLogin.java
package com.cinema;

import com.cinema.service.CinemaManager;
import com.cinema.model.User;
import java.io.ByteArrayInputStream;
import java.io.InputStream;

public class TestLogin {
    public static void main(String[] args) {
        // 模拟输入管理员ID
        String input = "ADMIN-001\n";
        InputStream in = new ByteArrayInputStream(input.getBytes());
        System.setIn(in);
        
        CinemaManager cinemaManager = CinemaManager.getInstance();
        
        System.out.println("===== 测试管理员登录 =====");
        
        // 模拟登录逻辑
        String userId = "ADMIN-001";
        User user = cinemaManager.getUser(userId);
        
        if (user != null) {
            System.out.println("✓ 登录成功！欢迎，" + user.getName());
            if (user.isAdmin()) {
                System.out.println("当前角色: 管理员");
            } else {
                System.out.println("当前角色: 普通用户");
            }
        } else {
            System.out.println("✗ 用户不存在，请先注册");
        }
    }
}

//File: TestMenuChanges.java
package com.cinema;

import com.cinema.service.CinemaManager;
import com.cinema.service.BookingService;
import com.cinema.strategy.StandardPricing;
import com.cinema.strategy.PremiumPricing;
import com.cinema.model.User;

public class TestMenuChanges {
    public static void main(String[] args) {
        System.out.println("===== 测试菜单更改 =====");
        
        // 初始化服务
        BookingService bookingService = BookingService.getInstance(new StandardPricing());
        CinemaManager cinemaManager = CinemaManager.getInstance();
        
        // 测试定价策略切换
        System.out.println("\n1. 测试定价策略切换");
        System.out.println("当前策略: " + bookingService.getPricingStrategy().getClass().getSimpleName());
        
        bookingService.setPricingStrategy(new PremiumPricing());
        System.out.println("切换后策略: " + bookingService.getPricingStrategy().getClass().getSimpleName());
        
        bookingService.setPricingStrategy(new StandardPricing());
        System.out.println("再次切换后: " + bookingService.getPricingStrategy().getClass().getSimpleName());
        
        // 测试用户角色验证
        System.out.println("\n2. 测试用户角色验证");
        User admin = cinemaManager.getUser("ADMIN-001");
        if (admin != null) {
            System.out.println("管理员用户: " + admin.getName() + " (角色: " + admin.getRole() + ")");
            System.out.println("是否为管理员: " + admin.isAdmin());
        }
        
        System.out.println("\n测试完成！");
    }
}

//File: TestNewFeatures.java
package com.cinema;

import com.cinema.service.CinemaManager;
import com.cinema.service.BookingService;
import com.cinema.strategy.StandardPricing;
import com.cinema.model.User;
import com.cinema.model.Order;
import com.cinema.model.Show;
import java.util.List;

public class TestNewFeatures {
    public static void main(String[] args) {
        System.out.println("===== 测试新功能 =====\n");
        
        // 初始化服务
        BookingService bookingService = BookingService.getInstance(new StandardPricing());
        CinemaManager cinemaManager = CinemaManager.getInstance();
        
        // 获取管理员用户
        User admin = cinemaManager.getUser("ADMIN-001");
        if (admin == null) {
            System.out.println("管理员用户不存在");
            return;
        }
        
        // 测试1: 检查场次列表
        System.out.println("1. 测试场次列表显示");
        List<Show> shows = cinemaManager.getAllShows();
        System.out.println("可用场次数量: " + shows.size());
        for (int i = 0; i < Math.min(3, shows.size()); i++) {
            Show show = shows.get(i);
            System.out.println("  " + (i + 1) + ". " + show.getMovie().getTitle() + 
                " - " + show.getScreeningRoom().getName() + 
                " (" + show.getStartTime() + ") | 可用座位: " + show.getAvailableSeatsCount());
        }
        
        // 测试2: 检查订单状态
        System.out.println("\n2. 测试订单状态");
        List<Order> orders = admin.getOrders();
        System.out.println("订单数量: " + orders.size());
        for (Order order : orders) {
            System.out.println("  订单 " + order.getOrderId() + " - 状态: " + order.getStatus());
            if (order.getStatus() == Order.OrderStatus.RESERVED) {
                System.out.println("    剩余锁定时间: " + order.getRemainingLockMinutes() + " 分钟");
                System.out.println("    是否过期: " + order.isExpired());
            }
        }
        
        // 测试3: 检查过期订单处理
        System.out.println("\n3. 测试过期订单处理");
        bookingService.checkExpiredOrders();
        System.out.println("过期订单检查完成");
        
        System.out.println("\n测试完成！");
    }
}

//File: TestScreeningRooms.java
package com.cinema;

import com.cinema.model.ScreeningRoom;
import com.cinema.service.CinemaManager;

public class TestScreeningRooms {
    public static void main(String[] args) {
        CinemaManager cinemaManager = CinemaManager.getInstance();
        
        System.out.println("===== 测试放映厅查看功能 =====");
        
        // 获取所有放映厅
        var rooms = cinemaManager.getAllScreeningRooms();
        
        if (rooms.isEmpty()) {
            System.out.println("暂无放映厅信息");
        } else {
            for (int i = 0; i < rooms.size(); i++) {
                ScreeningRoom room = rooms.get(i);
                System.out.println("============================================================");
                System.out.printf("%d. %s%n", i + 1, room.getName());
                System.out.println("   放映厅ID: " + room.getId());
                System.out.println("   座位布局: " + room.getRows() + " 行 × " + room.getColumns() + " 列");
                System.out.println("   总座位数: " + room.getTotalSeats());
                System.out.println("   VIP座位: " + room.getVipSeatsCount());
                System.out.println("   普通座位: " + room.getRegularSeatsCount());
                System.out.println();
            }
            System.out.println("============================================================");
        }
        
        System.out.println("测试完成！");
    }
}

//File: TestSeatLayout.java
package com.cinema;

import com.cinema.model.*;
import com.cinema.service.CinemaManager;

public class TestSeatLayout {
    public static void main(String[] args) {
        // 创建一个10排15列的放映厅
        ScreeningRoom room = new ScreeningRoom("ROOM-1", "测试放映厅", 10, 15);
        
        System.out.println("座位布局测试:");
        System.out.println("总排数: " + room.getTotalRows());
        System.out.println("总列数: " + room.getTotalCols());
        System.out.println();
        
        Seat[][] seats = room.getSeatLayout();
        
        // 打印座位布局
        for (int row = 0; row < seats.length; row++) {
            for (int col = 0; col < seats[row].length; col++) {
                Seat seat = seats[row][col];
                if (seat instanceof VIPSeat) {
                    System.out.print("[V] ");
                } else if (seat instanceof DiscountSeat) {
                    System.out.print("[D] ");
                } else {
                    System.out.print("[O] ");
                }
            }
            System.out.println();
        }
        
        System.out.println("\n座位价格:");
        // 检查第一排（优惠座位）
        Seat firstRowSeat = seats[0][0];
        System.out.println("第一排座位类型: " + firstRowSeat.getClass().getSimpleName());
        System.out.println("第一排座位价格: ￥" + firstRowSeat.getBasePrice());
        
        // 检查中间排（VIP座位）
        int middleRow = room.getTotalRows() / 2;
        Seat vipSeat = seats[middleRow][0];
        System.out.println("\n中间排(第" + (middleRow + 1) + "排)座位类型: " + vipSeat.getClass().getSimpleName());
        System.out.println("中间排座位价格: ￥" + vipSeat.getBasePrice());
        
        // 检查其他排（普通座位）
        Seat regularSeat = seats[room.getTotalRows() - 1][0];
        System.out.println("\n最后一排座位类型: " + regularSeat.getClass().getSimpleName());
        System.out.println("最后一排座位价格: ￥" + regularSeat.getBasePrice());
    }
}

//File: TestSeatPricing.java
package com.cinema;

import com.cinema.service.CinemaManager;
import com.cinema.service.BookingService;
import com.cinema.strategy.StandardPricing;
import com.cinema.model.User;
import com.cinema.model.Show;
import com.cinema.model.ScreeningRoom;
import java.util.List;

public class TestSeatPricing {
    public static void main(String[] args) {
        System.out.println("===== 测试座位定价 =====\n");
        
        // 初始化服务
        BookingService bookingService = BookingService.getInstance(new StandardPricing());
        CinemaManager cinemaManager = CinemaManager.getInstance();
        
        // 获取管理员用户
        User admin = cinemaManager.getUser("ADMIN-001");
        if (admin == null) {
            System.out.println("管理员用户不存在");
            return;
        }
        
        // 测试1: 检查放映厅座位价格
        System.out.println("1. 检查放映厅座位价格");
        List<ScreeningRoom> rooms = cinemaManager.getAllScreeningRooms();
        for (ScreeningRoom room : rooms) {
            System.out.println("\n放映厅: " + room.getName());
            System.out.println("  第1排座位类型: " + room.getSeatLayout()[0][0].getClass().getSimpleName());
            System.out.println("  第1排座位价格: ￥" + room.getSeatLayout()[0][0].getBasePrice());
            
            int midRow = room.getRows() / 2;
            System.out.println("  中间排座位类型: " + room.getSeatLayout()[midRow][0].getClass().getSimpleName());
            System.out.println("  中间排座位价格: ￥" + room.getSeatLayout()[midRow][0].getBasePrice());
            
            int lastRow = room.getRows() - 1;
            System.out.println("   最后一排座位类型: " + room.getSeatLayout()[lastRow][0].getClass().getSimpleName());
            System.out.println("   最后一排座位价格: ￥" + room.getSeatLayout()[lastRow][0].getBasePrice());
        }
        
        // 测试2: 测试场次定价计算
        System.out.println("\n2. 测试场次定价计算");
        List<Show> shows = cinemaManager.getAllShows();
        if (!shows.isEmpty()) {
            Show show = shows.get(0);
            System.out.println("\n场次: " + show.getMovie().getTitle());
            System.out.println("  放映厅: " + show.getScreeningRoom().getName());
            
            // 测试不同座位类型的价格
            for (int row = 0; row < Math.min(3, show.getScreeningRoom().getRows()); row++) {
                for (int col = 0; col < Math.min(3, show.getScreeningRoom().getColumns()); col++) {
                    var seat = show.getSeat(row + 1, col + 1);
                    System.out.printf("  座位 %s: %s - ￥%.2f\n", 
                        seat.getSeatId(), 
                        seat.getClass().getSimpleName(), 
                        bookingService.calculateSeatPrice(show, seat));
                }
            }
        }
        
        System.out.println("\n测试完成！");
    }
}

//File: TestSeatTypes.java
package com.cinema;

import com.cinema.service.CinemaManager;
import com.cinema.service.BookingService;
import com.cinema.strategy.StandardPricing;
import com.cinema.model.User;
import com.cinema.model.Show;
import com.cinema.model.ScreeningRoom;
import com.cinema.model.Order;
import java.util.List;

public class TestSeatTypes {
    public static void main(String[] args) {
        System.out.println("===== 测试座位类型和预订功能 =====\n");
        
        // 初始化服务
        BookingService bookingService = BookingService.getInstance(new StandardPricing());
        CinemaManager cinemaManager = CinemaManager.getInstance();
        
        // 获取管理员用户
        User admin = cinemaManager.getUser("ADMIN-001");
        if (admin == null) {
            System.out.println("管理员用户不存在");
            return;
        }
        
        // 测试1: 检查座位类型分布
        System.out.println("1. 测试座位类型分布");
        List<ScreeningRoom> rooms = cinemaManager.getAllScreeningRooms();
        for (ScreeningRoom room : rooms) {
            System.out.println("\n放映厅: " + room.getName());
            System.out.println("  总座位数: " + room.getTotalSeats());
            System.out.println("  VIP座位数: " + room.getVipSeatsCount());
            System.out.println("  普通座位数: " + room.getRegularSeatsCount());
            
            // 计算优惠座位数（第一排）
            int discountSeats = room.getColumns();
            System.out.println("  优惠座位数: " + discountSeats + " (第一排)");
        }
        
        // 测试2: 测试预订功能
        System.out.println("\n2. 测试预订功能");
        List<Show> shows = cinemaManager.getAllShows();
        if (!shows.isEmpty()) {
            Show show = shows.get(0);
            System.out.println("选择场次: " + show.getMovie().getTitle());
            
            // 尝试预订座位
            try {
                Order order = bookingService.reserveOrder(admin, show, List.of("1-1", "1-2"));
                System.out.println("预订成功!");
                System.out.println("订单ID: " + order.getOrderId());
                System.out.println("订单状态: " + order.getStatus());
                System.out.println("剩余锁定时间: " + order.getRemainingLockMinutes() + " 分钟");
                
                // 测试支付预订订单
                bookingService.processReservedOrderPayment(order);
                System.out.println("支付成功！订单状态: " + order.getStatus());
                
            } catch (Exception e) {
                System.out.println("预订失败: " + e.getMessage());
            }
        }
        
        // 测试3: 检查过期订单
        System.out.println("\n3. 测试过期订单处理");
        bookingService.checkExpiredOrders();
        System.out.println("过期订单检查完成");
        
        System.out.println("\n测试完成！");
    }
}

//File: TestSimpleSystem.java
package com.cinema;

import com.cinema.model.*;
import com.cinema.service.*;
import com.cinema.strategy.StandardPricing;
import java.time.LocalDate;
import java.time.LocalDateTime;
import java.util.Arrays;

public class TestSimpleSystem {
    public static void main(String[] args) {
        // 创建放映厅
        ScreeningRoom room = new ScreeningRoom("ROOM-1", "测试放映厅", 10, 15);
        
        // 创建电影
        Movie movie = new Movie("MOV-001", "测试电影", LocalDate.now(), 
                               Arrays.asList("演员1", "演员2"), "测试导演", 120, 8.5, 
                               "测试描述", MovieGenre.ACTION);
        
        // 创建场次
        Show show = new Show("SHOW-001", movie, room, 
                           LocalDateTime.now().plusDays(1), 50.0);
        
        // 创建预订服务
        BookingService bookingService = BookingService.getInstance(new StandardPricing());
        
        // 测试座位布局
        System.out.println("=== 座位布局测试 ===");
        Seat[][] seats = show.getScreeningRoom().getSeatLayout();
        
        // 打印座位布局
        System.out.println("\n座位图:");
        for (int row = 0; row < seats.length; row++) {
            for (int col = 0; col < seats[row].length; col++) {
                Seat seat = seats[row][col];
                if (seat instanceof VIPSeat) {
                    System.out.print("[V] ");
                } else if (seat instanceof DiscountSeat) {
                    System.out.print("[D] ");
                } else {
                    System.out.print("[O] ");
                }
            }
            System.out.println();
        }
        
        // 测试价格计算
        System.out.println("\n=== 价格测试 ===");
        Seat discountSeat = seats[0][0]; // 第一排
        Seat regularSeat = seats[1][0];  // 第二排
        Seat vipSeat = seats[4][0];      // 第五排（中间排）
        
        double discountPrice = bookingService.calculateSeatPrice(show, discountSeat);
        double regularPrice = bookingService.calculateSeatPrice(show, regularSeat);
        double vipPrice = bookingService.calculateSeatPrice(show, vipSeat);
        
        System.out.println("优惠座位(第一排): ￥" + discountPrice);
        System.out.println("普通座位(第二排): ￥" + regularPrice);
        System.out.println("VIP座位(第五排): ￥" + vipPrice);
        
        // 验证价格比例
        System.out.println("\n=== 价格比例验证 ===");
        System.out.println("优惠座位/普通座位: " + (discountPrice / regularPrice) + " (期望: 0.8)");
        System.out.println("VIP座位/普通座位: " + (vipPrice / regularPrice) + " (期望: 2.0)");
        
        // 统计各类座位数量
        int discountCount = 0, vipCount = 0, regularCount = 0;
        for (int row = 0; row < seats.length; row++) {
            for (int col = 0; col < seats[row].length; col++) {
                Seat seat = seats[row][col];
                if (seat instanceof VIPSeat) {
                    vipCount++;
                } else if (seat instanceof DiscountSeat) {
                    discountCount++;
                } else {
                    regularCount++;
                }
            }
        }
        
        System.out.println("\n=== 座位统计 ===");
        System.out.println("优惠座位数量: " + discountCount + " (期望: " + room.getTotalCols() + ")");
        System.out.println("VIP座位数量: " + vipCount + " (期望: " + (room.getTotalCols() * 3) + ")");
        System.out.println("普通座位数量: " + regularCount);
    }
}

//File: TestTitleAlignment.java
package com.cinema;

import com.cinema.ui.ConsoleUI;

public class TestTitleAlignment {
    public static void main(String[] args) {
        System.out.println("===== 测试标题框对齐 =====\n");
        
        ConsoleUI ui = new ConsoleUI();
        
        // 测试不同长度的标题
        String[] titles = {
            "短",
            "中等长度标题",
            "这是一个比较长的标题用来测试对齐效果",
            "管理员菜单",
            "用户登录系统"
        };
        
        for (String title : titles) {
            System.out.println("标题: \"" + title + "\" (长度: " + title.length() + ")");
            // 使用反射调用私有方法
            try {
                java.lang.reflect.Method method = ConsoleUI.class.getDeclaredMethod("printTitle", String.class);
                method.setAccessible(true);
                method.invoke(ui, title);
                method.setAccessible(false);
            } catch (Exception e) {
                System.err.println("无法调用printTitle方法: " + e.getMessage());
            }
            System.out.println();
        }
        
        System.out.println("测试完成！");
    }
}

//File: TestUIAlignment.java
package com.cinema;

import com.cinema.ui.ConsoleUI;
import com.cinema.service.CinemaManager;
import com.cinema.service.BookingService;
import com.cinema.strategy.StandardPricing;

public class TestUIAlignment {
    public static void main(String[] args) {
        System.out.println("===== 测试UI对齐问题 =====\n");
        
        // 初始化服务
        BookingService bookingService = BookingService.getInstance(new StandardPricing());
        CinemaManager cinemaManager = CinemaManager.getInstance();
        ConsoleUI ui = new ConsoleUI();
        
        // 测试不同宽度的分隔线
        System.out.println("1. 测试不同宽度的分隔线:");
        int[] lengths = {30, 50, 60, 70};
        for (int length : lengths) {
            System.out.println("长度 " + length + ":");
            try {
                java.lang.reflect.Method method = ConsoleUI.class.getDeclaredMethod("printSeparator", char.class, int.class);
                method.setAccessible(true);
                method.invoke(ui, ' ', length);
                method.setAccessible(false);
            } catch (Exception e) {
                System.err.println("无法调用printSeparator方法: " + e.getMessage());
            }
            System.out.println();
        }
        
        // 测试不同长度的标题
        System.out.println("\n2. 测试不同长度的标题:");
        String[] titles = {
            "登录",
            "用户登录系统",
            "这是一个非常长的标题用来测试对齐效果是否正确"
        };
        for (String title : titles) {
            System.out.println("标题: \"" + title + "\"");
            try {
                java.lang.reflect.Method method = ConsoleUI.class.getDeclaredMethod("printTitle", String.class);
                method.setAccessible(true);
                method.invoke(ui, title);
                method.setAccessible(false);
            } catch (Exception e) {
                System.err.println("无法调用printTitle方法: " + e.getMessage());
            }
            System.out.println();
        }
        
        // 测试菜单项
        System.out.println("\n3. 测试菜单项:");
        try {
            java.lang.reflect.Method method = ConsoleUI.class.getDeclaredMethod("printMenuItem", int.class, String.class);
            method.setAccessible(true);
            method.invoke(ui, 1, "浏览电影");
            method.invoke(ui, 2, "查询场次");
            method.invoke(ui, 3, "这是一个非常长的菜单项用来测试对齐");
            method.setAccessible(false);
        } catch (Exception e) {
            System.err.println("无法调用printMenuItem方法: " + e.getMessage());
        }
        
        System.out.println("\n测试完成！");
    }
}

//File: TestUIFixes.java
package com.cinema;

public class TestUIFixes {
    public static void main(String[] args) {
        // ANSI颜色代码
        String CYAN = "\u001B[36m";
        String YELLOW = "\u001B[33m";
        String BOLD = "\u001B[1m";
        String RESET = "\u001B[0m";
        
        // 界面装饰符号
        String LINE = "═";
        String CORNER_TL = "╔";
        String CORNER_TR = "╗";
        String CORNER_BL = "╚";
        String CORNER_BR = "╝";
        String VERTICAL = "║";
        
        // 测试标题框对齐
        System.out.println("=== 测试标题框对齐 ===");
        String title = "电影院购票系统";
        int width = Math.max(title.length() + 10, 60);
        String border = LINE.repeat(width);
        
        int padding = (width - title.length()) / 2;
        int leftPadding = padding;
        int rightPadding = width - title.length() - leftPadding;
        
        String titleLine = VERTICAL + " ".repeat(leftPadding) + title + " ".repeat(rightPadding) + VERTICAL;
        
        System.out.print(CYAN + CORNER_TL + border + CORNER_TR);
        System.out.println();
        System.out.print(CYAN + YELLOW + BOLD + titleLine);
        System.out.println();
        System.out.print(CYAN + CORNER_BL + border + CORNER_BR);
        System.out.println();
        System.out.println();
        
        // 测试价格显示
        System.out.println("=== 测试价格显示（无括号说明） ===");
        
        // 模拟价格显示
        String CYAN = "\u001B[36m";
        String YELLOW = "\u001B[33m";
        String BOLD = "\u001B[1m";
        String BLUE = "\u001B[34m";
        String PURPLE = "\u001B[35m";
        String GREEN = "\u001B[32m";
        String RESET = "\u001B[0m";
        
        System.out.print(BLUE + "  [D] 优惠座位: " + RESET);
        System.out.println(YELLOW + BOLD + "￥46.00" + RESET);
        
        System.out.print(PURPLE + BOLD + "  [V] VIP座位: " + RESET);
        System.out.println(YELLOW + BOLD + "￥69.00" + RESET);
        
        System.out.print(GREEN + "  [O] 普通座位: " + RESET);
        System.out.println(YELLOW + BOLD + "￥57.50" + RESET);
    }
}

//File: VerifyReset.java
package com.cinema;

import com.cinema.model.*;
import com.cinema.service.CinemaManager;
import com.cinema.service.BookingService;
import com.cinema.strategy.StandardPricing;

public class VerifyReset {
    public static void main(String[] args) {
        System.out.println("=== 验证数据重置结果 ===\n");
        
        CinemaManager cinemaManager = CinemaManager.getInstance();
        BookingService bookingService = BookingService.getInstance(new StandardPricing());
        
        // 1. 验证用户
        System.out.println("1. 用户账号:");
        for (User user : cinemaManager.getAllUsers()) {
            System.out.println("   - " + user.getId() + " (" + user.getName() + ") " + 
                             (user.isAdmin() ? "[管理员]" : "[普通用户]"));
            System.out.println("     订单数: " + user.getOrders().size());
        }
        
        // 2. 验证放映厅和座位布局
        System.out.println("\n2. 放映厅座位布局:");
        for (ScreeningRoom room : cinemaManager.getAllScreeningRooms()) {
            System.out.println("\n" + room.getName() + " (" + room.getLayout() + "):");
            Seat[][] seats = room.getSeatLayout();
            
            // 统计各类座位
            int discountCount = 0, vipCount = 0, regularCount = 0;
            
            // 打印座位图（只打印前5排和后5排的缩略）
            for (int row = 0; row < seats.length; row++) {
                if (row == 5 && seats.length > 10) {
                    System.out.println("   ...");
                    row = seats.length - 5;
                }
                
                System.out.printf("   第%2d排: ", row + 1);
                for (int col = 0; col < Math.min(seats[row].length, 10); col++) {
                    Seat seat = seats[row][col];
                    if (seat instanceof VIPSeat) {
                        System.out.print("[V]");
                        vipCount++;
                    } else if (seat instanceof DiscountSeat) {
                        System.out.print("[D]");
                        discountCount++;
                    } else {
                        System.out.print("[O]");
                        regularCount++;
                    }
                }
                if (seats[row].length > 10) {
                    System.out.print("...");
                }
                System.out.println();
            }
            
            System.out.println("   座位统计: 优惠=" + discountCount + ", VIP=" + vipCount + 
                             ", 普通=" + regularCount);
        }
        
        // 3. 验证场次
        System.out.println("\n3. 场次信息:");
        for (Show show : cinemaManager.getAllShows()) {
            System.out.println("   - " + show.getId() + ": " + 
                             show.getMovie().getTitle() + " @ " + 
                             show.getStartTime().format(java.time.format.DateTimeFormatter.ofPattern("MM-dd HH:mm")) +
                             " (" + show.getScreeningRoom().getName() + ")");
            System.out.println("     座位: " + show.getAvailableSeatsCount() + "/" + 
                             show.getTotalSeats() + " 可用");
        }
        
        // 4. 验证价格计算
        System.out.println("\n4. 价格验证:");
        if (!cinemaManager.getAllShows().isEmpty()) {
            Show testShow = cinemaManager.getAllShows().get(0);
            Seat[][] seats = testShow.getScreeningRoom().getSeatLayout();
            
            // 找到不同类型的座位
            Seat discountSeat = null, vipSeat = null, regularSeat = null;
            
            for (int row = 0; row < seats.length; row++) {
                for (int col = 0; col < seats[row].length; col++) {
                    Seat seat = seats[row][col];
                    if (seat instanceof DiscountSeat && discountSeat == null) {
                        discountSeat = seat;
                    } else if (seat instanceof VIPSeat && vipSeat == null) {
                        vipSeat = seat;
                    } else if (!(seat instanceof VIPSeat) && !(seat instanceof DiscountSeat) && regularSeat == null) {
                        regularSeat = seat;
                    }
                }
                if (discountSeat != null && vipSeat != null && regularSeat != null) {
                    break;
                }
            }
            
            if (discountSeat != null && vipSeat != null && regularSeat != null) {
                double discountPrice = bookingService.calculateSeatPrice(testShow, discountSeat);
                double vipPrice = bookingService.calculateSeatPrice(testShow, vipSeat);
                double regularPrice = bookingService.calculateSeatPrice(testShow, regularSeat);
                
                System.out.println("   优惠座位: ￥" + discountPrice);
                System.out.println("   普通座位: ￥" + regularPrice);
                System.out.println("   VIP座位: ￥" + vipPrice);
                System.out.println("   价格比例 - 优惠/普通: " + String.format("%.1f", discountPrice/regularPrice) + 
                                 " (期望: 0.8)");
                System.out.println("   价格比例 - VIP/普通: " + String.format("%.1f", vipPrice/regularPrice) + 
                                 " (期望: 2.0)");
            }
        }
        
        // 5. 订单验证
        System.out.println("\n5. 订单验证:");
        System.out.println("   总订单数: " + bookingService.getAllOrders().size());
    }
}

//File: BookingServiceTest.java
package com.cinema.service;

import com.cinema.exception.*;
import com.cinema.model.*;
import com.cinema.strategy.StandardPricing;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;

import java.time.LocalDateTime;
import java.util.List;

import static org.junit.jupiter.api.Assertions.*;

class BookingServiceTest {
    private BookingService bookingService;
    private CinemaManager cinemaManager;
    private User testUser;
    private Show testShow;

    @BeforeEach
    void setUp() {
        bookingService = BookingService.getInstance(new StandardPricing());
        cinemaManager = CinemaManager.getInstance();

        // 1. 创建带密码的用户
        testUser = new User("TEST-USER", "测试用户", "123456", "13800138000", "test@example.com");
        cinemaManager.addUser(testUser);

        Movie movie = new Movie(
                "TEST-MOVIE",
                "测试电影",
                java.time.LocalDate.of(2023, 1, 1),
                List.of("演员1"),
                "导演",
                120,
                8.0,
                "描述",
                "类型"
        );

        ScreeningRoom room = new ScreeningRoom("TEST-ROOM", "测试厅", 3, 5);
        cinemaManager.addScreeningRoom(room);

        testShow = new Show(
                "TEST-SHOW",
                movie,
                room,
                LocalDateTime.now().plusDays(1),
                50.0
        );

        cinemaManager.addMovie(movie);
        cinemaManager.addShow(testShow);
    }

    @Test
    void testCreateOrder() throws InvalidBookingException, SeatNotAvailableException {
        List<String> seatIds = List.of("1-1", "1-2");
        Order order = bookingService.createOrder(testUser, testShow, seatIds);

        assertNotNull(order);
        assertEquals(Order.OrderStatus.PENDING, order.getStatus());
        assertEquals(2, order.getSeatCount());
        assertEquals(testShow, order.getShow());
        assertTrue(testUser.getOrders().contains(order));
    }

    @Test
    void testCreateOrderWithInvalidSeat() {
        List<String> seatIds = List.of("10-10"); // Invalid seat
        assertThrows(Exception.class, () -> {
            bookingService.createOrder(testUser, testShow, seatIds);
        });
    }

    @Test
    void testProcessPayment() throws InvalidBookingException, SeatNotAvailableException, PaymentFailedException {
        List<String> seatIds = List.of("1-1");
        Order order = bookingService.createOrder(testUser, testShow, seatIds);

        // [修复点 1] 直接调用，不接收 boolean
        bookingService.processPayment(order);

        // 验证状态是否变成了 PAID
        assertEquals(Order.OrderStatus.PAID, order.getStatus());

        // Check seat is sold
        Seat seat = testShow.getSeat(1, 1);
        assertEquals(Seat.SeatStatus.SOLD, seat.getStatus());
    }

    @Test
    void testCancelPendingOrder() throws InvalidBookingException, SeatNotAvailableException {
        List<String> seatIds = List.of("1-1");
        Order order = bookingService.createOrder(testUser, testShow, seatIds);

        // [修复点 2] 直接调用，不接收 boolean
        bookingService.cancelOrder(order);

        // 验证状态是否变成了 CANCELLED
        assertEquals(Order.OrderStatus.CANCELLED, order.getStatus());

        // Check seat is unlocked
        Seat seat = testShow.getSeat(1, 1);
        assertEquals(Seat.SeatStatus.AVAILABLE, seat.getStatus());
    }

    @Test
    void testRefundPaidOrder() throws InvalidBookingException, SeatNotAvailableException, PaymentFailedException {
        List<String> seatIds = List.of("1-1");
        Order order = bookingService.createOrder(testUser, testShow, seatIds);
        bookingService.processPayment(order);

        // [修复点 3] 直接调用，不接收 boolean
        bookingService.cancelOrder(order);

        // 验证状态是否变成了 REFUNDED
        assertEquals(Order.OrderStatus.REFUNDED, order.getStatus());

        // Check seat is unlocked
        Seat seat = testShow.getSeat(1, 1);
        assertEquals(Seat.SeatStatus.AVAILABLE, seat.getStatus());
    }

    @Test
    void testCalculateSeatPrice() {
        Seat seat = testShow.getSeat(1, 1);
        double price = bookingService.calculateSeatPrice(testShow, seat);

        assertTrue(price > 0);
        assertEquals(testShow.getBasePrice(), price, 0.01);
    }

    @Test
    void testGetOrder() throws InvalidBookingException, SeatNotAvailableException {
        List<String> seatIds = List.of("1-1");
        Order order = bookingService.createOrder(testUser, testShow, seatIds);

        Order retrieved = bookingService.getOrder(order.getOrderId());
        assertNotNull(retrieved);
        assertEquals(order.getOrderId(), retrieved.getOrderId());
    }

    @Test
    void testGetAllOrders() throws InvalidBookingException, SeatNotAvailableException {
        List<String> seatIds = List.of("1-1");
        bookingService.createOrder(testUser, testShow, seatIds);

        List<Order> orders = bookingService.getAllOrders();
        assertNotNull(orders);
        assertFalse(orders.isEmpty());
    }
}

//File: CinemaManagerTest.java
package com.cinema.service;

import com.cinema.model.*;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;

import java.time.LocalDate;
import java.time.LocalDateTime;
import java.util.List;

import static org.junit.jupiter.api.Assertions.*;

class CinemaManagerTest {
    private CinemaManager cinemaManager;

    @BeforeEach
    void setUp() {
        cinemaManager = CinemaManager.getInstance();
    }

    @Test
    void testGetInstance() {
        CinemaManager instance1 = CinemaManager.getInstance();
        CinemaManager instance2 = CinemaManager.getInstance();
        assertSame(instance1, instance2, "CinemaManager should be singleton");
    }

    @Test
    void testAddAndGetMovie() {
        Movie movie = new Movie(
            "TEST-001",
            "测试电影",
            LocalDate.of(2023, 1, 1),
            List.of("演员1", "演员2"),
            "测试导演",
            120,
            8.0,
            "测试描述",
            "测试类型"
        );

        cinemaManager.addMovie(movie);
        Movie retrieved = cinemaManager.getMovie("TEST-001");

        assertNotNull(retrieved);
        assertEquals("测试电影", retrieved.getTitle());
        assertEquals("TEST-001", retrieved.getId());
    }

    @Test
    void testAddAndGetScreeningRoom() {
        ScreeningRoom room = new ScreeningRoom("TEST-ROOM", "测试厅", 5, 8);
        cinemaManager.addScreeningRoom(room);

        ScreeningRoom retrieved = cinemaManager.getScreeningRoom("TEST-ROOM");
        assertNotNull(retrieved);
        assertEquals("测试厅", retrieved.getName());
        assertEquals(5, retrieved.getTotalRows());
        assertEquals(8, retrieved.getTotalCols());
    }

    @Test
    void testAddAndGetShow() {
        Movie movie = new Movie(
            "TEST-002",
            "测试电影2",
            LocalDate.of(2023, 1, 1),
            List.of("演员1"),
            "导演",
            100,
            7.5,
            "描述",
            "类型"
        );

        ScreeningRoom room = new ScreeningRoom("TEST-ROOM-2", "测试厅2", 3, 5);
        cinemaManager.addScreeningRoom(room);

        Show show = new Show(
            "TEST-SHOW",
            movie,
            room,
            LocalDateTime.now().plusDays(1),
            50.0
        );

        cinemaManager.addMovie(movie);
        cinemaManager.addShow(show);

        Show retrieved = cinemaManager.getShow("TEST-SHOW");
        assertNotNull(retrieved);
        assertEquals(movie, retrieved.getMovie());
        assertEquals(room, retrieved.getScreeningRoom());
    }

    @Test
    void testSearchShows() {
        Movie movie = new Movie(
            "TEST-003",
            "搜索测试电影",
            LocalDate.of(2023, 1, 1),
            List.of("演员1"),
            "导演",
            100,
            7.5,
            "描述",
            "类型"
        );

        ScreeningRoom room = new ScreeningRoom("TEST-ROOM-3", "测试厅3", 3, 5);
        cinemaManager.addScreeningRoom(room);

        Show show = new Show(
            "TEST-SHOW-SEARCH",
            movie,
            room,
            LocalDateTime.now().plusDays(1),
            50.0
        );

        cinemaManager.addMovie(movie);
        cinemaManager.addShow(show);

        List<Show> results = cinemaManager.searchShows("搜索测试", null);
        assertFalse(results.isEmpty());
        assertTrue(results.stream().anyMatch(s -> s.getId().equals("TEST-SHOW-SEARCH")));
    }

    @Test
    void testRemoveMovie() {
        Movie movie = new Movie(
            "TEST-REMOVE",
            "待删除电影",
            LocalDate.of(2023, 1, 1),
            List.of("演员1"),
            "导演",
            100,
            7.5,
            "描述",
            "类型"
        );

        cinemaManager.addMovie(movie);
        assertNotNull(cinemaManager.getMovie("TEST-REMOVE"));

        cinemaManager.removeMovie("TEST-REMOVE");
        assertNull(cinemaManager.getMovie("TEST-REMOVE"));
    }

    @Test
    void testGetAllMovies() {
        List<Movie> movies = cinemaManager.getAllMovies();
        assertNotNull(movies);
        assertFalse(movies.isEmpty());
    }

    @Test
    void testGetAllScreeningRooms() {
        List<ScreeningRoom> rooms = cinemaManager.getAllScreeningRooms();
        assertNotNull(rooms);
        assertFalse(rooms.isEmpty());
    }

    @Test
    void testGetAllShows() {
        List<Show> shows = cinemaManager.getAllShows();
        assertNotNull(shows);
        assertFalse(shows.isEmpty());
    }
}

//File: SimpleTest.java
package com.cinema.service;

import com.cinema.model.*;
import java.time.LocalDate;
import java.time.LocalDateTime;
import java.util.List;

public class SimpleTest {
    public static void main(String[] args) {
        testCinemaManager();
        testBookingService();
        System.out.println("All tests completed successfully!");
    }

    public static void testCinemaManager() {
        System.out.println("Testing CinemaManager...");
        
        CinemaManager cinemaManager = CinemaManager.getInstance();
        
        // Test singleton
        CinemaManager instance2 = CinemaManager.getInstance();
        if (cinemaManager != instance2) {
            throw new RuntimeException("CinemaManager singleton test failed");
        }
        
        // Test adding movie
        Movie movie = new Movie(
            "TEST-001",
            "测试电影",
            LocalDate.of(2023, 1, 1),
            List.of("演员1", "演员2"),
            "测试导演",
            120,
            8.0,
            "测试描述",
            "测试类型"
        );

        cinemaManager.addMovie(movie);
        Movie retrieved = cinemaManager.getMovie("TEST-001");

        if (retrieved == null || !retrieved.getTitle().equals("测试电影")) {
            throw new RuntimeException("Movie retrieval test failed");
        }

        // Test adding screening room
        ScreeningRoom room = new ScreeningRoom("TEST-ROOM", "测试厅", 5, 8);
        cinemaManager.addScreeningRoom(room);

        ScreeningRoom retrievedRoom = cinemaManager.getScreeningRoom("TEST-ROOM");
        if (retrievedRoom == null || !retrievedRoom.getName().equals("测试厅")) {
            throw new RuntimeException("ScreeningRoom retrieval test failed");
        }

        System.out.println("CinemaManager tests passed!");
    }

    public static void testBookingService() {
        System.out.println("Testing BookingService...");
        
        CinemaManager cinemaManager = CinemaManager.getInstance();
        BookingService bookingService = BookingService.getInstance(new com.cinema.strategy.StandardPricing());
        
        // Create test user
        User testUser = new User("TEST-USER", "测试用户", "13800138000", "test@example.com");
        cinemaManager.addUser(testUser);

        // Create test show
        Movie movie = new Movie(
            "TEST-MOVIE",
            "测试电影",
            LocalDate.of(2023, 1, 1),
            List.of("演员1"),
            "导演",
            120,
            8.0,
            "描述",
            "类型"
        );

        ScreeningRoom room = new ScreeningRoom("TEST-ROOM-BOOKING", "测试厅2", 3, 5);
        cinemaManager.addScreeningRoom(room);

        Show testShow = new Show(
            "TEST-SHOW",
            movie,
            room,
            LocalDateTime.now().plusDays(1),
            50.0
        );

        cinemaManager.addMovie(movie);
        cinemaManager.addShow(testShow);

        // Test creating order
        List<String> seatIds = List.of("1-1", "1-2");
        Order order;
        try {
            order = bookingService.createOrder(testUser, testShow, seatIds);
            if (order == null || order.getStatus() != Order.OrderStatus.PENDING) {
                throw new RuntimeException("Order creation test failed");
            }
        } catch (Exception e) {
            throw new RuntimeException("Order creation test failed: " + e.getMessage());
        }

        if (order.getSeatCount() != 2) {
            throw new RuntimeException("Order seat count test failed");
        }

        // Test payment
        try {
            bookingService.processPayment(order);
            if (order.getStatus() != Order.OrderStatus.PAID) {
                throw new RuntimeException("Payment processing test failed");
            }
        } catch (Exception e) {
            throw new RuntimeException("Payment processing test failed: " + e.getMessage());
        }

        // Check seat is sold
        Seat seat = testShow.getSeat(1, 1);
        if (seat.getStatus() != Seat.SeatStatus.SOLD) {
            throw new RuntimeException("Seat status test failed");
        }

        System.out.println("BookingService tests passed!");
    }
}
